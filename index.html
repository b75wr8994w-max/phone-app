<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />

  <!-- PWAï¼šiOS åŠ å…¥ä¸»ç•«é¢å¾Œæ¥è¿‘åŸç”Ÿ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0f172a">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ›¡ï¸</text></svg>">

  <title>Project 2030ï¼šåŸ·è¡Œæ†²æ³•</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- å½©å¸¶ç‰¹æ•ˆ -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    html, body, #root { height: 100%; }
    body{
      margin:0;
      background:#0f172a;
      color:#f1f5f9;
      -webkit-tap-highlight-color:transparent;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      overflow:hidden; /* âœ… æ²å‹•åªåœ¨ content-scroll */
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* âœ… App Shell / Scroll container */
    .app-shell{ height:100%; }
    .content-scroll{
      height:100%;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      padding-top: env(safe-area-inset-top);
      padding-bottom: calc(var(--tabbar-h, 92px) + env(safe-area-inset-bottom)); /* âœ… é ç•™ tabbar + safe-area */
    }

    /* âœ… TabBarï¼šåªè£œå®‰å…¨å€ï¼Œä¸è¦æŠŠæŒ‰éˆ•é ‚ä¸Šå» */
    .pb-tabbar{ padding-bottom: env(safe-area-inset-bottom); }

    ::-webkit-scrollbar{ width:4px; }
    ::-webkit-scrollbar-track{ background:#1e293b; }
    ::-webkit-scrollbar-thumb{ background:#475569; border-radius:2px; }

    @keyframes pulse-green{
      0%{ box-shadow:0 0 0 0 rgba(16,185,129,.7); }
      70%{ box-shadow:0 0 0 10px rgba(16,185,129,0); }
      100%{ box-shadow:0 0 0 0 rgba(16,185,129,0); }
    }
    .animate-pulse-green{ animation:pulse-green 2s infinite; }

    @keyframes fade-in{
      from{ opacity:0; transform:translateY(8px); }
      to{ opacity:1; transform:translateY(0); }
    }
    .animate-fade-in{ animation:fade-in .3s cubic-bezier(.16,1,.3,1) both; }
  </style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
const { useEffect, useMemo, useRef, useState } = React;

/* âœ… é˜²é»‘å±ï¼šä»»ä½•éŒ¯èª¤è‡³å°‘é¡¯ç¤ºæç¤º */
window.onerror = function (msg, src, line, col) {
  try{
    const root = document.getElementById("root");
    if(root){
      root.innerHTML = `
        <div style="padding:16px;color:#fff;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;">
          <div style="font-size:18px;font-weight:800;margin-bottom:8px;">âš ï¸ App ç™¼ç”ŸéŒ¯èª¤ï¼ˆé¿å…é»‘å±ï¼‰</div>
          <div style="opacity:.9;margin-bottom:8px;">${String(msg)}</div>
          <div style="opacity:.7;font-size:12px;">${String(src)} : ${line}:${col}</div>
          <div style="margin-top:12px;opacity:.85;font-size:12px;">
            å¸¸è¦‹åŸå› ï¼šJSX è£¡æ”¾äº† <b>&lt;!-- --&gt;</b> è¨»è§£ï¼Œå¿…é ˆæ”¹æˆ <b>{/* ... */}</b>
          </div>
        </div>
      `;
    }
  }catch(e){}
  return false;
};

/* ===== Constants ===== */
const GOAL_BTC = 3.0;
const TARGET_DATE = new Date("2030-12-31T00:00:00+08:00").getTime();

const SAVE_KEY = "p2030_v4_master_save_final03";
const CACHE_KEY_METRICS = "p2030_v4_metrics_cache_final03";

const PART = 60;
const MONTH_PARTS = 3;

const GREED_WEEKS_FOR_INSURANCE = 8; // D å€é€£çºŒ 8 é€±å¾Œå•Ÿå‹•é•·ç‰›ä¿éšª
const BLACK_SWAN_WEEKS = 4;
const BLACK_SWAN_STOP_REBOUND = 15;

const ETH_SNIPE_RATIO = 0.058;
const ADA_SNIPE_RATIO = 0.0000085;

const ETH_ALERT_RATIO = 0.045;
const ADA_ALERT_RATIO = 0.000008;

/* ===== Helpers ===== */
const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
const parseNum = (s, fallback = NaN) => {
  const n = Number(String(s ?? "").replace(/,/g,"").trim());
  return Number.isFinite(n) ? n : fallback;
};
const fmt = (n, d=4) => Number(n||0).toFixed(d);
const monthKeyNow = () => {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
};
const todayMMDD = () => new Date().toLocaleDateString("zh-TW", { month:"2-digit", day:"2-digit" });
const reboundPctFrom = (low, now) => (low>0 && now>0) ? ((now-low)/low)*100 : 0;
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

const parseLooseJson = (text) => {
  const s = String(text || "");
  const i1 = s.indexOf("{");
  const i2 = s.indexOf("[");
  let i = -1;
  if (i1 === -1) i = i2;
  else if (i2 === -1) i = i1;
  else i = Math.min(i1, i2);
  if (i < 0) throw new Error("JSON not found");
  return JSON.parse(s.slice(i).trim());
};

const triggerConfetti = () => {
  if (typeof confetti !== "function") return;
  const count = 200;
  const defaults = { origin: { y: 0.7 } };
  const fire = (particleRatio, opts) => {
    confetti(Object.assign({}, defaults, opts, { particleCount: Math.floor(count * particleRatio) }));
  };
  fire(0.25, { spread: 26, startVelocity: 55 });
  fire(0.2, { spread: 60 });
  fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
  fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
  fire(0.1, { spread: 120, startVelocity: 45 });
};

/* ===== Initial State ===== */
const initialStateNow = () => ({
  btcHot: 0.0,
  btcCold: 0.0,
  usdtReserve: 0,

  eth: 34.0,
  ada: 74000.0,

  ethStaked: true,
  adaStaked: true,

  logs: [],
  consecutiveGreedWeeks: 0,

  monthPartsRemaining: MONTH_PARTS,
  lastMonthKey: monthKeyNow(),

  // æœ¬é€±é–ï¼šé¿å…ä¸€é€±æŒ‰å…©æ¬¡
  lastWeeklyExecISO: null,

  blackSwan: {
    active: false,
    remainingWeeks: 0,
    weeklyBudget: 0,
    startedAtISO: null,
    reason: null,
    anchorPrice: 0,
    lowPrice: 0,
    lastSpent: 0
  }
}); function App(){
  const [state, setState] = useState(initialStateNow());
  const [tab, setTab] = useState("home"); // home | convert | sop | system
  const [modal, setModal] = useState(null);
  const [showAdvanced, setShowAdvanced] = useState(false);
  const [privacyMode, setPrivacyMode] = useState(false);

  // iOS å‹å–„ï¼šuncontrolled inputs
  const draftRef = useRef({
    btcPrice: "90000",
    fngIndex: "50",
    ethBtcRatio: "0.050",
    adaBtcRatio: "0.000008",
    athDrawdownPct: "0",
    below200w: "0",
    reboundPct: "0",
    extraReserveAdd: "0"
  });

  const [ui, setUi] = useState({
    btcPrice: 90000,
    fngIndex: 50,
    ethBtcRatio: 0.050,
    adaBtcRatio: 0.000008,
    athDrawdownPct: 0,
    below200w: 0,
    reboundPct: 0,
    ma200w: 0,
    dataSource: "Manual"
  });

  const addLog = (msg, type="info") => {
    const log = { id: Date.now() + Math.random(), date: todayMMDD(), msg, type };
    setState(prev => ({ ...prev, logs: [log, ...prev.logs].slice(0, 260) }));
  };

  const updateInput = (name, val) => {
    draftRef.current[name] = String(val);
    const el = document.getElementById(name);
    if (el) el.value = String(val);
  };

  const commitUiNumber = (key, raw, fallback) => {
    let n = parseNum(raw, fallback);
    if (!Number.isFinite(n)) n = fallback;
    setUi(p => ({ ...p, [key]: n }));
    return n;
  };

  /* ===== Load / Migration ===== */
  useEffect(() => {
    try{
      const saved = localStorage.getItem(SAVE_KEY);
      if(saved){
        const parsed = JSON.parse(saved);
        const nowKey = monthKeyNow();
        if (parsed?.lastMonthKey && parsed.lastMonthKey !== nowKey){
          parsed.monthPartsRemaining = MONTH_PARTS;
          parsed.lastMonthKey = nowKey;
        }
        setState({ ...initialStateNow(), ...parsed });
        addLog("è®€å–æœ¬æ©Ÿå­˜æª”å®Œæˆã€‚", "system");
        return;
      }

      // å˜—è©¦ç¹¼æ‰¿èˆŠ key
      const legacyKeys = [
        "p2030_v4_master_save_final02",
        "p2030_v4_master_save_final01",
        "p2030_v4_master_save",
        "p2030_v3_store_fix02",
        "p2030_v3_store_fix01",
        "p2030_v3_store"
      ];
      let migrated = null;
      for (const k of legacyKeys){
        const v = localStorage.getItem(k);
        if(v){ migrated = JSON.parse(v); break; }
      }
      if(migrated){
        setState({ ...initialStateNow(), ...migrated });
        addLog("å·²å¾èˆŠç‰ˆæœ¬ç¹¼æ‰¿è³‡æ–™ã€‚", "system");
      }else{
        addLog("Project 2030 å•Ÿå‹•ã€‚ç›®æ¨™ï¼š3 BTC", "system");
      }
    }catch(e){
      console.error(e);
    }
    // eslint-disable-next-line
  }, []);

  useEffect(() => {
    try{ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }catch(e){}
  }, [state]);

  /* ===== Backup / Import / Reset ===== */
  const exportData = async () => {
    const payload = JSON.stringify({ schema:"p2030-backup-v1", exportedAtISO:new Date().toISOString(), state }, null, 2);
    try{
      await navigator.clipboard.writeText(payload);
      setModal({ title:"åŒ¯å‡ºæˆåŠŸ", body:"âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚\nè«‹è²¼åˆ°è¨˜äº‹æœ¬/é›²ç«¯ä¿å­˜ã€‚" });
    }catch(e){
      setModal({
        title:"è«‹æ‰‹å‹•è¤‡è£½",
        body: (
          <textarea readOnly className="w-full h-56 bg-black/40 border border-slate-700 rounded-xl p-3 text-xs mono text-slate-200">
            {payload}
          </textarea>
        )
      });
    }
  };

  const importData = () => {
    setModal({
      title:"é‚„åŸå‚™ä»½",
      body: (
        <div className="space-y-3">
          <div className="text-xs text-slate-400">è²¼ä¸Šä½ ä¹‹å‰åŒ¯å‡ºçš„å‚™ä»½ JSONï¼š</div>
          <textarea id="importBox" className="w-full h-56 bg-black/40 border border-slate-700 rounded-xl p-3 text-xs mono text-slate-200" placeholder="è²¼ä¸Š JSON..." />
          <button
            onClick={()=>{
              try{
                const el = document.getElementById("importBox");
                const obj = JSON.parse(el.value || "{}");
                const st = obj?.schema==="p2030-backup-v1" ? obj.state : obj;
                if(!(st && typeof st.btcHot === "number")) throw new Error("bad");
                setState({ ...initialStateNow(), ...st });
                addLog("å·²å¾å‚™ä»½é‚„åŸè³‡æ–™ã€‚", "success");
                setModal({ title:"é‚„åŸæˆåŠŸ", body:"âœ… å·²å¥—ç”¨å‚™ä»½è³‡æ–™ã€‚" });
              }catch(e){
                setModal({ title:"é‚„åŸå¤±æ•—", body:"âŒ JSON æ ¼å¼éŒ¯èª¤æˆ–ä¸æ˜¯æœ¬ App çš„å‚™ä»½ã€‚" });
              }
            }}
            className="w-full py-3 bg-sky-600 hover:bg-sky-500 rounded-xl text-white font-bold"
          >
            åŒ¯å…¥ä¸¦è¦†è“‹
          </button>
        </div>
      )
    });
  };

  const doHardReset = () => {
    try{
      localStorage.removeItem(SAVE_KEY);
      localStorage.removeItem(CACHE_KEY_METRICS);
    }catch(e){}
    const init = initialStateNow();
    init.logs = [{ id: Date.now(), date: todayMMDD(), msg:"å·²é‡ç½®ï¼šæ‰€æœ‰è³‡æ–™æ¸…ç©ºï¼Œå›åˆ°åˆå§‹ç‹€æ…‹ã€‚", type:"system" }];
    setState(init);
    setUi({
      btcPrice: 90000, fngIndex: 50,
      ethBtcRatio: 0.050, adaBtcRatio: 0.000008,
      athDrawdownPct: 0, below200w: 0, reboundPct: 0,
      ma200w: 0, dataSource:"Manual"
    });
    draftRef.current = {
      btcPrice:"90000", fngIndex:"50", ethBtcRatio:"0.050", adaBtcRatio:"0.000008",
      athDrawdownPct:"0", below200w:"0", reboundPct:"0", extraReserveAdd:"0"
    };
    setTimeout(() => {
      updateInput("btcPrice","90000");
      updateInput("fngIndex","50");
      updateInput("ethBtcRatio","0.050");
      updateInput("adaBtcRatio","0.000008");
      updateInput("athDrawdownPct","0");
      updateInput("below200w","0");
      updateInput("reboundPct","0");
      updateInput("extraReserveAdd","0");
    }, 0);
    setModal({ title:"å·²é‡ç½®", body:"âœ… æ‰€æœ‰è³‡æ–™å·²æ¸…ç©ºã€‚\nï¼ˆå»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½å†é‡ç½®ï¼‰" });
  };

  const resetAll = () => {
    setModal({
      title:"ç¢ºèªé‡ç½®",
      body: (
        <div className="space-y-3">
          <div className="text-sm text-slate-300">
            é€™æœƒæ¸…ç©ºï¼šæŒå€‰ã€é å‚™é‡‘ã€é»‘å¤©éµé€²åº¦ã€Logsã€é€±é–ã€‚<br/>
            <span className="text-yellow-300 font-bold">å»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ã€‚</span>
          </div>
          <button onClick={doHardReset} className="w-full py-3 bg-red-600 hover:bg-red-500 rounded-xl text-white font-bold">
            æˆ‘ç¢ºå®šè¦é‡ç½®
          </button>
        </div>
      )
    });
  };

  /* ===== Derived ===== */
  const totalBtc = useMemo(()=> (state.btcHot + state.btcCold), [state.btcHot, state.btcCold]);
  const progress = clamp((totalBtc / GOAL_BTC) * 100, 0, 100);
  const daysLeft = Math.max(0, Math.ceil((TARGET_DATE - Date.now()) / (1000*60*60*24)));

  const portfolioUsdApprox =
    (totalBtc * (ui.btcPrice||0)) +
    (state.eth * (ui.ethBtcRatio||0) * (ui.btcPrice||0)) +
    (state.ada * (ui.adaBtcRatio||0) * (ui.btcPrice||0)) +
    (state.usdtReserve||0);

  const stablePct = portfolioUsdApprox > 0 ? ((state.usdtReserve||0) / portfolioUsdApprox * 100) : 0;

  const isSameISOWeek = (isoA, isoB) => {
    if(!isoA || !isoB) return false;
    const weekKey = (d) => {
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = date.getUTCDay() || 7;
      date.setUTCDate(date.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((date - yearStart)/86400000) + 1)/7);
      return `${date.getUTCFullYear()}-W${weekNo}`;
    };
    return weekKey(new Date(isoA)) === weekKey(new Date(isoB));
  };
  const canExecuteThisWeek = !isSameISOWeek(state.lastWeeklyExecISO, new Date().toISOString());

  /* ===== API (prices + FNG) ===== */
  const fetchTextWithTimeout = async (url, ms) => {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), ms);
    try{
      const res = await fetch(url, { cache:"no-store", signal: ctrl.signal });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.text();
    }finally{
      clearTimeout(t);
    }
  };

  const fetchJsonSmart = async (url) => {
    try{ return parseLooseJson(await fetchTextWithTimeout(url, 9000)); }catch(e){}
    try{ return parseLooseJson(await fetchTextWithTimeout("https://api.allorigins.win/raw?url=" + encodeURIComponent(url), 12000)); }catch(e){}
    const j = "https://r.jina.ai/http://" + url.replace(/^https?:\/\//, "");
    return parseLooseJson(await fetchTextWithTimeout(j, 15000));
  };

  const withRetry = async (fn, tries=3) => {
    let last = null;
    for(let i=0;i<tries;i++){
      try{ return await fn(); }
      catch(e){ last = e; await sleep([600,1400,2600][i] ?? 2600); }
    }
    throw last;
  };

  const autofillFromApis = async () => {
    addLog("æ­£åœ¨é€£æ¥è¡›æ˜Ÿæ•¸æ“š...", "system");

    const cache = (() => { try { return JSON.parse(localStorage.getItem(CACHE_KEY_METRICS)); } catch { return null; } })();
    if(cache && (Date.now() - cache.ts) < 60_000){
      const { btc, fng, ethBtc, adaBtc, src } = cache;
      if(btc){ updateInput("btcPrice", Math.round(btc)); setUi(p=>({ ...p, btcPrice: btc })); }
      if(Number.isFinite(fng)){ updateInput("fngIndex", fng); setUi(p=>({ ...p, fngIndex: fng })); }
      if(ethBtc){ updateInput("ethBtcRatio", ethBtc.toFixed(5)); setUi(p=>({ ...p, ethBtcRatio: ethBtc })); }
      if(adaBtc){ updateInput("adaBtcRatio", adaBtc.toFixed(7)); setUi(p=>({ ...p, adaBtcRatio: adaBtc })); }
      setUi(p=>({ ...p, dataSource: src || "Cache" }));
      addLog("ä½¿ç”¨å¿«å–æ•¸æ“šï¼ˆ1åˆ†é˜å…§ï¼‰", "system");
      return;
    }

    try{
      const fngData = await withRetry(()=>fetchJsonSmart("https://api.alternative.me/fng/?limit=1&format=json"), 2);
      const fng = clamp(parseInt(fngData?.data?.[0]?.value ?? "50", 10), 0, 100);

      let btc=0, eth=0, ada=0, src="CC";
      try{
        const cc = await withRetry(()=>fetchJsonSmart("https://min-api.cryptocompare.com/data/pricemulti?fsyms=BTC,ETH,ADA&tsyms=USD"), 2);
        if(cc?.BTC?.USD){ btc = cc.BTC.USD; eth = cc.ETH.USD; ada = cc.ADA.USD; }
        else throw new Error("CC fail");
      }catch(e){
        src="CG";
        const cg = await withRetry(()=>fetchJsonSmart("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,cardano&vs_currencies=usd"), 2);
        btc = cg?.bitcoin?.usd ?? 0;
        eth = cg?.ethereum?.usd ?? 0;
        ada = cg?.cardano?.usd ?? 0;
      }
      if(!(btc>0)) throw new Error("No Price Data");

      const ethBtc = eth>0 ? (eth/btc) : 0;
      const adaBtc = ada>0 ? (ada/btc) : 0;

      updateInput("btcPrice", Math.round(btc));
      updateInput("fngIndex", fng);
      if(ethBtc>0) updateInput("ethBtcRatio", ethBtc.toFixed(5));
      if(adaBtc>0) updateInput("adaBtcRatio", adaBtc.toFixed(7));

      setUi(p=>({
        ...p,
        btcPrice: btc,
        fngIndex: fng,
        ethBtcRatio: ethBtc || p.ethBtcRatio,
        adaBtcRatio: adaBtc || p.adaBtcRatio,
        dataSource: src
      }));

      localStorage.setItem(CACHE_KEY_METRICS, JSON.stringify({ ts: Date.now(), btc, fng, ethBtc, adaBtc, src }));

      addLog(`æ•¸æ“šæ›´æ–°æˆåŠŸ (${src})`, "success");
      if(ethBtc >= ETH_ALERT_RATIO) addLog(`æé†’ï¼šETH/BTC â‰¥ ${ETH_ALERT_RATIO}ï¼ˆæº–å‚™ç‹™æ“Š ${ETH_SNIPE_RATIO}ï¼‰`, "alert");
      if(adaBtc >= ADA_ALERT_RATIO) addLog(`æé†’ï¼šADA/BTC â‰¥ ${ADA_ALERT_RATIO}ï¼ˆæº–å‚™ç‹™æ“Š ${ADA_SNIPE_RATIO}ï¼‰`, "alert");
    }catch(e){
      addLog("è‡ªå‹•æŠ“å–å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥", "warning");
    }
  };

  useEffect(() => { setTimeout(autofillFromApis, 120); }, []); // auto fetch once

  /* ===== Actions ===== */
  const addReserve = () => {
    const add = Math.max(0, Math.floor(parseNum(draftRef.current.extraReserveAdd, 0)));
    if(!(add>0)){
      setModal({ title:"éŒ¯èª¤", body:"è«‹è¼¸å…¥æ­£æ•´æ•¸" });
      return;
    }
    setState(p=>({ ...p, usdtReserve: (p.usdtReserve||0) + add }));
    addLog(`æ‰‹å‹•è£œå……é å‚™é‡‘ï¼š+${add} U`, "success");
    draftRef.current.extraReserveAdd = "0";
    updateInput("extraReserveAdd","0");
  };

  const moveCold = () => {
    if(state.btcHot < 0.05){
      setModal({ title:"æ‹’çµ•", body:"æœªé” 0.05 BTC é–€æª»" });
      return;
    }
    const amt = state.btcHot;
    setState(p=>({ ...p, btcCold: (p.btcCold||0) + amt, btcHot: 0 }));
    addLog(`æé ˜ ${fmt(amt,6)} BTC è‡³å†·éŒ¢åŒ…`, "secure");
    triggerConfetti();
    setModal({ title:"ğŸ‰ é˜²ç¦¦å¢å¼·", body:`æˆåŠŸæé ˜ ${fmt(amt,6)} BTC è‡³å†·éŒ¢åŒ…ï¼` });
  };

  const snipeConvert = (asset) => {
    const ratio = asset==="ETH" ? Number(ui.ethBtcRatio||0) : Number(ui.adaBtcRatio||0);
    const target = asset==="ETH" ? ETH_SNIPE_RATIO : ADA_SNIPE_RATIO;

    if(ratio < target){
      setModal({ title:"æœªé”é–€æª»", body:`${asset}/BTC éœ€ â‰¥ ${target}\nç›®å‰ï¼š${ratio}` });
      return;
    }
    const holding = asset==="ETH" ? state.eth : state.ada;
    if(!(holding>0)){
      setModal({ title:"è³‡ç”¢ä¸è¶³", body:`ç›®å‰ ${asset} ç‚º 0` });
      return;
    }

    const got = prompt(`ç‹™æ“ŠæˆåŠŸï¼š${asset} å…¨æ› BTC\nè«‹è¼¸å…¥å¯¦éš›ç²å¾— BTC æ•¸é‡ï¼š`);
    if(!got) return;
    const btc = parseNum(got, NaN);
    if(!(btc>0)){
      setModal({ title:"è¼¸å…¥éŒ¯èª¤", body:"æ•¸å€¼ç„¡æ•ˆ" });
      return;
    }

    setState(p=>({
      ...p,
      btcHot: (p.btcHot||0) + btc,
      eth: asset==="ETH" ? 0 : p.eth,
      ada: asset==="ADA" ? 0 : p.ada
    }));
    addLog(`ç‹™æ“ŠæˆåŠŸï¼š${asset} â†’ ${btc.toFixed(6)} BTC`, "success");
    triggerConfetti();
    setModal({ title:"ğŸ‰ ä»»å‹™å®Œæˆ", body:`å·²å°‡ ${asset} è½‰æ›ç‚º ${btc.toFixed(6)} BTC` });
  };

  const executeWeekly = () => {
    if(!canExecuteThisWeek){
      setModal({ title:"æœ¬é€±å·²åŸ·è¡Œ", body:"å·²é–å®šï¼šæœ¬é€±ä½ å·²æŒ‰éä¸€æ¬¡åŸ·è¡Œã€‚\nï¼ˆé¿å…èª¤æ‰£é»‘å¤©éµé€±æ•¸ï¼‰" });
      return;
    }

    const price = parseNum(ui.btcPrice, 0);
    const fng = clamp(parseNum(ui.fngIndex, 50), 0, 100);
    if(!(price>0)){
      setModal({ title:"éŒ¯èª¤", body:"è«‹è¼¸å…¥æœ‰æ•ˆçš„ BTC åƒ¹æ ¼" });
      return;
    }

    // æ›æœˆï¼šè£œ 3 ä»½
    const nowKey = monthKeyNow();
    let monthParts = state.monthPartsRemaining;
    let lastMonthKey = state.lastMonthKey;
    let monthRefilled = false;
    if(lastMonthKey !== nowKey){
      monthParts = MONTH_PARTS;
      lastMonthKey = nowKey;
      monthRefilled = true;
    }

    // A/B/C/D + é•·ç‰›ä¿éšª
    let greed = state.consecutiveGreedWeeks;
    let spend=0, save=0, action="";
    let bucket = "";
    if(fng < 20){ bucket="A"; greed=0; }
    else if(fng <= 40){ bucket="B"; greed=0; }
    else if(fng <= 75){ bucket="C"; greed=0; }
    else { bucket="D"; greed = greed + 1; }

    if(monthParts <= 0){
      action = "æœ¬æœˆä»½é¡å·²ç”¨å®Œï¼ˆ0/3ï¼‰ï½œæœ¬æ¬¡ä¸æ–°å¢æœˆè–ªè³‡é‡‘";
      spend=0; save=0;
    }else{
      if(bucket==="A"){ action="A æ¥µåº¦ææ…Œï¼š3è²·0å­˜"; spend=3; save=0; }
      if(bucket==="B"){ action="B ææ‡¼ï¼š2è²·1å­˜"; spend=2; save=1; }
      if(bucket==="C"){ action="C ä¸­æ€§/åè²ªï¼š1è²·2å­˜"; spend=1; save=2; }
      if(bucket==="D"){
        if(greed > GREED_WEEKS_FOR_INSURANCE){
          action=`D è²ªå©ªã€é•·ç‰›ä¿éšªã€‘ï¼š1è²·2å­˜ï¼ˆå·²é€£çºŒ ${greed} é€±>75ï¼‰`;
          spend=1; save=2;
        }else{
          action=`D è²ªå©ªï¼š0è²·3å­˜ï¼ˆé€£çºŒ ${greed} é€±>75ï¼‰`;
          spend=0; save=3;
        }
      }

      // ä»½é¡ä¸è¶³æ™‚ç¸®æ¸›
      const need = spend + save;
      if(need > monthParts){
        const sp = Math.min(spend, monthParts);
        const left = monthParts - sp;
        const sv = Math.min(save, left);
        spend = sp; save = sv;
        action += `ï¼ˆä»½é¡ä¸è¶³ï¼šè²·${sp}å­˜${sv}ï¼‰`;
      }
    }

    const usdtSpent = spend * PART;
    const usdtSaved = save * PART;

    // é»‘å¤©éµè§¸ç™¼ï¼ˆç”¨æ‰‹å‹•æ¬„ä½ï¼‰
    const athDD = clamp(parseNum(ui.athDrawdownPct, 0), 0, 100);
    const below200w = Number(ui.below200w||0) === 1;
    const blackTriggered = (fng < 20) || (athDD >= 30) || below200w;

    let blackSwan = { ...state.blackSwan, lastSpent: 0 };
    let reserveAfterSave = (state.usdtReserve||0) + usdtSaved;
    let blackSpent = 0;

    // é»‘å¤©éµåœæ­¢è¦å‰‡ï¼šåå½ˆ >15%
    if(blackSwan.active){
      const prevLow = blackSwan.lowPrice > 0 ? blackSwan.lowPrice : price;
      const newLow = Math.min(prevLow, price);
      const rb = reboundPctFrom(newLow, price);
      blackSwan.lowPrice = newLow;
      setUi(p=>({ ...p, reboundPct: Number(rb.toFixed(2)) }));
      updateInput("reboundPct", rb.toFixed(2));
      if(rb > BLACK_SWAN_STOP_REBOUND){
        blackSwan.active = false;
        blackSwan.remainingWeeks = 0;
        addLog(`é»‘å¤©éµåœæ­¢ï¼šåå½ˆ ${rb.toFixed(2)}% > ${BLACK_SWAN_STOP_REBOUND}%`, "warning");
      }
    }

    // å•Ÿå‹•é»‘å¤©éµï¼šæŠŠã€Œç•¶ä¸‹é å‚™é‡‘ã€åˆ† 4 é€±
    if(!blackSwan.active && blackTriggered && reserveAfterSave > 0){
      const reason = (fng < 20) ? "FNG<20" : (athDD >= 30 ? "6Må›æ’¤>=30%" : "è·Œç ´200W");
      blackSwan = {
        ...blackSwan,
        active: true,
        remainingWeeks: BLACK_SWAN_WEEKS,
        weeklyBudget: reserveAfterSave / BLACK_SWAN_WEEKS,
        startedAtISO: new Date().toISOString(),
        reason,
        anchorPrice: price,
        lowPrice: price,
        lastSpent: 0
      };
      addLog(`é»‘å¤©éµå•Ÿå‹•ï¼š${reason}ï½œé å‚™é‡‘åˆ†4é€±è²·å…¥`, "alert");
    }

    // é»‘å¤©éµæœ¬é€±æ‰£æ¬¾
    if(blackSwan.active && blackSwan.remainingWeeks > 0){
      const spendNow = Math.max(0, Math.min(reserveAfterSave, blackSwan.weeklyBudget));
      if(spendNow > 0){
        blackSpent = spendNow;
        blackSwan.lastSpent = spendNow;
        reserveAfterSave -= spendNow;
        blackSwan.remainingWeeks -= 1;
        addLog(`é»‘å¤©éµè²·å…¥ï¼š${Math.floor(spendNow)}Uï¼ˆå‰© ${blackSwan.remainingWeeks} é€±ï¼‰`, "success");
      }
      if(blackSwan.remainingWeeks <= 0){
        blackSwan.active = false;
        addLog("é»‘å¤©éµçµæŸï¼š4é€±è²·å…¥å®Œæˆ", "system");
      }
    }

    // è²·å…¥ BTCï¼ˆDCA + é»‘å¤©éµï¼‰
    const totalSpent = usdtSpent + blackSpent;
    const btcBought = totalSpent > 0 ? (totalSpent / price) : 0;

    const usedParts = spend + save;
    const newMonthParts = Math.max(0, monthParts - usedParts);

    setState(prev => ({
      ...prev,
      btcHot: (prev.btcHot||0) + btcBought,
      usdtReserve: reserveAfterSave,
      consecutiveGreedWeeks: greed,
      monthPartsRemaining: newMonthParts,
      lastMonthKey,
      blackSwan,
      lastWeeklyExecISO: new Date().toISOString()
    }));

    if(monthRefilled) addLog("æœˆä»½æ›´æ–°ï¼šè£œå……æœ¬æœˆä»½é¡ 3/3ï¼ˆ180Uï¼‰", "system");
    addLog(`é€±å ±ï¼š${action}`, usdtSpent>0 ? "success" : "warning");
    if(usdtSaved>0) addLog(`å­˜å…¥é å‚™é‡‘ï¼š+${usdtSaved}U`, "info");
    if(totalSpent>0) addLog(`æœ¬é€±æŠ•å…¥ï¼š${Math.floor(totalSpent)}U â†’ ${btcBought.toFixed(6)} BTC`, "success");

    setModal({
      title:"åŸ·è¡Œå ±å‘Š",
      body: (
        <div className="space-y-2">
          <div className="text-emerald-300 font-bold">{action}</div>
          <div className="grid grid-cols-2 gap-2 text-sm text-slate-300">
            <span>æŠ•å…¥: ${Math.floor(usdtSpent)}</span>
            <span>å­˜å…¥: ${Math.floor(usdtSaved)}</span>
            <span>é»‘å¤©éµ: ${Math.floor(blackSpent)}</span>
            <span>å‰©ä»½é¡: {newMonthParts}/3</span>
            <span className="col-span-2 text-white font-bold text-lg mt-2">è²·å…¥: {btcBought.toFixed(6)} BTC</span>
          </div>
        </div>
      )
    });
  };

  /* ===== UI Components ===== */
  const Card = ({children, className=""}) => (
    <div className={`bg-slate-800 border border-slate-700/50 rounded-2xl p-5 shadow-lg ${className}`}>{children}</div>
  );

  const Battery = ({level}) => (
    <div className="flex gap-1">
      {[1,2,3].map(i => (
        <div key={i} className={`h-2.5 w-5 rounded-sm border border-slate-600 ${i <= level ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]' : 'bg-slate-800'}`} />
      ))}
    </div>
  );

  const TabBtn = ({id, label, icon}) => (
    <button
      onClick={() => setTab(id)}
      className={`flex-1 rounded-xl py-2 text-xs font-bold transition-all flex flex-col items-center justify-center gap-1
        ${tab === id ? "bg-slate-800 text-emerald-300 border border-slate-700" : "text-slate-400 hover:bg-slate-800/60"}`}
    >
      <span className="text-base">{icon}</span>
      <span className="text-[11px]">{label}</span>
    </button>
  );

  const InputField = ({id, label, defaultVal, onCommit}) => (
    <div className="space-y-1">
      <label className="text-xs text-slate-400 ml-1">{label}</label>
      <input
        id={id}
        type="text"
        inputMode="decimal"
        defaultValue={defaultVal}
        onInput={(e)=>{ draftRef.current[id] = e.target.value; }}
        onBlur={(e)=> onCommit(e.target.value)}
        className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-lg font-mono focus:outline-none focus:border-emerald-500 transition-colors"
        autoCorrect="off" autoCapitalize="off" spellCheck={false}
      />
    </div>
  );

  const renderModalBody = () => {
    if(!modal) return null;
    if(typeof modal.body === "string"){
      return <div className="text-slate-300 mb-6 whitespace-pre-wrap">{modal.body}</div>;
    }
    return <div className="text-slate-300 mb-6">{modal.body}</div>;
  };

  return (
    <div className="app-shell select-none" style={{"--tabbar-h":"92px"}}>
      <div className="content-scroll">
        {/* Header */}
        <div className="sticky top-0 z-20 bg-slate-900/90 backdrop-blur border-b border-slate-800 px-5 py-4 shadow-2xl">
          <div className="flex justify-between items-end mb-3">
            <div onClick={()=>setPrivacyMode(!privacyMode)} className="cursor-pointer">
              <div className="text-[10px] text-slate-500 tracking-widest uppercase mb-1">
                Project 2030 {privacyMode ? "ğŸ™ˆ" : ""}
              </div>
              <div className="text-2xl font-black font-mono tracking-tight text-white flex items-center gap-2">
                {privacyMode ? "****" : fmt(totalBtc)} <span className="text-sm text-slate-500 font-normal">/ {GOAL_BTC}</span>
              </div>
              <div className="text-[10px] text-slate-500 mt-1">é»æ“Šé‡‘é¡åˆ‡æ›éš±ç§æ¨¡å¼</div>
            </div>
            <div className="text-right">
              <div className="text-[10px] text-slate-500 mb-1">å€’æ•¸</div>
              <div className="text-sm font-bold text-emerald-400 font-mono">{daysLeft} D</div>
              <div className={`text-[10px] mt-1 ${stablePct>30 ? "text-yellow-300" : "text-slate-500"}`}>
                ç©©å®šå¹£å æ¯”â‰ˆ{stablePct.toFixed(1)}%
              </div>
            </div>
          </div>
          <div className="h-1.5 bg-slate-800 rounded-full overflow-hidden">
            <div className="h-full bg-gradient-to-r from-emerald-600 to-green-400 transition-all duration-1000" style={{width: `${progress}%`}} />
          </div>
        </div>

        {/* Main */}
        <div className="p-4 space-y-4 max-w-lg mx-auto">
          {/* Assets */}
          <div className="grid grid-cols-2 gap-3">
            <Card className="relative overflow-hidden">
              <div className="text-xs text-slate-400">ç†±éŒ¢åŒ… (Hot)</div>
              <div className="text-xl font-mono font-bold text-emerald-300 my-1">{privacyMode ? "****" : fmt(state.btcHot)}</div>
              <button
                onClick={moveCold}
                disabled={!(state.btcHot >= 0.05)}
                className={`w-full text-xs rounded py-2 font-bold border transition-all
                  ${state.btcHot >= 0.05
                    ? "bg-emerald-900/50 text-emerald-300 border-emerald-800 animate-pulse"
                    : "bg-slate-900 text-slate-600 border-slate-700 opacity-50"}`}
              >
                {state.btcHot >= 0.05 ? "æé ˜è‡³å†·éŒ¢åŒ… â”" : "æœªé” 0.05 é–€æª»"}
              </button>
            </Card>

            <Card>
              <div className="text-xs text-slate-400">å†·éŒ¢åŒ… (Cold)</div>
              <div className="text-xl font-mono font-bold text-blue-300 my-1">{privacyMode ? "****" : fmt(state.btcCold)}</div>
              <div className="text-[10px] text-slate-500 mt-2">çµ•å°é˜²ç¦¦é ˜åŸŸ</div>
            </Card>
          </div>

          {/* Reserve + Black Swan progress */}
          <Card className="bg-gradient-to-r from-slate-800 to-slate-800/80">
            <div className="flex justify-between items-start">
              <div>
                <div className="text-xs text-yellow-500/80 mb-1">é å‚™é‡‘ (USDT)</div>
                <div className="text-2xl font-mono font-bold text-yellow-400">
                  {privacyMode ? "****" : Math.floor(state.usdtReserve).toLocaleString()}
                </div>
                <div className="mt-3 flex gap-2">
                  <input
                    id="extraReserveAdd"
                    defaultValue="0"
                    type="number"
                    onInput={(e)=>draftRef.current.extraReserveAdd = e.target.value}
                    className="w-24 bg-slate-900 text-xs p-2 rounded border border-slate-700"
                  />
                  <button onClick={addReserve} className="text-xs bg-slate-700 px-3 rounded font-bold">
                    ï¼‹é å‚™é‡‘
                  </button>
                </div>
              </div>
              <div className="text-right">
                <div className="text-[10px] text-slate-500 mb-1">æœ¬æœˆä»½é¡</div>
                <div className="inline-block"><Battery level={state.monthPartsRemaining} /></div>
                <div className="text-[10px] text-slate-600 mt-2">{ui.dataSource}</div>
              </div>
            </div>

            <div className="mt-4 bg-slate-900/60 border border-slate-700/50 rounded-xl p-3">
              <div className="flex justify-between text-xs text-slate-400">
                <span>é»‘å¤©éµç‹€æ…‹</span>
                <span className={state.blackSwan.active ? "text-red-300 font-bold" : "text-slate-400"}>
                  {state.blackSwan.active ? "ACTIVE" : "IDLE"}
                </span>
              </div>
              <div className="mt-2 text-xs text-slate-300">
                {state.blackSwan.active
                  ? `åŸå› ï¼š${state.blackSwan.reason}ï½œå‰©é¤˜é€±æ•¸ï¼š${state.blackSwan.remainingWeeks}/${BLACK_SWAN_WEEKS}ï½œæœ¬é€±æ‰£ï¼š${Math.floor(state.blackSwan.lastSpent||0)}U`
                  : "æœªå•Ÿå‹•ã€‚"}
              </div>
              {state.blackSwan.active && (
                <div className="mt-2 w-full h-2 bg-slate-800 rounded-full overflow-hidden">
                  <div className="h-full bg-red-500/70" style={{width: `${((BLACK_SWAN_WEEKS - state.blackSwan.remainingWeeks)/BLACK_SWAN_WEEKS)*100}%`}} />
                </div>
              )}
            </div>
          </Card>

          {/* HOME */}
          {tab === "home" && (
            <div className="space-y-4 animate-fade-in">
              <Card>
                <div className="flex justify-between items-center mb-4">
                  <h3 className="font-bold text-white flex items-center gap-2">
                    <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse-green"></span>
                    æ¯é€±æ±ºç­–
                  </h3>
                  <button
                    onClick={autofillFromApis}
                    className="text-xs bg-slate-700 px-3 py-1.5 rounded-lg text-slate-300 active:scale-95 transition-transform"
                  >
                    ğŸ“¡ æ›´æ–°
                  </button>
                </div>

                <div className="grid grid-cols-2 gap-4 mb-4">
                  <InputField
                    id="btcPrice"
                    label="BTC åƒ¹æ ¼"
                    defaultVal={draftRef.current.btcPrice}
                    onCommit={(v)=>{ updateInput("btcPrice", v); commitUiNumber("btcPrice", v, ui.btcPrice); }}
                  />
                  <InputField
                    id="fngIndex"
                    label="æè²ªæŒ‡æ•¸"
                    defaultVal={draftRef.current.fngIndex}
                    onCommit={(v)=>{
                      const n = clamp(Math.round(parseNum(v, ui.fngIndex)), 0, 100);
                      updateInput("fngIndex", n);
                      setUi(p=>({ ...p, fngIndex: n }));
                    }}
                  />
                </div>

                <div className="bg-slate-900/50 rounded-xl p-3 mb-4 border border-slate-700/50">
                  <div className="flex justify-between text-xs text-slate-400 mb-2">
                    <span>æè²ª</span>
                    <span className={
                      ui.fngIndex < 20 ? "text-red-400" :
                      ui.fngIndex <= 40 ? "text-yellow-400" :
                      ui.fngIndex <= 75 ? "text-slate-300" : "text-emerald-400"
                    }>
                      {ui.fngIndex} / 100
                    </span>
                  </div>
                  <input
                    type="range" min="0" max="100" value={ui.fngIndex}
                    onChange={(e)=>{
                      const n = clamp(parseInt(e.target.value,10)||0, 0, 100);
                      setUi(p=>({ ...p, fngIndex: n }));
                      updateInput("fngIndex", n);
                    }}
                    className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                  />
                </div>

                <button
                  onClick={()=>setShowAdvanced(!showAdvanced)}
                  className="w-full mb-3 text-xs text-slate-500 py-2 border border-dashed border-slate-700 rounded-lg"
                >
                  {showAdvanced ? "æ”¶èµ·é€²éšè¨­å®š" : "é€²éšè¨­å®šï¼ˆæ‰‹å‹•å›æ’¤/200Wï¼‰"}
                </button>

                {showAdvanced && (
                  <div className="grid grid-cols-2 gap-3 mb-4 animate-fade-in">
                    <InputField
                      id="athDrawdownPct"
                      label="6M å›æ’¤%ï¼ˆæ‰‹å‹•ï¼‰"
                      defaultVal={draftRef.current.athDrawdownPct}
                      onCommit={(v)=>{ updateInput("athDrawdownPct", v); commitUiNumber("athDrawdownPct", v, ui.athDrawdownPct); }}
                    />
                    <button
                      onClick={()=>{
                        const next = Number(ui.below200w||0)===1 ? 0 : 1;
                        setUi(p=>({ ...p, below200w: next }));
                        updateInput("below200w", next);
                        addLog(`æ‰‹å‹•è¨­å®šï¼šè·Œç ´200W=${next ? "ON":"OFF"}`, "system");
                      }}
                      className={`text-xs rounded border px-3 py-2 ${Number(ui.below200w)===1 ? "bg-red-900 border-red-500 text-red-300" : "bg-slate-900 border-slate-700 text-slate-500"}`}
                    >
                      è·Œç ´200W: {Number(ui.below200w)===1 ? "ON":"OFF"}
                    </button>
                  </div>
                )}

                <button
                  onClick={executeWeekly}
                  className={`w-full py-4 text-white font-bold rounded-xl shadow-lg transition-all
                    ${canExecuteThisWeek ? "bg-emerald-600 hover:bg-emerald-500" : "bg-slate-700 text-slate-500 opacity-70"}`}
                >
                  {canExecuteThisWeek ? "åŸ·è¡Œæœ¬é€±æ±ºç­–" : "æœ¬é€±å·²åŸ·è¡Œï¼ˆé–å®šï¼‰"}
                </button>
              </Card>

              <div className="px-2">
                <div className="text-[10px] text-slate-500 mb-2 font-mono uppercase">System Logs</div>
                <div className="space-y-1.5 font-mono text-xs max-h-32 overflow-y-auto pr-2">
                  {state.logs.length === 0 && <div className="text-slate-700">System Ready...</div>}
                  {state.logs.map(log => (
                    <div
                      key={log.id}
                      className={
                        log.type === "alert" ? "text-red-400" :
                        log.type === "success" ? "text-emerald-400" :
                        log.type === "secure" ? "text-blue-400" :
                        log.type === "warning" ? "text-yellow-300" : "text-slate-400"
                      }
                    >
                      <span className="opacity-40">[{log.date.slice(5)}]</span> {log.msg}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* CONVERT */}
          {tab === "convert" && (
            <div className="space-y-4 animate-fade-in">
              <Card className="border-l-4 border-l-fuchsia-500">
                <h3 className="font-bold text-fuchsia-400 mb-2">ETH ç‹™æ“Šæ‰‹</h3>
                <div className="text-xs text-slate-400 mb-2">
                  åŒ¯ç‡ <span className="text-white mono">{Number(ui.ethBtcRatio||0).toFixed(5)}</span> / ç›®æ¨™ <span className="text-fuchsia-300 mono">{ETH_SNIPE_RATIO}</span>
                </div>
                <button onClick={()=>snipeConvert("ETH")} className="w-full py-3 rounded-xl font-bold bg-fuchsia-600 hover:bg-fuchsia-500">
                  ç‹™æ“ŠæˆåŠŸï¼ˆè¼¸å…¥å¯¦å¾—BTCï¼‰
                </button>
              </Card>

              <Card className="border-l-4 border-l-blue-500">
                <h3 className="font-bold text-blue-400 mb-2">ADA ç‹™æ“Šæ‰‹</h3>
                <div className="text-xs text-slate-400 mb-2">
                  åŒ¯ç‡ <span className="text-white mono">{Number(ui.adaBtcRatio||0).toFixed(7)}</span> / ç›®æ¨™ <span className="text-blue-300 mono">{ADA_SNIPE_RATIO}</span>
                </div>
                <button onClick={()=>snipeConvert("ADA")} className="w-full py-3 rounded-xl font-bold bg-blue-600 hover:bg-blue-500">
                  ç‹™æ“ŠæˆåŠŸï¼ˆè¼¸å…¥å¯¦å¾—BTCï¼‰
                </button>
              </Card>
            </div>
          )}

          {/* SOPï¼ˆå®Œæ•´æ†²æ³•ï¼‰ */}
          {tab === "sop" && (
            <div className="space-y-4 animate-fade-in text-sm text-slate-300 leading-relaxed">
              <Card>
                <h3 className="font-bold text-yellow-300 mb-2">ğŸ›¡ï¸ 2030 ç´¯ç© 3 BTCã€Šçµ‚æ¥µé˜²ç¦¦ãƒ»åŸ·è¡Œæ†²æ³•ã€‹</h3>
                <div className="text-xs text-slate-400">åŸ·è¡ŒæœŸé–“ï¼š2026.01 - 2030.12ï½œåŸ·è¡Œäººï¼š[é™³ç¥¥è±ª]</div>
              </Card>

              <Card>
                <h3 className="font-bold text-yellow-300 mb-2">æ ¸å¿ƒä¿¡æ¢</h3>
                <ul className="list-disc pl-4 space-y-1">
                  <li>æˆ‘çš„ç›®æ¨™æ˜¯ BTC é¡†æ•¸ï¼Œä¸æ˜¯æ³•å¹£æ•¸å­—ã€‚</li>
                  <li>æˆ‘ä¸é æ¸¬å¸‚å ´ï¼Œæˆ‘åªåŸ·è¡Œè¦å‰‡ã€‚</li>
                  <li>åªè¦æ´»è‘—ï¼ˆä¸çˆ†å€‰ã€ä¸äº‚å‹•ï¼‰ï¼Œæ™‚é–“æœƒå¸¶æˆ‘åˆ°çµ‚é»ã€‚</li>
                </ul>
              </Card>

              <Card>
                <h3 className="font-bold text-emerald-300 mb-2">âš”ï¸ ç¬¬ä¸€ç« ï¼šå®šæŠ•é€²æ”»æ¨¡çµ„ (æœˆè–ª DCA)</h3>
                <div className="text-xs bg-slate-900 border border-slate-700 rounded-xl p-3 space-y-2">
                  <div>ğŸ’° è³‡é‡‘ï¼šæ¯æœˆ 180 USDTï¼ˆ3 ä»½ï¼Œæ¯ä»½ 60 Uï¼‰</div>
                  <div>â° ç¯€å¥ï¼šæ¯é€±æŸ¥çœ‹ä¸€æ¬¡ã€Œææ‡¼èˆ‡è²ªå©ªæŒ‡æ•¸ã€</div>

                  <div className="mt-2 grid grid-cols-4 gap-2 text-[11px]">
                    <div className="text-slate-400">å€é–“</div>
                    <div className="text-slate-400">æ•¸å€¼</div>
                    <div className="text-slate-400">å‹•ä½œ</div>
                    <div className="text-slate-400">è³‡é‡‘æµå‘</div>

                    <div>A</div><div>&lt; 20</div><div>ğŸ”¥ å…¨è²·</div><div>3 è²· + é»‘å¤©éµ</div>
                    <div>B</div><div>20 - 40</div><div>ğŸŸ¢ åŠ ç¢¼</div><div>2 è²· / 1 å­˜</div>
                    <div>C</div><div>40 - 75</div><div>ğŸŸ¡ ä¿å®ˆ</div><div>1 è²· / 2 å­˜</div>
                    <div>D</div><div>&gt; 75</div><div>ğŸ”´ åœè²·</div><div>0 è²· / 3 å­˜</div>
                  </div>

                  <div className="mt-2 text-yellow-300 font-bold">
                    âš ï¸ å¼·åˆ¶æ¢æ¬¾ï¼šé•·ç‰›ä¿éšªï¼ˆæè²ª&gt;75 é€£çºŒ 2 å€‹æœˆ â†’ ç¬¬ 3 å€‹æœˆèµ·å¼·åˆ¶ 1 ä»½è²·å…¥ï¼‰
                  </div>
                  <div className="text-[11px] text-slate-300">
                    æœ¬ App ä»¥ã€Œé€£çºŒ 8 é€± &gt; 75ã€è¿‘ä¼¼ 2 å€‹æœˆï¼ˆä½ æ¯é€±æŒ‰ä¸€æ¬¡ï¼‰ã€‚
                  </div>
                </div>
              </Card>

              <Card>
                <h3 className="font-bold text-fuchsia-300 mb-2">ğŸ”„ ç¬¬äºŒç« ï¼šç‹™æ“Šæ‰‹è½‰æ›æ¨¡çµ„ (ETH/ADA â” BTC)</h3>
                <ul className="list-disc pl-4 space-y-2 text-xs">
                  <li><b>æ ¸å¿ƒåŸå‰‡ï¼š</b>æ”¾æ£„æœ€é«˜é»ï¼Œè¿½æ±‚é«˜å‹ç‡ã€‚ä¸æ› USDTï¼Œç›´æ¥æ› BTC é–å®šæˆ°æœã€‚</li>
                  <li><b>æ™‚é–“ç­–ç•¥ï¼š</b>ç„¡é™æœŸç­‰å¾…ã€‚ä¸åˆ°ç›®æ¨™åƒ¹çµ•ä¸é›¢å ´ï¼Œåªé è³ªæŠ¼åˆ©æ¯å°æŠ—æ™‚é–“ã€‚</li>
                </ul>

                <div className="mt-3 text-xs bg-slate-900 border border-slate-700 rounded-xl p-3 space-y-2">
                  <div className="font-bold text-slate-200">1ï¸âƒ£ ETH ç­–ç•¥ï¼ˆç¾æœ‰ 34 é¡†ï¼‰</div>
                  <div>ETH/BTC = <b>0.058</b> âœ ç›´æ¥æ› BTCï¼ˆç´„å¯æ› 1.97 é¡†ï¼‰</div>
                  <div className="text-slate-300">
                    ğŸš€ è£œå¼·æ¢æ¬¾ï¼šç­‰å¾…æœŸé–“å¿…é ˆå…¨å€‰è³ªæŠ¼ï¼ˆStakingï¼‰ï¼Œç”¨åˆ©æ¯è£œè¶³ 0.058~0.06 çš„ç¼ºå£ã€‚
                  </div>

                  <div className="mt-2 font-bold text-slate-200">2ï¸âƒ£ ADA ç­–ç•¥ï¼ˆç¾æœ‰ 74,000 é¡†ï¼‰</div>
                  <div>ADA/BTC = <b>0.0000085</b> âœ ç›´æ¥æ› BTCï¼ˆç´„å¯æ› 0.62 é¡†ï¼‰</div>
                  <div className="text-slate-300">
                    ğŸš€ è£œå¼·æ¢æ¬¾ï¼šç­‰å¾…æœŸé–“å¿…é ˆå§”è¨—/æµå‹•è³ªæŠ¼ï¼ˆLiquid Stakingï¼‰ï¼Œå°æŠ—è€å¹£è¡°é€€ã€‚
                  </div>
                </div>
              </Card>

              <Card>
                <h3 className="font-bold text-red-300 mb-2">ğŸ§± ç¬¬ä¸‰ç« ï¼šçµ‚æ¥µé˜²ç¦¦æ¨¡çµ„ (é»‘å¤©éµé å‚™é‡‘)</h3>
                <ul className="list-disc pl-4 space-y-1 text-xs">
                  <li>è³‡é‡‘ä¾†æºï¼šæ¯æœˆæœªæŠ•å…¥çš„ DCA è³‡é‡‘ + é¡å¤–é–’ç½®ç¾é‡‘ã€‚</li>
                  <li>è§¸ç™¼ï¼ˆä»»ä¸€ï¼‰ï¼š6M ATH å›æ’¤ â‰¥ 30%ï¼FNG&lt;20ï¼è·Œç ´ 200Wï¼ˆæ‰‹å‹•åˆ‡ï¼‰ã€‚</li>
                  <li>æ–¹å¼ï¼šå•Ÿå‹•å¾Œï¼Œé å‚™é‡‘åˆ† 4 é€±ç­‰é¡è²·å…¥ã€‚</li>
                  <li>åœæ­¢ï¼šè²·å…¥æœŸé–“åå½ˆ &gt; 15% ç«‹å³åœæ­¢ï¼Œä¿ç•™å­å½ˆã€‚</li>
                </ul>
              </Card>

              <Card>
                <h3 className="font-bold text-sky-300 mb-2">ğŸ§  ç¬¬å››ç« ï¼šéµè¡€ç´€å¾‹èˆ‡å®‰å…¨ (SOP)</h3>
                <ul className="list-disc pl-4 space-y-1 text-xs">
                  <li>å†·éŒ¢åŒ…éµå¾‹ï¼šäº¤æ˜“æ‰€ BTC â‰¥ 0.05 âœ ç«‹å³æé ˜è‡³å†·éŒ¢åŒ…ã€‚</li>
                  <li>ç©©å®šå¹£é¢¨æ§ï¼šç©©å®šå¹£ç¸½è³‡ç”¢ä½”æ¯”ä¸è¶…é 30%ï¼ˆè½‰æ›æœŸé™¤å¤–ï¼‰ã€‚</li>
                  <li>æ³¨æ„åŠ›ç®¡ç†ï¼šETH/BTC 0.045ã€ADA/BTC 0.000008ã€æè²ªæ¯é€±æ¨æ’­ï¼›è­¦å ±æ²’éŸ¿å°±å›åˆ°ç”Ÿæ´»ã€‚</li>
                </ul>
              </Card>

              <Card>
                <h3 className="font-bold text-yellow-300 mb-2">ğŸ“œ ç¬¬äº”ç« ï¼šè‡ªæˆ‘å¥‘ç´„</h3>
                <div className="text-xs italic text-slate-200">
                  ã€Œé€™å¥—ç³»çµ±å·²ç¶“åŒ…å«äº†æ‰€æœ‰çš„ææ‡¼èˆ‡è²ªå©ªã€‚å¸‚å ´ç˜‹ç‹‚æ™‚æˆ‘å†·éœå­˜éŒ¢ï¼›å¸‚å ´å´©ç›¤æ™‚æˆ‘é€²æ”»æŠ„åº•ã€‚ã€
                </div>
                <div className="text-xs mt-2 text-slate-300">
                  âš ï¸ æ†²æ³•ä¿®æ­£æ¢æ¬¾ï¼šè‹¥ 2030 å¹´å‰æƒ³ä¿®æ”¹è¨ˆç•«ï¼Œå¿…é ˆå¯«ä¸‹ä¿®æ”¹ç†ç”±ä¸¦å»¶é² 30 å¤©å†åŸ·è¡Œã€‚
                </div>
              </Card>

              <div className="h-8"></div>
            </div>
          )}

          {/* SYSTEM */}
          {tab === "system" && (
            <div className="space-y-4 animate-fade-in">
              <Card>
                <h3 className="font-bold text-white mb-2">ğŸ’¾ å‚™ä»½ / é‚„åŸ</h3>
                <p className="text-xs text-slate-400 mb-4">è³‡æ–™åªå­˜åœ¨æœ¬æ©Ÿã€‚æ›æ‰‹æ©Ÿ/æ¸…å¿«å–å‰è«‹å…ˆåŒ¯å‡ºå‚™ä»½ã€‚</p>
                <div className="grid grid-cols-2 gap-3">
                  <button onClick={exportData} className="bg-emerald-700 py-3 rounded-xl font-bold text-sm">åŒ¯å‡ºå‚™ä»½</button>
                  <button onClick={importData} className="bg-slate-700 py-3 rounded-xl font-bold text-sm text-slate-200">é‚„åŸå‚™ä»½</button>
                </div>
              </Card>

              <Card>
                <h3 className="font-bold text-white mb-2">ğŸ§¯ é‡ç½®</h3>
                <p className="text-xs text-slate-400 mb-4">æ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼ˆå« Logs / é€±é–ï¼‰ã€‚è«‹å…ˆåŒ¯å‡ºå‚™ä»½ã€‚</p>
                <button onClick={resetAll} className="w-full bg-red-600 hover:bg-red-500 py-3 rounded-xl font-bold text-sm text-white">
                  é‡ç½®å…¨éƒ¨è³‡æ–™
                </button>
              </Card>

              <Card>
                <h3 className="font-bold text-white mb-2">ğŸ‘ï¸ éš±ç§</h3>
                <div className="flex justify-between items-center">
                  <span className="text-sm text-slate-300">éš±ç§æ¨¡å¼ï¼ˆéš±è—é‡‘é¡ï¼‰</span>
                  <button
                    onClick={()=>setPrivacyMode(!privacyMode)}
                    className={`px-3 py-1 rounded text-xs font-bold ${privacyMode ? "bg-emerald-600" : "bg-slate-700"}`}
                  >
                    {privacyMode ? "ON" : "OFF"}
                  </button>
                </div>
              </Card>

              <Card>
                <h3 className="font-bold text-white mb-2">ğŸ§¾ ç³»çµ±è³‡è¨Š</h3>
                <div className="text-xs text-slate-400">
                  Buildï¼šfinal03ï½œæœ¬é€±é–ï¼š{canExecuteThisWeek ? "æœªåŸ·è¡Œ" : "å·²åŸ·è¡Œ"}
                </div>
              </Card>

              <div className="h-8"></div>
            </div>
          )}
        </div>
      </div>

      {/* âœ… TabBar å›ºå®šåº•éƒ¨ï¼ˆæŒ‰éˆ•ä¸æœƒä¸Šç§»ã€å…§å®¹å¯æ»‘åˆ°åº•ï¼‰ */}
      <div className="fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur border-t border-slate-800 pb-tabbar z-30">
        <div className="flex max-w-lg mx-auto px-2 py-2 gap-2">
          <TabBtn id="home" label="è¡Œå‹•" icon="âš¡" />
          <TabBtn id="convert" label="ç‹™æ“Š" icon="ğŸ¯" />
          <TabBtn id="sop" label="æ†²æ³•" icon="ğŸ“œ" />
          <TabBtn id="system" label="ç³»çµ±" icon="ğŸ’¾" />
        </div>
      </div>

      {/* Modal */}
      {modal && (
        <div
          className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in"
          onClick={(e)=> e.target===e.currentTarget && setModal(null)}
        >
          <div className="bg-slate-800 border border-slate-600 w-full max-w-sm rounded-2xl p-6 shadow-2xl relative">
            <h3 className="text-xl font-bold text-white mb-4">{modal.title}</h3>
            {renderModalBody()}
            <button onClick={()=>setModal(null)} className="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-xl text-white font-bold">
              é—œé–‰
            </button>
          </div>
        </div>
      )}
    </div>
  );
} const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
</script>
</body>
</html>
