<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Project 2030ï¼šåŸ·è¡Œæ†²æ³•ï¼ˆ3 BTCï¼‰</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <style>
    body { background:#0b1220; -webkit-tap-highlight-color: transparent; }
    input, button, textarea, select { font-size: 16px; } /* iOS: prevent zoom/keyboard collapse */
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .pb-safe { padding-bottom: calc(88px + env(safe-area-inset-bottom)); }
  </style>
</head>

<body class="text-slate-100">
<div id="root"></div>

<script>
const { useEffect, useMemo, useRef, useState } = React;

/* ===== Constants ===== */
const GOAL_BTC = 3.0;
const TARGET_DATE = new Date("2030-12-31T00:00:00+08:00").getTime();
const SAVE_KEY = "p2030_full_app_v99006";

const PART = 60;
const MONTH_PARTS = 3;

const GREED_THRESHOLD = 75;
const GREED_WEEKS_FOR_INSURANCE = 8;

const BLACK_SWAN_WEEKS = 4;
const BLACK_SWAN_STOP_REBOUND = 15;

const ETH_STAGE1 = 0.060;
const ETH_STAGE2 = 0.065;
const ETH_STAGE3 = 0.075;

const ADA_STAGE1 = 0.000010;
const ADA_STAGE2 = 0.000013;

const BUYBACK_DROP_STAGE1 = 15;
const BUYBACK_DROP_STAGE2 = 20;
const BUYBACK_DEADLINE_DAYS = 90;

/* ===== Helpers ===== */
function clamp(v, min, max){ return Math.min(max, Math.max(min, v)); }
function parseNum(s, fallback = NaN){
  const n = Number(String(s ?? "").replace(/,/g,"").trim());
  return Number.isFinite(n) ? n : fallback;
}
function fmt(n, d=4){ return Number(n||0).toFixed(d); }
function monthKeyNow(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  return `${y}-${m}`;
}
function todayMMDD(){
  return new Date().toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit'});
}
function isoPlusDays(days){
  const d = new Date();
  d.setDate(d.getDate() + days);
  return d.toISOString();
}
function daysLeftToISO(iso){
  const t = new Date(iso).getTime() - Date.now();
  return Math.max(0, Math.ceil(t / (1000*60*60*24)));
}
function reboundPctFrom(low, now){
  if(!(low > 0) || !(now > 0)) return 0;
  return ((now - low) / low) * 100;
}

/* ===== Initial State ===== */
function initialStateNow(){
  return {
    btcHot: 0.0,
    btcCold: 0.0,
    usdtReserve: 0,
    eth: 34.0,
    ada: 74000.0,

    logs: [],
    consecutiveGreedWeeks: 0,

    monthPartsRemaining: MONTH_PARTS,
    lastMonthKey: monthKeyNow(),

    blackSwan: {
      active: false,
      remainingWeeks: 0,
      weeklyBudget: 0,
      startedAtISO: null,
      reason: null,
      anchorPrice: 0,
      lowPrice: 0
    },

    pendingOrders: [] // buyback orders (USDT)
  };
}

function App(){
  const [state, setState] = useState(initialStateNow());
  const [tab, setTab] = useState("home");
  const [modal, setModal] = useState(null);

  // iPhone: uncontrolled inputs
  const draftRef = useRef({
    btcPrice: "90000",
    fngIndex: "50",
    ethBtcRatio: "0.050",
    adaBtcRatio: "0.000008",
    athDrawdownPct: "0",
    below200w: "0",
    reboundPct: "0",
    extraReserveAdd: "0",
  });

  const [ui, setUi] = useState({
    btcPrice: 90000,
    fngIndex: 50,
    ethBtcRatio: 0.050,
    adaBtcRatio: 0.000008,
    athDrawdownPct: 0,
    below200w: 0,
    reboundPct: 0,
    ma200w: 0,
    ma200wUpdatedAt: 0
  });

  // ETH stage modal refs
  const ethStageBtcRef = useRef("");
  const ethStageUsdtRef = useRef("");

  const addLog = (msg, type="info") => {
    const log = { id: Date.now() + Math.random(), date: todayMMDD(), msg, type };
    setState(prev => ({ ...prev, logs: [log, ...prev.logs].slice(0, 220) }));
  };

  /* ===== Load/Save ===== */
  useEffect(() => {
    try{
      const saved = localStorage.getItem(SAVE_KEY);
      if(saved){
        const parsed = JSON.parse(saved);
        setState({ ...initialStateNow(), ...parsed });
      }else{
        addLog("ç³»çµ±åˆå§‹åŒ–å®Œæˆã€‚ç›®æ¨™ï¼š2030 ç´¯ç© 3 BTCã€‚", "system");
      }
    }catch(e){ console.log(e); }
    // eslint-disable-next-line
  }, []);

  useEffect(() => {
    try{ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }catch(e){}
  }, [state]);

  /* ===== Derived ===== */
  const totalBtc = state.btcHot + state.btcCold;
  const progress = clamp((totalBtc / GOAL_BTC) * 100, 0, 100);
  const daysLeft = useMemo(() => Math.max(0, Math.ceil((TARGET_DATE - Date.now())/(1000*60*60*24))), [totalBtc]);

  const stableTotal = useMemo(() => {
    const openOrders = state.pendingOrders.filter(o => o.status === "open");
    const ordersUsdt = openOrders.reduce((s,o)=>s + (o.usdtAmount||0), 0);
    return (state.usdtReserve||0) + ordersUsdt;
  }, [state.usdtReserve, state.pendingOrders]);

  const portfolioUsdApprox = useMemo(() => {
    const btcUSD = totalBtc * (ui.btcPrice || 0);
    const ethUSD = state.eth * (ui.ethBtcRatio || 0) * (ui.btcPrice || 0);
    const adaUSD = state.ada * (ui.adaBtcRatio || 0) * (ui.btcPrice || 0);
    return btcUSD + ethUSD + adaUSD + stableTotal;
  }, [totalBtc, ui.btcPrice, ui.ethBtcRatio, ui.adaBtcRatio, state.eth, state.ada, stableTotal]);

  const stablePct = useMemo(() => (portfolioUsdApprox>0 ? (stableTotal/portfolioUsdApprox*100) : 0), [stableTotal, portfolioUsdApprox]);

  const setInputValue = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.value = String(val);
  };

  /* ===== Fetch helpers (pure frontend) ===== */
  const parseLooseJson = (text) => {
    const s = String(text || "");
    const i1 = s.indexOf("{");
    const i2 = s.indexOf("[");
    let i = -1;
    if (i1 === -1) i = i2;
    else if (i2 === -1) i = i1;
    else i = Math.min(i1, i2);
    if (i < 0) throw new Error("JSON not found");
    return JSON.parse(s.slice(i).trim());
  };

  const fetchText = async (url, timeoutMs = 12000) => {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeoutMs);
    try {
      const res = await fetch(url, { cache: "no-store", signal: ctrl.signal });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.text();
    } finally { clearTimeout(t); }
  };

  const proxyUrl = (url) => "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
  const jinaUrl = (url) => "https://r.jina.ai/http://" + url.replace(/^https?:\/\//, "");

  const fetchJsonSmart = async (url, timeoutMs = 12000) => {
    try { return parseLooseJson(await fetchText(url, timeoutMs)); }
    catch (e1) { addLog(`ç›´é€£å¤±æ•—ï¼š${String(e1)}`, "warning"); }
    try { return parseLooseJson(await fetchText(proxyUrl(url), timeoutMs + 4000)); }
    catch (e2) { addLog(`AllOrigins å¤±æ•—ï¼š${String(e2)}`, "warning"); }
    return parseLooseJson(await fetchText(jinaUrl(url), timeoutMs + 6000));
  };

  const withRetry = async (fn, tries = 3) => {
    let last = null;
    for (let i = 0; i < tries; i++) {
      try { return await fn(); }
      catch (e) { last = e; await new Promise(r => setTimeout(r, [600,1400,2600][i] ?? 2600)); }
    }
    throw last;
  };

  const CACHE_KEY_METRICS = "p2030_metrics_cache_v3";
  const loadMetricsCache = () => { try { return JSON.parse(localStorage.getItem(CACHE_KEY_METRICS) || "null"); } catch { return null; } };
  const saveMetricsCache = (payload) => { try { localStorage.setItem(CACHE_KEY_METRICS, JSON.stringify({ ts: Date.now(), ...payload })); } catch {} };

  /* ===== Calculators ===== */
  const calc200wMA_fromCC = async () => {
    const cc = await withRetry(() =>
      fetchJsonSmart("https://min-api.cryptocompare.com/data/v2/histoweek?fsym=BTC&tsym=USD&limit=220", 16000)
    );
    if (cc?.Response === "Error") throw new Error(cc?.Message || "CryptoCompare histoweek Error");
    const arr = cc?.Data?.Data || [];
    const closes = arr.map(x => Number(x?.close) || 0).filter(x => x > 0);
    if (closes.length < 200) throw new Error(`é€±ç·šä¸è¶³ï¼š${closes.length}`);
    const last200 = closes.slice(-200);
    const ma = last200.reduce((s,x)=>s+x,0) / last200.length;
    if (!(Number.isFinite(ma) && ma > 0)) throw new Error("MA invalid");
    return ma;
  };

  const calc200wMA_fromCG = async () => {
    const cg = await withRetry(() =>
      fetchJsonSmart("https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=2000&interval=daily", 22000)
    );
    const prices = (cg?.prices || []).map(p => Number(p?.[1]) || 0).filter(x => x > 0);
    if (prices.length < 800) throw new Error(`æ—¥ç·šä¸è¶³ï¼š${prices.length}`);
    const last1400 = prices.length > 1400 ? prices.slice(-1400) : prices;
    const ma = last1400.reduce((s,x)=>s+x,0) / last1400.length;
    if (!(Number.isFinite(ma) && ma > 0)) throw new Error("MA invalid");
    return ma;
  };

  const calc6mDD_fromCC = async (nowPrice) => {
    const cc = await withRetry(() =>
      fetchJsonSmart("https://min-api.cryptocompare.com/data/v2/histoday?fsym=BTC&tsym=USD&limit=200", 16000)
    );
    if (cc?.Response === "Error") throw new Error(cc?.Message || "CryptoCompare histoday Error");
    const arr = cc?.Data?.Data || [];
    const highs = arr.map(x => Number(x?.high) || 0).filter(x => x > 0);
    if (highs.length < 30) throw new Error(`highä¸è¶³ï¼š${highs.length}`);
    const hi = Math.max(...highs.slice(-180));
    return Math.max(0, ((hi - nowPrice) / hi) * 100);
  };

  const calc6mDD_fromCG = async (nowPrice) => {
    const cg = await withRetry(() =>
      fetchJsonSmart("https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=200&interval=daily", 22000)
    );
    const prices = (cg?.prices || []).map(p => Number(p?.[1]) || 0).filter(x => x > 0);
    if (prices.length < 30) throw new Error(`åƒ¹æ ¼ä¸è¶³ï¼š${prices.length}`);
    const hi = Math.max(...prices);
    return Math.max(0, ((hi - nowPrice) / hi) * 100);
  };  /* ===== autofill (max success + manual friendly) ===== */
  const autofillFromApis = async () => {
    try {
      addLog("è‡ªå‹•æŠ“å–ä¸­â€¦ï¼ˆç›´é€£â†’AllOriginsâ†’Jinaï¼‰", "system");

      const cache = loadMetricsCache();
      if (cache && cache.ts && (Date.now() - cache.ts) < 60_000) {
        const { btcUsd, fng, ethBtc, adaBtc, ma200w, below200w, dd6m } = cache;

        if (btcUsd>0){ draftRef.current.btcPrice=String(btcUsd); setInputValue("btcPrice", btcUsd); }
        if (Number.isFinite(fng)){ draftRef.current.fngIndex=String(fng); setInputValue("fngIndex", fng); }
        if (ethBtc>0){ draftRef.current.ethBtcRatio=String(ethBtc); setInputValue("ethBtcRatio", ethBtc); }
        if (adaBtc>0){ draftRef.current.adaBtcRatio=String(adaBtc); setInputValue("adaBtcRatio", adaBtc); }
        if (Number.isFinite(dd6m)){ draftRef.current.athDrawdownPct=dd6m.toFixed(2); setInputValue("athDrawdownPct", dd6m.toFixed(2)); }
        if (typeof below200w==="number") draftRef.current.below200w = String(below200w);

        setUi(prev => ({
          ...prev,
          ...(btcUsd>0 ? { btcPrice: btcUsd } : {}),
          ...(Number.isFinite(fng) ? { fngIndex: fng } : {}),
          ...(ethBtc>0 ? { ethBtcRatio: ethBtc } : {}),
          ...(adaBtc>0 ? { adaBtcRatio: adaBtc } : {}),
          ...(Number.isFinite(dd6m) ? { athDrawdownPct: dd6m } : {}),
          ...(Number.isFinite(ma200w) ? { ma200w } : {}),
          ...(typeof below200w==="number" ? { below200w } : {})
        }));

        addLog("å·²ä½¿ç”¨ 1 åˆ†é˜å…§å¿«å–", "system");
        return;
      }

      // FNG
      const fngJson = await withRetry(() =>
        fetchJsonSmart("https://api.alternative.me/fng/?limit=1&format=json", 16000)
      );
      const fng = clamp(parseInt(fngJson?.data?.[0]?.value ?? "0", 10), 0, 100);

      // Prices: CC first, fallback CG
      let btcUsd=0, ethUsd=0, adaUsd=0, src="cryptocompare";
      try{
        const cc = await withRetry(() =>
          fetchJsonSmart("https://min-api.cryptocompare.com/data/pricemulti?fsyms=BTC,ETH,ADA&tsyms=USD", 16000)
        );
        if (cc?.Response === "Error") throw new Error(cc?.Message || "CryptoCompare Error");
        btcUsd = Math.round(Number(cc?.BTC?.USD || 0));
        ethUsd = Number(cc?.ETH?.USD || 0);
        adaUsd = Number(cc?.ADA?.USD || 0);
        if(!(btcUsd>0)) throw new Error("BTC invalid");
        src="cryptocompare";
      }catch(e){
        addLog(`pricemulti å¤±æ•—â†’æ”¹ç”¨ CoinGeckoï¼š${String(e)}`, "warning");
        const cg = await withRetry(() =>
          fetchJsonSmart("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,cardano&vs_currencies=usd", 22000)
        );
        btcUsd = Math.round(cg?.bitcoin?.usd ?? 0);
        ethUsd = Number(cg?.ethereum?.usd ?? 0);
        adaUsd = Number(cg?.cardano?.usd ?? 0);
        src="coingecko";
      }
      if(!(btcUsd>0)) throw new Error("BTC price invalid");

      const ethBtc = ethUsd>0 ? ethUsd/btcUsd : 0;
      const adaBtc = adaUsd>0 ? adaUsd/btcUsd : 0;

      // 200W MA
      let ma200w = 0;
      if (src==="cryptocompare"){
        try{ ma200w = await calc200wMA_fromCC(); } catch(e){ addLog(`200W(é€±ç·š)å¤±æ•—ï¼š${String(e)}`, "warning"); }
        if(!(ma200w>0)){
          try{ ma200w = await calc200wMA_fromCG(); } catch(e){ addLog(`200W(æ—¥ç·šå‚™æ´)å¤±æ•—ï¼š${String(e)}`, "warning"); }
        }
      } else {
        try{ ma200w = await calc200wMA_fromCG(); } catch(e){ addLog(`200W(æ—¥ç·š)å¤±æ•—ï¼š${String(e)}`, "warning"); }
        if(!(ma200w>0)){
          try{ ma200w = await calc200wMA_fromCC(); } catch(e){ addLog(`200W(é€±ç·šå‚™æ´)å¤±æ•—ï¼š${String(e)}`, "warning"); }
        }
      }
      const below200w = (ma200w>0 && btcUsd < ma200w) ? 1 : 0;

      // 6M DD
      let dd6m = 0;
      if (src==="cryptocompare"){
        try{ dd6m = await calc6mDD_fromCC(btcUsd); }
        catch(e){ addLog(`6M(CC)å¤±æ•—ï¼š${String(e)}`, "warning"); dd6m = await calc6mDD_fromCG(btcUsd); }
      } else {
        try{ dd6m = await calc6mDD_fromCG(btcUsd); }
        catch(e){ addLog(`6M(CG)å¤±æ•—ï¼š${String(e)}`, "warning"); dd6m = await calc6mDD_fromCC(btcUsd); }
      }

      // Write
      draftRef.current.btcPrice=String(btcUsd); setInputValue("btcPrice", btcUsd);
      draftRef.current.fngIndex=String(fng); setInputValue("fngIndex", fng);
      if(ethBtc>0){ draftRef.current.ethBtcRatio=String(ethBtc); setInputValue("ethBtcRatio", ethBtc); }
      if(adaBtc>0){ draftRef.current.adaBtcRatio=String(adaBtc); setInputValue("adaBtcRatio", adaBtc); }
      draftRef.current.athDrawdownPct = dd6m.toFixed(2); setInputValue("athDrawdownPct", dd6m.toFixed(2));
      draftRef.current.below200w = String(below200w);

      setUi(prev => ({
        ...prev,
        btcPrice: btcUsd,
        fngIndex: fng,
        ethBtcRatio: ethBtc || prev.ethBtcRatio,
        adaBtcRatio: adaBtc || prev.adaBtcRatio,
        athDrawdownPct: dd6m,
        ma200w: ma200w>0 ? ma200w : prev.ma200w,
        below200w: ma200w>0 ? below200w : prev.below200w
      }));

      // Rebound update if black swan active
      if (state.blackSwan && state.blackSwan.active){
        const low = state.blackSwan.lowPrice>0 ? state.blackSwan.lowPrice : btcUsd;
        const newLow = Math.min(low, btcUsd);
        const rb = reboundPctFrom(newLow, btcUsd);
        if(newLow !== low) setState(prev => ({ ...prev, blackSwan: { ...prev.blackSwan, lowPrice: newLow } }));
        setUi(prev => ({ ...prev, reboundPct: rb }));
        draftRef.current.reboundPct = rb.toFixed(2);
        setInputValue("reboundPct", rb.toFixed(2));
      }

      saveMetricsCache({ btcUsd, fng, ethBtc, adaBtc, ma200w, below200w, dd6m, src });
      addLog(`æŠ“å–æˆåŠŸ(src=${src})ï½œ6Mâ‰ˆ${dd6m.toFixed(2)}%ï½œ200W=${ma200w>0?Math.round(ma200w):"?"}`, "success");
    } catch (e) {
      addLog(`è‡ªå‹•æŠ“å–å¤±æ•—ï¼š${String(e)}`, "warning");
      setModal({
        mode:"info",
        title:"è‡ªå‹•æŠ“å–å¤±æ•—ï¼ˆå¯æ‰‹å‹•æ›´æ–°ï¼‰",
        body:
`å·²å˜—è©¦ ç›´é€£â†’AllOriginsâ†’Jina ä¸‰é‡å‚™æ´ä»å¤±æ•—ï¼ˆSafari å¸¸è¦‹ï¼‰ã€‚

ä½ å¯ä»¥æ‰‹å‹•å¡«ï¼š
- BTC åƒ¹æ ¼ã€æè²ª
- ETH/BTCã€ADA/BTC
- 6M å›æ’¤%
- åå½ˆ%
ç„¶å¾Œç…§å¸¸æŒ‰ã€ŒåŸ·è¡Œæœ¬é€±æ±ºç­–ã€ã€‚`
      });
    }
  };

  useEffect(()=>{ autofillFromApis(); },[]); // eslint-disable-line

  /* ===== UI Components ===== */
  const Chip = ({active, children, onClick}) => (
    React.createElement("button", { onClick,
      className: "px-3 py-2 rounded-xl text-sm font-semibold " + (active ? "bg-emerald-600 text-white" : "bg-slate-800 text-slate-300")
    }, children)
  );

  const Field = ({label, name, id, inputMode="decimal", placeholder=""}) => (
    React.createElement("div", { className:"space-y-1" },
      React.createElement("div", { className:"text-xs text-slate-400" }, label),
      React.createElement("input", {
        id: id || undefined,
        defaultValue: draftRef.current[name],
        inputMode,
        placeholder,
        className:"w-full bg-slate-900 border border-slate-700 rounded-2xl px-4 py-3 text-lg mono focus:outline-none focus:ring-2 focus:ring-emerald-500",
        onInput:(e)=>{ draftRef.current[name] = e.target.value; },
        onBlur:()=>{ const v=parseNum(draftRef.current[name], NaN); if(Number.isFinite(v)) setUi(p=>({ ...p, [name]: v })); },
        autoCorrect:"off", autoCapitalize:"off", spellCheck:false
      })
    )
  );

  const Toggle01 = ({label, name}) => (
    React.createElement("div", { className:"flex items-center justify-between bg-slate-900 border border-slate-700 rounded-2xl px-4 py-3" },
      React.createElement("div", { className:"text-sm text-slate-200" }, label),
      React.createElement("button", {
        className: "px-3 py-2 rounded-xl text-xs font-bold " + (Number(ui[name]||0)===1 ? "bg-emerald-600" : "bg-slate-700"),
        onClick:()=>{ const next = Number(ui[name]||0)===1 ? 0 : 1; setUi(p=>({ ...p, [name]: next })); draftRef.current[name]=String(next); }
      }, Number(ui[name]||0)===1 ? "ON" : "OFF")
    )
  );

  /* ===== Backup ===== */
  const copyToClipboard = async (text) => {
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(e){}
    try{
      const ta=document.createElement("textarea");
      ta.value=text; ta.style.position="fixed"; ta.style.left="-9999px";
      document.body.appendChild(ta); ta.focus(); ta.select();
      const ok=document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }catch(e){ return false; }
  };

  const exportBackup = () => {
    const payload = { schema:"project2030-backup-v1", exportedAtISO:new Date().toISOString(), state, ui, draft: draftRef.current };
    setModal({ mode:"export", title:"åŒ¯å‡ºå‚™ä»½", json: JSON.stringify(payload, null, 2) });
  };

  const importBackup = (jsonText) => {
    try{
      const obj = JSON.parse(jsonText);
      if(!(obj && obj.schema==="project2030-backup-v1" && obj.state)) throw new Error("bad");
      setState({ ...initialStateNow(), ...obj.state });
      if(obj.ui) setUi(prev => ({ ...prev, ...obj.ui }));
      if(obj.draft) draftRef.current = { ...draftRef.current, ...obj.draft };

      if(draftRef.current.btcPrice) setInputValue("btcPrice", draftRef.current.btcPrice);
      if(draftRef.current.fngIndex) setInputValue("fngIndex", draftRef.current.fngIndex);
      if(draftRef.current.ethBtcRatio) setInputValue("ethBtcRatio", draftRef.current.ethBtcRatio);
      if(draftRef.current.adaBtcRatio) setInputValue("adaBtcRatio", draftRef.current.adaBtcRatio);
      if(draftRef.current.athDrawdownPct) setInputValue("athDrawdownPct", draftRef.current.athDrawdownPct);
      if(draftRef.current.reboundPct) setInputValue("reboundPct", draftRef.current.reboundPct);

      addLog("å·²åŒ¯å…¥å‚™ä»½ä¸¦è¦†è“‹ç›®å‰è³‡æ–™ã€‚", "success");
      setModal({ mode:"info", title:"åŒ¯å…¥æˆåŠŸ", body:"å‚™ä»½å·²åŒ¯å…¥ã€‚" });
    }catch(e){
      setModal({ mode:"info", title:"åŒ¯å…¥å¤±æ•—", body:"JSON æ ¼å¼ä¸æ­£ç¢ºæˆ–ä¸æ˜¯æœ¬ App çš„å‚™ä»½ã€‚" });
    }
  };  /* ===== Reserve / Reset / Cold wallet ===== */
  const addExtraReserve = () => {
    const add = Math.max(0, Math.floor(parseNum(draftRef.current.extraReserveAdd, 0)));
    if(!(add>0)){ setModal({ mode:"info", title:"è¼¸å…¥éŒ¯èª¤", body:"è«‹è¼¸å…¥è¦è£œå……çš„é å‚™é‡‘ï¼ˆæ­£æ•´æ•¸ï¼‰" }); return; }
    setState(prev => ({ ...prev, usdtReserve: prev.usdtReserve + add }));
    addLog(`æ‰‹å‹•è£œå……é å‚™é‡‘ï¼š+${add} U`, "success");
    draftRef.current.extraReserveAdd = "0";
    setModal({ mode:"info", title:"è£œå……æˆåŠŸ", body:`å·²è£œå……é å‚™é‡‘ +${add} U` });
  };

  const resetAll = () => {
    try{ localStorage.removeItem(SAVE_KEY); }catch(e){}
    const init = initialStateNow();
    setState({ ...init, logs: [] });
    setUi({
      btcPrice: 90000, fngIndex: 50,
      ethBtcRatio: 0.050, adaBtcRatio: 0.000008,
      athDrawdownPct: 0, below200w: 0, reboundPct: 0,
      ma200w: 0, ma200wUpdatedAt: 0
    });
    draftRef.current = {
      btcPrice:"90000", fngIndex:"50", ethBtcRatio:"0.050", adaBtcRatio:"0.000008",
      athDrawdownPct:"0", below200w:"0", reboundPct:"0", extraReserveAdd:"0"
    };
    setModal({ mode:"info", title:"å·²é‡ç½®", body:"æ‰€æœ‰è³‡æ–™å·²æ¸…ç©ºï¼Œä¸¦å›åˆ°åˆå§‹å€¼ã€‚" });
  };

  const moveCold = () => {
    if(state.btcHot < 0.05){
      setModal({ mode:"info", title:"æŒ‡ä»¤æ‹’çµ•", body:"æœªé” 0.05 BTC é–€æª»ï¼Œè«‹ç¯€çœæ‰‹çºŒè²»ã€‚" });
      return;
    }
    const amount = state.btcHot;
    setState(prev => ({ ...prev, btcHot:0, btcCold: prev.btcCold + amount }));
    addLog(`æé ˜ ${amount.toFixed(6)} BTC è‡³å†·éŒ¢åŒ…`, "secure");
    setModal({ mode:"info", title:"è³‡ç”¢è½‰ç§»", body:`æˆåŠŸç§»å…¥å†·éŒ¢åŒ…ï¼š${amount.toFixed(6)} BTC` });
  };

  /* ===== Orders / Conversion ===== */
  const createUsdtBuybackOrder = (usdtAmount, dropPct) => {
    const btcPrice = Number(ui.btcPrice || 0);
    if(!(btcPrice>0)) return null;
    const usdt = Number(usdtAmount);
    if(!(usdt>0)) return null;
    const targetPrice = btcPrice * (1 - dropPct/100);
    return {
      id: Date.now() + Math.random(),
      createdAtISO: new Date().toISOString(),
      deadlineISO: isoPlusDays(BUYBACK_DEADLINE_DAYS),
      usdtAmount: usdt,
      refBtcPrice: btcPrice,
      dropPct,
      targetPrice,
      status: "open",
      btcReceived: 0
    };
  };

  const executeConvertDirectToBTC = (asset, amountAsset, btcReceived) => {
    const amount = Number(amountAsset);
    const btc = Number(btcReceived);
    if(!(amount>0) || !(btc>0)) return false;

    setState(prev => {
      const next = { ...prev };
      if(asset==="ETH"){ if(next.eth < amount) return prev; next.eth -= amount; }
      if(asset==="ADA"){ if(next.ada < amount) return prev; next.ada -= amount; }
      next.btcHot += btc;
      return next;
    });

    addLog(`[è½‰æ›] ${amount} ${asset} â†’ ${btc.toFixed(6)} BTC`, "success");
    return true;
  };

  const executeConvertToUSDTWithOrder = (ethAmount, usdtReceived, dropPct) => {
    const eth = Number(ethAmount);
    const usdt = Number(usdtReceived);
    if(!(eth>0) || !(usdt>0)) return false;

    const order = createUsdtBuybackOrder(usdt, dropPct);
    if(!order){
      setModal({ mode:"info", title:"ç¼ºå°‘è³‡æ–™", body:"è«‹å…ˆåœ¨ HOME è¼¸å…¥ BTC åƒ¹æ ¼ï¼Œæ‰èƒ½å»ºç«‹å›æ¥æ›å–®ã€‚" });
      return false;
    }

    setState(prev => {
      if(prev.eth < eth) return prev;
      return { ...prev, eth: prev.eth - eth, pendingOrders: [order, ...prev.pendingOrders] };
    });

    addLog(`[è½‰æ›] ${eth} ETH â†’ ${Math.floor(usdt)} USDTï¼ˆå›æ’¤${dropPct}%æ¥å›ï½œ90å¤©å›å®¶ï¼‰`, "warning");
    return true;
  };

  const checkAndBuybackOrders = () => {
    const btcPrice = Number(ui.btcPrice || 0);
    if(!(btcPrice>0)){
      setModal({ mode:"info", title:"ç¼ºå°‘è³‡æ–™", body:"è«‹å…ˆåœ¨ HOME è¼¸å…¥ BTC åƒ¹æ ¼ã€‚" });
      return;
    }

    const nowISO = new Date().toISOString();
    let btcGained = 0;

    const updated = state.pendingOrders.map(o => {
      if(o.status !== "open") return o;
      if(btcPrice <= o.targetPrice){
        const btcBought = (o.usdtAmount||0) / btcPrice;
        btcGained += btcBought;
        return { ...o, status:"closed", closedReason:"target_hit_buyback", btcReceived: btcBought, closedAtISO: nowISO };
      }
      return o;
    });

    if(btcGained > 0){
      setState(prev => ({ ...prev, btcHot: prev.btcHot + btcGained, pendingOrders: updated }));
      addLog(`[æ›å–®æ¥å›] é”æ¨™æ¥å›ï¼š+${btcGained.toFixed(6)} BTC`, "success");
      setModal({ mode:"info", title:"æ¥å›å®Œæˆ", body:`å·²æ¥å› BTC +${btcGained.toFixed(6)} é¡†ã€‚` });
    }else{
      setState(prev => ({ ...prev, pendingOrders: updated }));
      setModal({ mode:"info", title:"æœªé”æ¨™", body:"ç›®å‰æ²’æœ‰æ›å–®é”åˆ°æ¥å›åƒ¹ä½ã€‚" });
    }
  };

  /* ===== ETH stage modal ===== */
  const openEthMixedModal = (stage) => {
    const need = stage===1 ? ETH_STAGE1 : ETH_STAGE2;
    if(ui.ethBtcRatio < need){
      setModal({ mode:"info", title:"æœªé”é–€æª»", body:`ETH/BTC éœ€ >= ${need}` });
      return;
    }
    ethStageBtcRef.current = "";
    ethStageUsdtRef.current = "";
    setModal({ mode: stage===1 ? "eth_stage1" : "eth_stage2", title: stage===1 ? "ETH ä¸€éšè¼¸å…¥" : "ETH äºŒéšè¼¸å…¥" });
  };

  const confirmEthMixed = (stage) => {
    const btc = parseNum(ethStageBtcRef.current, NaN);
    const usdt = parseNum(ethStageUsdtRef.current, NaN);
    const ethToBtc = stage===1 ? 5 : 6;
    const ethToUsdt = stage===1 ? 5 : 6;
    const drop = stage===1 ? BUYBACK_DROP_STAGE1 : BUYBACK_DROP_STAGE2;

    if(!(btc>0)){ setModal({ mode:"info", title:"è¼¸å…¥éŒ¯èª¤", body:"BTC æ•¸é‡å¿…é ˆ > 0" }); return; }
    if(!(usdt>0)){ setModal({ mode:"info", title:"è¼¸å…¥éŒ¯èª¤", body:"USDT æ•¸é‡å¿…é ˆ > 0" }); return; }

    const ok = executeConvertDirectToBTC("ETH", ethToBtc, btc);
    if(!ok){ setModal({ mode:"info", title:"åŸ·è¡Œå¤±æ•—", body:"ETH ä¸è¶³æˆ–è³‡æ–™éŒ¯èª¤ã€‚" }); return; }
    executeConvertToUSDTWithOrder(ethToUsdt, usdt, drop);
    setModal({ mode:"info", title:"å®Œæˆ", body:`å·²å®Œæˆ ETH ç¬¬${stage}éšï¼šä¸€åŠæ› BTC + ä¸€åŠæ› USDT ä¸¦å»ºç«‹æ›å–®ã€‚` });
  };

  /* ===== Weekly Execute ===== */
  const executeWeekly = () => {
    const btcPrice = Number(ui.btcPrice || 0);
    const fng = clamp(Number(ui.fngIndex || 0), 0, 100);

    if(!(btcPrice>0)){
      setModal({ mode:"info", title:"è¼¸å…¥éŒ¯èª¤", body:"BTC åƒ¹æ ¼å¿…é ˆ > 0" });
      return;
    }

    const nowMonthKey = monthKeyNow();
    let monthRefilled = false;

    // monthly refill
    let monthParts = state.monthPartsRemaining;
    let lastMonthKey = state.lastMonthKey;
    if(lastMonthKey !== nowMonthKey){
      monthParts = MONTH_PARTS;
      lastMonthKey = nowMonthKey;
      monthRefilled = true;
    }

    // 90-day force buyback
    const nowISO = new Date().toISOString();
    let forcedBtc = 0;
    const updatedOrders = state.pendingOrders.map(o => {
      if(o.status !== "open") return o;
      if(new Date(o.deadlineISO).getTime() <= Date.now()){
        const btcBought = (o.usdtAmount||0) / btcPrice;
        forcedBtc += btcBought;
        return { ...o, status:"closed", closedReason:"deadline_force_buyback", btcReceived: btcBought, closedAtISO: nowISO };
      }
      return o;
    });

    // bucket & greed weeks
    let greedWeeks = state.consecutiveGreedWeeks;
    let bucket = "";
    if(fng < 20){ bucket="A"; greedWeeks = 0; }
    else if(fng <= 40){ bucket="B"; greedWeeks = 0; }
    else if(fng <= 75){ bucket="C"; greedWeeks = 0; }
    else { bucket="D"; greedWeeks += 1; }

    // decide parts
    let spendParts = 0, saveParts = 0, action = "";
    if(monthParts <= 0){
      action = "æœ¬æœˆä»½é¡å·²ç”¨å®Œï¼ˆ0/3ï¼‰ï½œæœ¬æ¬¡ä¸æ–°å¢æœˆè–ªè³‡é‡‘";
    }else{
      if(bucket==="A"){ action="A æ¥µåº¦ææ…Œï¼š3ä»½è²·é€²"; spendParts=3; saveParts=0; }
      if(bucket==="B"){ action="B ææ‡¼ï¼š2è²·1å­˜"; spendParts=2; saveParts=1; }
      if(bucket==="C"){ action="C ä¸­æ€§ï¼š1è²·2å­˜"; spendParts=1; saveParts=2; }
      if(bucket==="D"){
        if(greedWeeks > GREED_WEEKS_FOR_INSURANCE){ action="D è²ªå©ªï¼šé•·ç‰›ä¿éšª 1è²·2å­˜"; spendParts=1; saveParts=2; }
        else { action="D è²ªå©ªï¼š0è²·3å­˜"; spendParts=0; saveParts=3; }
      }
      const totalWanted = spendParts + saveParts;
      if(totalWanted > monthParts){
        const sp = Math.min(spendParts, monthParts);
        const left = monthParts - sp;
        const sv = Math.min(saveParts, left);
        spendParts = sp; saveParts = sv;
        action += `ï¼ˆä»½é¡ä¸è¶³ï¼šè²·${sp}ä»½/å­˜${sv}ä»½ï¼‰`;
      }
    }

    const usdtSpent = spendParts * PART;
    const usdtSaved = saveParts * PART;

    // black swan trigger
    const athDD = clamp(Number(ui.athDrawdownPct || 0), 0, 100);
    const below200w = Number(ui.below200w || 0) === 1;
    const blackSwanTriggered = (fng < 20) || (athDD >= 30) || below200w;

    let blackSwan = { ...state.blackSwan };
    let blackSwanSpent = 0;

    // compute rebound from lowPrice if active
    let currentRebound = 0;
    if (blackSwan.active){
      const low = blackSwan.lowPrice > 0 ? blackSwan.lowPrice : btcPrice;
      const newLow = Math.min(low, btcPrice);
      blackSwan = { ...blackSwan, lowPrice: newLow };
      currentRebound = reboundPctFrom(newLow, btcPrice);
      setUi(prev => ({ ...prev, reboundPct: currentRebound }));
      draftRef.current.reboundPct = currentRebound.toFixed(2);
      setInputValue("reboundPct", currentRebound.toFixed(2));
    }

    // stop if rebound > 15%
    if (blackSwan.active && currentRebound > BLACK_SWAN_STOP_REBOUND){
      blackSwan = { ...blackSwan, active:false, remainingWeeks:0 };
      addLog(`é»‘å¤©éµåœæ­¢ï¼šåå½ˆ ${currentRebound.toFixed(2)}% > ${BLACK_SWAN_STOP_REBOUND}%`, "warning");
    }

    // reserve after save
    let reserveAfterSave = state.usdtReserve + usdtSaved;

    // start black swan
    if(!blackSwan.active && blackSwanTriggered){
      const reserveNow = reserveAfterSave;
      if(reserveNow > 0){
        const weekly = reserveNow / BLACK_SWAN_WEEKS;
        const reason = (fng < 20) ? "FNG<20" : (athDD >= 30 ? "6M ATHå›æ’¤>=30%" : "è·Œç ´200W");
        blackSwan = {
          active:true,
          remainingWeeks:BLACK_SWAN_WEEKS,
          weeklyBudget:weekly,
          startedAtISO:nowISO,
          reason,
          anchorPrice: btcPrice,
          lowPrice: btcPrice
        };
        addLog(`é»‘å¤©éµå•Ÿå‹•ï¼šåŸå› =${reason}ï½œé å‚™é‡‘åˆ†4é€±è²·å…¥`, "alert");
      }
    }

    // black swan buy this week
    if(blackSwan.active && blackSwan.remainingWeeks > 0){
      const spend = Math.max(0, Math.min(reserveAfterSave, blackSwan.weeklyBudget));
      if(spend > 0){
        blackSwanSpent = spend;
        reserveAfterSave -= spend;
        blackSwan = { ...blackSwan, remainingWeeks: blackSwan.remainingWeeks - 1 };
        addLog(`é»‘å¤©éµè²·å…¥ï¼šæœ¬é€±å‹•ç”¨é å‚™é‡‘ ${Math.floor(spend)}Uï¼ˆå‰© ${blackSwan.remainingWeeks} é€±ï¼‰`, "success");
      }
      if(blackSwan.remainingWeeks <= 0){
        blackSwan = { ...blackSwan, active:false, remainingWeeks:0 };
        addLog("é»‘å¤©éµçµæŸï¼š4é€±è²·å…¥å®Œæˆ", "system");
      }
    }

    // buy BTC (DCA + black swan) + forced buyback
    const totalSpent = usdtSpent + blackSwanSpent;
    const btcBought = totalSpent > 0 ? (totalSpent / btcPrice) : 0;

    // consume parts
    const usedParts = spendParts + saveParts;
    const newMonthParts = Math.max(0, monthParts - usedParts);

    const next = {
      ...state,
      btcHot: state.btcHot + btcBought + forcedBtc,
      usdtReserve: reserveAfterSave,
      consecutiveGreedWeeks: greedWeeks,
      monthPartsRemaining: newMonthParts,
      lastMonthKey,
      blackSwan,
      pendingOrders: updatedOrders
    };
    setState(next);

    if(monthRefilled) addLog("æœˆä»½æ›´æ–°ï¼šè£œå……æœ¬æœˆä»½é¡ 3 ä»½ï¼ˆ180Uï¼‰", "system");
    addLog(`é€±å ±ï¼š${action}`, usdtSpent > 0 ? "success" : "warning");
    if(usdtSaved > 0) addLog(`å­˜å…¥é å‚™é‡‘ï¼š+${usdtSaved}U`, "info");
    if(totalSpent > 0) addLog(`æœ¬é€±æŠ•å…¥ï¼š${Math.floor(totalSpent)}U â†’ è²·å…¥ ${btcBought.toFixed(6)} BTC`, "success");
    if(forcedBtc > 0) addLog(`90å¤©å›å®¶ï¼šåˆ°æœŸå¼·åˆ¶è²·å› +${forcedBtc.toFixed(6)} BTC`, "alert");

    const hit = updatedOrders.filter(o => o.status==="open" && (ui.btcPrice||0) <= (o.targetPrice||-1));
    if(hit.length > 0) addLog(`æ›å–®é”æ¨™æé†’ï¼š${hit.length} ç­†å·²é”æ¥å›åƒ¹ï¼ˆåˆ°æ›å–®é ï¼‰`, "alert");

    setModal({
      mode:"info",
      title:"åŸ·è¡Œå®Œæˆ",
      body: `
${action}
æœ¬æœˆä»½é¡å‰©é¤˜ï¼š${newMonthParts}/3
DCA æŠ•å…¥ï¼š${usdtSpent}Uï½œå­˜å…¥é å‚™ï¼š${usdtSaved}U
é»‘å¤©éµå‹•ç”¨ï¼š${Math.floor(blackSwanSpent)}U
è²·å…¥ BTCï¼š${btcBought.toFixed(6)}
90å¤©å›å®¶ï¼š${forcedBtc>0 ? ("+ "+forcedBtc.toFixed(6)+" BTC") : "ç„¡"}
ç¸½æŒæœ‰ï¼š${(next.btcHot+next.btcCold).toFixed(4)} BTC
é å‚™é‡‘é¤˜é¡ï¼š${Math.floor(next.usdtReserve)}U
      `.trim()
    });
  };

  /* ===== UI components ===== */
  const HeaderCards = () => (
    React.createElement("div", { className:"space-y-4" },
      React.createElement("div", { className:"grid grid-cols-2 gap-3" },
        React.createElement("div", { className:"bg-slate-800 rounded-2xl p-4 border border-slate-700" },
          React.createElement("div", { className:"text-xs text-slate-400" }, "ç†±éŒ¢åŒ… (BTC)"),
          React.createElement("div", { className:"text-2xl mono font-bold mt-1" }, fmt(state.btcHot,4)),
          React.createElement("button", { onClick: moveCold, className:"mt-3 w-full bg-slate-700 hover:bg-slate-600 rounded-xl py-2 text-sm font-bold" }, "æé ˜åˆ°å†·éŒ¢åŒ…")
        ),
        React.createElement("div", { className:"bg-slate-800 rounded-2xl p-4 border border-slate-700" },
          React.createElement("div", { className:"text-xs text-slate-400" }, "å†·éŒ¢åŒ… (BTC)"),
          React.createElement("div", { className:"text-2xl mono font-bold mt-1" }, fmt(state.btcCold,4))
        )
      ),

      React.createElement("div", { className:"bg-slate-800 rounded-2xl p-4 border border-slate-700 space-y-3" },
        React.createElement("div", { className:"flex items-start justify-between gap-2" },
          React.createElement("div", null,
            React.createElement("div", { className:"text-xs text-slate-400" }, "é å‚™é‡‘ (USDT)"),
            React.createElement("div", { className:"text-2xl mono font-bold mt-1" }, "$" + Math.floor(state.usdtReserve||0).toLocaleString())
          ),
          React.createElement("div", { className:"flex gap-2 flex-wrap justify-end" },
            React.createElement("button", { onClick: exportBackup, className:"text-xs px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 font-bold" }, "åŒ¯å‡º"),
            React.createElement("button", { onClick: ()=> setModal({ mode:"import", title:"åŒ¯å…¥å‚™ä»½" }), className:"text-xs px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 font-bold" }, "åŒ¯å…¥"),
            React.createElement("button", { onClick: resetAll, className:"text-xs px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 font-bold" }, "é‡ç½®")
          )
        ),
        React.createElement("div", { className:"grid grid-cols-3 gap-2 items-end" },
          React.createElement("div", { className:"col-span-2" },
            React.createElement("div", { className:"text-xs text-slate-400 mb-1" }, "æ‰‹å‹•è£œå……é å‚™é‡‘"),
            React.createElement("input", {
              defaultValue: draftRef.current.extraReserveAdd,
              inputMode:"numeric",
              className:"w-full bg-slate-900 border border-slate-700 rounded-2xl px-4 py-3 text-lg mono focus:outline-none focus:ring-2 focus:ring-emerald-500",
              onInput: (e)=>{ draftRef.current.extraReserveAdd = e.target.value; }
            })
          ),
          React.createElement("button", { onClick: addExtraReserve, className:"h-[52px] bg-emerald-600 hover:bg-emerald-700 rounded-2xl font-black" }, "åŠ å…¥")
        )
      )
    )
  );

  const HomePage = () => (
    React.createElement("div", { className:"bg-slate-800 rounded-2xl p-5 border border-slate-700 space-y-4" },
      React.createElement("div", { className:"flex items-center justify-between" },
        React.createElement("div", { className:"text-lg font-extrabold text-emerald-400" }, "âš¡ æ¯é€±åŸ·è¡Œ"),
        React.createElement("div", { className:"text-xs text-slate-400 mono" }, `ä»½é¡ ${state.monthPartsRemaining}/3`)
      ),
      React.createElement(Field, { label:"BTC åƒ¹æ ¼ (USDâ‰ˆUSDT)", name:"btcPrice", id:"btcPrice", inputMode:"numeric" }),
      React.createElement("div", { className:"space-y-1" },
        React.createElement("div", { className:"flex justify-between items-center" },
          React.createElement("div", { className:"text-xs text-slate-400" }, "ææ‡¼èˆ‡è²ªå©ª (0-100)"),
          React.createElement("div", { className:"text-sm mono text-emerald-300" }, String(ui.fngIndex))
        ),
        React.createElement("input", {
          id:"fngIndex",
          defaultValue: draftRef.current.fngIndex,
          inputMode:"numeric",
          className:"w-full bg-slate-900 border border-slate-700 rounded-2xl px-4 py-3 text-lg mono focus:outline-none focus:ring-2 focus:ring-emerald-500",
          onInput:(e)=>{ draftRef.current.fngIndex = e.target.value; },
          onBlur:()=>{
            let n = parseNum(draftRef.current.fngIndex, ui.fngIndex);
            if(!Number.isFinite(n)) n = ui.fngIndex;
            n = clamp(Math.round(n), 0, 100);
            draftRef.current.fngIndex = String(n);
            setUi(prev => ({ ...prev, fngIndex: n }));
          }
        })
      ),
      React.createElement("button", { onClick: autofillFromApis, className:"w-full bg-slate-700 hover:bg-slate-600 rounded-2xl py-3 font-bold" },
        "è‡ªå‹•æŠ“å–ï¼ˆç›´é€£â†’AllOriginsâ†’Jinaï¼‰"),
      React.createElement(Field, { label:"ETH/BTC åŒ¯ç‡", name:"ethBtcRatio", id:"ethBtcRatio", inputMode:"decimal" }),
      React.createElement(Field, { label:"ADA/BTC åŒ¯ç‡", name:"adaBtcRatio", id:"adaBtcRatio", inputMode:"decimal" }),
      React.createElement(Field, { label:"è¿‘6å€‹æœˆ ATH å›æ’¤(%)", name:"athDrawdownPct", id:"athDrawdownPct", inputMode:"decimal" }),
      React.createElement("div", { className:"bg-slate-900 border border-slate-700 rounded-2xl p-4 space-y-2" },
        React.createElement("div", { className:"text-xs text-slate-400" }, "200W MA"),
        React.createElement("div", { className:"text-sm mono text-slate-200" },
          ui.ma200w > 0 ? `200Wâ‰ˆ${Math.round(ui.ma200w)}ï½œè·Œç ´=${ui.below200w ? "ON" : "OFF"}` : "å°šæœªå–å¾—ï¼ˆä¸å½±éŸ¿åŸ·è¡Œï¼‰"
        )
      ),
      React.createElement(Toggle01, { label:"BTC è·Œç ´ 200Wï¼ˆå¯æ‰‹å‹•åˆ‡ï¼‰", name:"below200w" }),
      React.createElement(Field, { label:"åå½ˆ(%)ï¼ˆé»‘å¤©éµæœŸé–“è‡ªå‹•/ä¹Ÿå¯æ‰‹å‹•ï¼‰", name:"reboundPct", id:"reboundPct", inputMode:"decimal" }),
      React.createElement("button", { onClick: executeWeekly, className:"w-full bg-emerald-600 hover:bg-emerald-700 rounded-2xl py-4 text-lg font-black" }, "åŸ·è¡Œæœ¬é€±æ±ºç­–")
    )
  );

  const ConvertPage = () => (
    React.createElement("div", { className:"bg-slate-800 rounded-2xl p-5 border border-slate-700 space-y-4" },
      React.createElement("div", { className:"text-lg font-extrabold text-fuchsia-300" }, "ğŸ”„ åŒ¯ç‡è½‰æ›"),
      React.createElement("div", { className:"text-sm text-slate-300" }, `ETH: ${fmt(state.eth,2)}ï½œADA: ${Math.floor(state.ada).toLocaleString()}`),
      React.createElement("div", { className:"grid grid-cols-2 gap-2" },
        React.createElement("button", { className:"bg-slate-700 hover:bg-slate-600 rounded-xl py-3 text-sm font-black", onClick:()=>openEthMixedModal(1) }, "ETH ä¸€éšï¼ˆæ··åˆï¼‰"),
        React.createElement("button", { className:"bg-slate-700 hover:bg-slate-600 rounded-xl py-3 text-sm font-black", onClick:()=>openEthMixedModal(2) }, "ETH äºŒéšï¼ˆæ··åˆï¼‰")
      ),
      React.createElement("button", {
        className:"w-full bg-fuchsia-600 hover:bg-fuchsia-700 rounded-2xl py-4 text-sm font-black",
        onClick: ()=> {
          if(ui.ethBtcRatio < ETH_STAGE3){ setModal({mode:"info", title:"æœªé”é–€æª»", body:`ETH/BTC éœ€ >= ${ETH_STAGE3}`}); return; }
          const btc = prompt("ä¸‰éšï¼šè¼¸å…¥ 12 ETH å…¨æ›åˆ°çš„ BTC æ•¸é‡","");
          if(!btc) return;
          executeConvertDirectToBTC("ETH", 12, parseNum(btc, NaN));
        }
      }, "ETH ä¸‰éšï¼ˆå…¨æ› BTCï¼‰"),
      React.createElement("div", { className:"text-xs text-slate-400" }, "ADA ä¸€/äºŒéšï¼ˆç›´æ¥æ› BTCï¼‰"),
      React.createElement("div", { className:"grid grid-cols-2 gap-2" },
        React.createElement("button", {
          className:"bg-slate-700 hover:bg-slate-600 rounded-xl py-3 text-sm font-black",
          onClick: ()=> {
            if(ui.adaBtcRatio < ADA_STAGE1){ setModal({mode:"info", title:"æœªé”é–€æª»", body:`ADA/BTC éœ€ >= ${ADA_STAGE1}`}); return; }
            const btc = prompt("ADA ä¸€éšï¼š40,000 ADA æ›åˆ°çš„ BTC æ•¸é‡","");
            if(!btc) return;
            executeConvertDirectToBTC("ADA", 40000, parseNum(btc, NaN));
          }
        }, "ADA ä¸€éš"),
        React.createElement("button", {
          className:"bg-slate-700 hover:bg-slate-600 rounded-xl py-3 text-sm font-black",
          onClick: ()=> {
            if(ui.adaBtcRatio < ADA_STAGE2){ setModal({mode:"info", title:"æœªé”é–€æª»", body:`ADA/BTC éœ€ >= ${ADA_STAGE2}`}); return; }
            const btc = prompt("ADA äºŒéšï¼š34,000 ADA æ›åˆ°çš„ BTC æ•¸é‡","");
            if(!btc) return;
            executeConvertDirectToBTC("ADA", 34000, parseNum(btc, NaN));
          }
        }, "ADA äºŒéš")
      )
    )
  );

  const OrdersPage = () => (
    React.createElement("div", { className:"bg-slate-800 rounded-2xl p-5 border border-slate-700 space-y-3" },
      React.createElement("div", { className:"text-lg font-extrabold text-sky-300" }, "ğŸ“Œ æ›å–®/90å¤©"),
      React.createElement("button", { onClick: checkAndBuybackOrders, className:"w-full bg-sky-600 hover:bg-sky-700 rounded-2xl py-4 text-lg font-black" }, "æª¢æŸ¥æ›å–® / é”æ¨™æ¥å›"),
      React.createElement("div", { className:"bg-slate-900 border border-slate-700 rounded-2xl p-4" },
        React.createElement("div", { className:"text-xs text-slate-500 mono mb-2" }, "> PENDING ORDERS"),
        (state.pendingOrders.length===0)
          ? React.createElement("div", { className:"text-slate-600 text-sm" }, "ç›®å‰æ²’æœ‰æ›å–®ã€‚")
          : state.pendingOrders.slice(0, 30).map(o => {
              const open = o.status==="open";
              return React.createElement("div", { key:o.id, className:"border-b border-slate-800 py-3 last:border-0" },
                React.createElement("div", { className:"flex items-center justify-between" },
                  React.createElement("div", { className:"text-sm font-bold " + (open ? "text-yellow-300" : "text-slate-400") }, open ? "OPEN" : "CLOSED"),
                  React.createElement("div", { className:"text-xs text-slate-500 mono" }, open ? `å‰© ${daysLeftToISO(o.deadlineISO)} å¤©` : (o.closedReason||""))
                ),
                React.createElement("div", { className:"text-xs mono text-slate-300 mt-1" },
                  `USDT=${Math.floor(o.usdtAmount||0)}ï½œå›æ’¤=${o.dropPct}%ï½œæ¥å›åƒ¹â‰¤${Math.floor(o.targetPrice||0)}`
                )
              );
            })
      )
    )
  );

  // âœ… æ†²æ³•é ï¼šæ–°å¢æ ¸å¿ƒä¿¡æ¢ï¼‹å¥‘ç´„é‡é»
  const SopPage = () => (
    React.createElement("div", { className:"bg-slate-800 rounded-2xl p-5 border border-slate-700 space-y-4" },
      React.createElement("div", { className:"text-xl font-black text-yellow-300" }, "ğŸ“œ æ ¸å¿ƒä¿¡æ¢ & è‡ªæˆ‘å¥‘ç´„"),

      React.createElement("div", { className:"bg-slate-900 border border-slate-700 rounded-2xl p-4 space-y-2" },
        React.createElement("div", { className:"text-sm font-bold text-slate-200" }, "æ ¸å¿ƒä¿¡æ¢"),
        React.createElement("ul", { className:"list-disc pl-5 text-sm text-slate-300 space-y-1" },
          React.createElement("li", null, "æˆ‘çš„ç›®æ¨™æ˜¯ BTC é¡†æ•¸ï¼Œä¸æ˜¯æ³•å¹£æ•¸å­—ã€‚"),
          React.createElement("li", null, "æˆ‘ä¸é æ¸¬å¸‚å ´ï¼Œæˆ‘åªåŸ·è¡Œè¦å‰‡ã€‚"),
          React.createElement("li", null, "åªè¦æ´»è‘—ï¼ˆä¸çˆ†å€‰ã€ä¸äº‚å‹•ï¼‰ï¼Œæ™‚é–“æœƒå¸¶æˆ‘åˆ°çµ‚é»ã€‚")
        )
      ),

      React.createElement("div", { className:"bg-slate-900 border border-slate-700 rounded-2xl p-4 space-y-2" },
        React.createElement("div", { className:"text-sm font-bold text-slate-200" }, "å¥‘ç´„é‡é»ï¼ˆSOP æ‘˜è¦ï¼‰"),
        React.createElement("ul", { className:"list-disc pl-5 text-sm text-slate-300 space-y-1" },
          React.createElement("li", null, "DCAï¼šæ¯æœˆ 180Uï¼ˆ3ä»½ï¼‰ï¼Œæ¯é€±çœ‹æè²ªåªåŸ·è¡Œè¦å‰‡ã€‚"),
          React.createElement("li", null, "é•·ç‰›ä¿éšªï¼šæè²ª > 75 é€£çºŒ 8 é€±å¾Œï¼Œæ”¹ç‚º 1è²·2å­˜ï¼Œé¿å…è¸ç©ºã€‚"),
          React.createElement("li", null, "é»‘å¤©éµï¼šFNG<20 æˆ– 6M ATHå›æ’¤â‰¥30% æˆ– è·Œç ´200W â†’ é å‚™é‡‘åˆ†4é€±è²·å…¥ã€‚"),
          React.createElement("li", null, "åœæ­¢é»‘å¤©éµï¼šè²·å…¥æœŸé–“åå½ˆ >15% ç«‹å³åœæ­¢ï¼Œä¿ç•™å­å½ˆã€‚"),
          React.createElement("li", null, "å†·éŒ¢åŒ…éµå¾‹ï¼šäº¤æ˜“æ‰€ BTC â‰¥ 0.05 BTC å¿…æé ˜ã€‚"),
          React.createElement("li", null, "90å¤©å›å®¶ï¼šETHâ†’USDT å¾Œï¼Œ90å¤©æœªå›æ’¤é”æ›å–® â†’ å¼·åˆ¶å¸‚åƒ¹æ›å› BTCã€‚")
        )
      ),

      React.createElement("div", { className:"bg-slate-900 border border-slate-700 rounded-2xl p-4 space-y-2" },
        React.createElement("div", { className:"text-sm font-bold text-slate-200" }, "æ†²æ³•ä¿®æ­£æ¢æ¬¾"),
        React.createElement("div", { className:"text-sm text-slate-300 leading-relaxed" },
          "è‹¥æˆ‘åœ¨ 2030 å¹´å‰æƒ³ä¿®æ”¹æœ¬è¨ˆç•«ï¼Œå¿…é ˆå¯«ä¸‹ä¿®æ”¹ç†ç”±ä¸¦å»¶é² 30 å¤©å†åŸ·è¡Œã€‚"
        )
      ),

      React.createElement("div", { className:"bg-slate-900 border border-slate-700 rounded-2xl p-4 space-y-2" },
        React.createElement("div", { className:"text-sm font-bold text-slate-200" }, "è‡ªæˆ‘å¥‘ç´„ï¼ˆæé†’ï¼‰"),
        React.createElement("div", { className:"text-sm text-slate-300 italic leading-relaxed" },
          "ã€Œé€™å¥—ç³»çµ±å·²åŒ…å«æ‰€æœ‰ææ‡¼èˆ‡è²ªå©ªã€‚å¸‚å ´ç˜‹ç‹‚æ™‚å®ƒå«æˆ‘å­˜éŒ¢ï¼›å¸‚å ´å´©ç›¤æ™‚å®ƒå«æˆ‘é€²æ”»ã€‚ã€"
        )
      )
    )
  );

  const ToolsPage = () => (
    React.createElement("div", { className:"bg-slate-800 rounded-2xl p-5 border border-slate-700 space-y-3" },
      React.createElement("div", { className:"text-lg font-extrabold text-sky-300" }, "ğŸ§° å‚™ä»½/å·¥å…·"),
      React.createElement("div", { className:"text-sm text-slate-300" }, "è³‡æ–™å­˜åœ¨æœ¬æ©Ÿï¼›ç”¨ã€åŒ¯å‡º/åŒ¯å…¥ã€å¯è·¨è£ç½®åŒæ­¥ã€‚")
    )
  );

  /* ===== Main Render ===== */
  return React.createElement("div", { className:"min-h-screen pb-safe" },
    React.createElement("div", { className:"sticky top-0 z-10 bg-slate-950/90 backdrop-blur border-b border-slate-800 px-4 py-3" },
      React.createElement("div", { className:"flex items-center justify-between text-xs text-slate-400 mono mb-2" },
        React.createElement("span", null, `LV.${Math.floor(totalBtc*10)} å®ˆè­·è€…`),
        React.createElement("span", null, `${fmt(totalBtc,4)} / ${GOAL_BTC} BTC`)
      ),
      React.createElement("div", { className:"w-full h-3 bg-slate-800 rounded-full overflow-hidden" },
        React.createElement("div", { className:"h-full bg-gradient-to-r from-emerald-600 to-green-400 transition-all", style:{ width: progress + "%" } })
      ),
      React.createElement("div", { className:"text-[10px] text-right text-slate-500 mt-1" },
        `å‰©é¤˜ ${daysLeft} å¤©ï½œæœ¬æœˆä»½é¡ ${state.monthPartsRemaining}/3ï½œç©©å®šå¹£å æ¯”ç´„ ${stablePct.toFixed(1)}%`
      )
    ),

    React.createElement("div", { className:"p-4 space-y-4 max-w-xl mx-auto pb-24" },
      React.createElement("div", { className:"flex gap-2 flex-wrap" },
        React.createElement(Chip, { active: tab==="home", onClick:()=>setTab("home") }, "HOME"),
        React.createElement(Chip, { active: tab==="convert", onClick:()=>setTab("convert") }, "åŒ¯ç‡è½‰æ›"),
        React.createElement(Chip, { active: tab==="orders", onClick:()=>setTab("orders") }, "æ›å–®/90å¤©"),
        React.createElement(Chip, { active: tab==="sop", onClick:()=>setTab("sop") }, "æ†²æ³•"),
        React.createElement(Chip, { active: tab==="tools", onClick:()=>setTab("tools") }, "å‚™ä»½")
      ),

      HeaderCards(),
      tab==="home" && HomePage(),
      tab==="convert" && ConvertPage(),
      tab==="orders" && OrdersPage(),
      tab==="sop" && SopPage(),
      tab==="tools" && ToolsPage(),

      React.createElement("div", { className:"bg-slate-950 rounded-2xl p-4 border border-slate-800" },
        React.createElement("div", { className:"text-xs text-slate-500 mono mb-2" }, "> SYSTEM LOGS"),
        (state.logs.length===0)
          ? React.createElement("div", { className:"text-slate-600 text-sm" }, "ç­‰å¾…æŒ‡ä»¤â€¦")
          : state.logs.slice(0, 20).map(l =>
              React.createElement("div", { key:l.id, className:"text-sm mono border-b border-slate-900 py-2 last:border-0" },
                React.createElement("span", { className:"text-slate-500" }, `[${l.date}] `),
                React.createElement("span", null, l.msg)
              )
            )
      )
    ),

    modal && React.createElement("div", { className:"fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4" },
      React.createElement("div", { className:"w-full max-w-lg bg-slate-900 border border-slate-700 rounded-2xl p-5" },
        React.createElement("div", { className:"text-lg font-black mb-3" }, modal.title || "è¨Šæ¯"),

        (modal.mode==="export") && React.createElement("div", { className:"space-y-3" },
          React.createElement("textarea", { readOnly:true, value: modal.json || "", className:"w-full h-56 bg-black/40 border border-slate-700 rounded-xl p-3 text-xs mono text-slate-200" }),
          React.createElement("button", {
            className:"w-full bg-emerald-600 hover:bg-emerald-700 rounded-xl py-3 font-bold",
            onClick: async ()=> {
              const ok = await copyToClipboard(modal.json || "");
              setModal({ mode:"info", title:"å·²è¤‡è£½", body: ok ? "å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚" : "è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚" });
            }
          }, "ä¸€éµè¤‡è£½")
        ),

        (modal.mode==="import") && React.createElement("div", { className:"space-y-3" },
          React.createElement("textarea", { id:"importBox", placeholder:"è²¼ä¸Š JSONâ€¦", className:"w-full h-56 bg-black/40 border border-slate-700 rounded-xl p-3 text-xs mono text-slate-200" }),
          React.createElement("button", {
            className:"w-full bg-sky-600 hover:bg-sky-700 rounded-xl py-3 font-bold",
            onClick: ()=> {
              const el = document.getElementById("importBox");
              importBackup(el ? el.value : "");
            }
          }, "åŒ¯å…¥ä¸¦è¦†è“‹")
        ),

        (modal.mode==="eth_stage1") && React.createElement("div", { className:"space-y-3" },
          React.createElement("div", { className:"text-sm text-slate-300" }, "ä¸€éšï¼š5ETHâ†’BTC + 5ETHâ†’USDTï¼ˆå›æ’¤15%ï¼‰"),
          React.createElement("input", { className:"w-full bg-black/40 border border-slate-700 rounded-xl px-3 py-3 text-sm mono", placeholder:"5ETHâ†’BTCï¼ˆä¾‹å¦‚0.3000ï¼‰", onInput:(e)=>{ ethStageBtcRef.current = e.target.value; } }),
          React.createElement("input", { className:"w-full bg-black/40 border border-slate-700 rounded-xl px-3 py-3 text-sm mono", placeholder:"5ETHâ†’USDTï¼ˆä¾‹å¦‚12000ï¼‰", onInput:(e)=>{ ethStageUsdtRef.current = e.target.value; } }),
          React.createElement("button", { className:"w-full bg-emerald-600 hover:bg-emerald-700 rounded-xl py-3 font-bold", onClick:()=>confirmEthMixed(1) }, "ç¢ºèªåŸ·è¡Œ")
        ),

        (modal.mode==="eth_stage2") && React.createElement("div", { className:"space-y-3" },
          React.createElement("div", { className:"text-sm text-slate-300" }, "äºŒéšï¼š6ETHâ†’BTC + 6ETHâ†’USDTï¼ˆå›æ’¤20%ï¼‰"),
          React.createElement("input", { className:"w-full bg-black/40 border border-slate-700 rounded-xl px-3 py-3 text-sm mono", placeholder:"6ETHâ†’BTCï¼ˆä¾‹å¦‚0.3600ï¼‰", onInput:(e)=>{ ethStageBtcRef.current = e.target.value; } }),
          React.createElement("input", { className:"w-full bg-black/40 border border-slate-700 rounded-xl px-3 py-3 text-sm mono", placeholder:"6ETHâ†’USDTï¼ˆä¾‹å¦‚15000ï¼‰", onInput:(e)=>{ ethStageUsdtRef.current = e.target.value; } }),
          React.createElement("button", { className:"w-full bg-emerald-600 hover:bg-emerald-700 rounded-xl py-3 font-bold", onClick:()=>confirmEthMixed(2) }, "ç¢ºèªåŸ·è¡Œ")
        ),

        (modal.mode==="info" || !modal.mode) && React.createElement("pre", { className:"text-sm text-slate-200 whitespace-pre-wrap leading-relaxed mono" }, modal.body || ""),

        React.createElement("button", { onClick:()=>setModal(null), className:"mt-4 w-full bg-slate-700 hover:bg-slate-600 rounded-xl py-3 font-bold" }, "é—œé–‰")
      )
    )
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(React.createElement(App));
</script>
</body>
</html>
