<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <title>Project 2030ï¼šåŸ·è¡Œæ†²æ³• v3</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body { background-color:#0b1220; color:#f1f5f9; -webkit-tap-highlight-color:transparent;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .pb-safe { padding-bottom: calc(90px + env(safe-area-inset-bottom)); }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

    @keyframes pulse-green {
      0% { box-shadow: 0 0 0 0 rgba(16,185,129,0.7); }
      70% { box-shadow: 0 0 0 10px rgba(16,185,129,0); }
      100% { box-shadow: 0 0 0 0 rgba(16,185,129,0); }
    }
    .animate-pulse-green { animation: pulse-green 2s infinite; }

    @keyframes fade-in { from { opacity: 0; transform: translateY(4px);} to { opacity: 1; transform: translateY(0);} }
    .animate-fade-in { animation: fade-in .25s ease-out both; }
  </style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
const { useEffect, useMemo, useRef, useState } = React;

/* ===== Constants ===== */
const GOAL_BTC = 3.0;
const TARGET_DATE = new Date("2030-12-31T00:00:00+08:00").getTime();
const SAVE_KEY = "p2030_v3_store"; 

const PART = 60;
const MONTH_PARTS = 3;
const GREED_WEEKS_FOR_INSURANCE = 8;
const BLACK_SWAN_WEEKS = 4;
const BLACK_SWAN_STOP_REBOUND = 15;

const ETH_SNIPE_RATIO = 0.058;
const ADA_SNIPE_RATIO = 0.0000085;
const ETH_ALERT_RATIO = 0.045;
const ADA_ALERT_RATIO = 0.000008;

/* ===== Helpers ===== */
const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
const parseNum = (s, fallback = NaN) => {
  const n = Number(String(s ?? "").replace(/,/g,"").trim());
  return Number.isFinite(n) ? n : fallback;
};
const fmt = (n, d=4) => Number(n||0).toFixed(d);
const monthKeyNow = () => {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
};
const todayMMDD = () => new Date().toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit'});
const reboundPctFrom = (low, now) => (low > 0 && now > 0) ? ((now - low) / low) * 100 : 0;

// è§£æã€Œå¯èƒ½ä¸æ˜¯ç´” JSONã€çš„å›æ‡‰ï¼ˆjina å¯èƒ½å›æ–‡å­—ï¼‰
const parseLooseJson = (text) => {
  const s = String(text || "");
  const i1 = s.indexOf("{");
  const i2 = s.indexOf("[");
  let i = -1;
  if (i1 === -1) i = i2;
  else if (i2 === -1) i = i1;
  else i = Math.min(i1, i2);
  if (i < 0) throw new Error("JSON not found");
  return JSON.parse(s.slice(i).trim());
};

const sleep = (ms) => new Promise(r => setTimeout(r, ms));

/* ===== Initial State ===== */
const initialStateNow = () => ({
  btcHot: 0.0,
  btcCold: 0.0,
  usdtReserve: 0,

  eth: 34.0,
  ada: 74000.0,

  ethStaked: true,
  adaStaked: true,

  logs: [],
  consecutiveGreedWeeks: 0,

  monthPartsRemaining: MONTH_PARTS,
  lastMonthKey: monthKeyNow(),

  blackSwan: {
    active: false,
    remainingWeeks: 0,
    weeklyBudget: 0,
    startedAtISO: null,
    reason: null,
    anchorPrice: 0,
    lowPrice: 0
  }
});

/* ===== Main Component ===== */
function App() {
  const [state, setState] = useState(initialStateNow());
  const [tab, setTab] = useState("home"); // home | convert | sop
  const [modal, setModal] = useState(null);

  // Uncontrolled inputs refs (avoid iOS keyboard collapse)
  const draftRef = useRef({
    btcPrice: "90000",
    fngIndex: "50",
    ethBtcRatio: "0.050",
    adaBtcRatio: "0.000008",
    athDrawdownPct: "0",
    below200w: "0",
    reboundPct: "0",
    extraReserveAdd: "0"
  });

  const [ui, setUi] = useState({
    btcPrice: 90000,
    fngIndex: 50,
    ethBtcRatio: 0.050,
    adaBtcRatio: 0.000008,
    athDrawdownPct: 0,
    below200w: 0,
    reboundPct: 0,
    ma200w: 0,
    dataSource: "Manual"
  });

  const addLog = (msg, type="info") => {
    const log = { id: Date.now() + Math.random(), date: todayMMDD(), msg, type };
    setState(prev => ({ ...prev, logs: [log, ...prev.logs].slice(0, 200) }));
  };

  // Load/Save Logic
  useEffect(() => {
    try {
      const saved = localStorage.getItem(SAVE_KEY);
      if(saved) {
        const parsed = JSON.parse(saved);

        // âœ… èˆŠç‰ˆæ¬„ä½æ¸…ç†ï¼ˆæ›¾ç¶“æœ‰ pendingOrders / orders é ï¼‰
        if (parsed && typeof parsed === "object") {
          delete parsed.pendingOrders;
          delete parsed.orders;
        }
        setState({ ...initialStateNow(), ...parsed });
      } else {
        addLog("ç³»çµ±åˆå§‹åŒ–å®Œæˆ (v3 JSX æœ€çµ‚ç‰ˆ)", "system");
      }
    } catch(e) { console.error(e); }
    // eslint-disable-next-line
  }, []);

  useEffect(() => {
    try { localStorage.setItem(SAVE_KEY, JSON.stringify(state)); } catch(e){}
  }, [state]);

  // Derived Values
  const totalBtc = state.btcHot + state.btcCold;
  const progress = clamp((totalBtc / GOAL_BTC) * 100, 0, 100);
  const daysLeft = Math.max(0, Math.ceil((TARGET_DATE - Date.now())/(1000*60*60*24)));

  // Update inputs helper
  const updateInput = (name, val) => {
    draftRef.current[name] = String(val);
    const el = document.getElementById(name);
    if(el) el.value = String(val);
  };

  // Safe numeric update
  const applyUiNumber = (key, raw, fallback) => {
    let n = parseNum(raw, fallback);
    if (!Number.isFinite(n)) n = fallback;
    setUi(p => ({ ...p, [key]: n }));
    return n;
  };

  /* ===== API Logic (robust) ===== */
  const fetchTextWithTimeout = async (url, ms) => {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), ms);
    try {
      const res = await fetch(url, { cache:"no-store", signal: ctrl.signal });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.text();
    } finally { clearTimeout(t); }
  };

  const fetchJsonSmart = async (url) => {
    // direct -> allorigins -> jina
    try { return parseLooseJson(await fetchTextWithTimeout(url, 9000)); } catch(e) {}
    try { return parseLooseJson(await fetchTextWithTimeout("https://api.allorigins.win/raw?url=" + encodeURIComponent(url), 12000)); } catch(e) {}
    // jina çš„æ ¼å¼ï¼šhttps://r.jina.ai/http(s)://...
    const j = "https://r.jina.ai/http://" + url.replace(/^https?:\/\//, "");
    return parseLooseJson(await fetchTextWithTimeout(j, 15000));
  };

  const withRetry = async (fn, tries=3) => {
    let last = null;
    for (let i=0;i<tries;i++){
      try { return await fn(); }
      catch(e){ last = e; await sleep([600,1400,2600][i] ?? 2600); }
    }
    throw last;
  };

  // 200W MA
  const calc200wMA = async (srcHint) => {
    // 1) CryptoCompare histoweek
    try{
      const cc = await withRetry(() => fetchJsonSmart("https://min-api.cryptocompare.com/data/v2/histoweek?fsym=BTC&tsym=USD&limit=220"), 2);
      if (cc?.Response === "Error") throw new Error(cc?.Message || "CC Error");
      const arr = cc?.Data?.Data || [];
      const closes = arr.map(x=>Number(x?.close)||0).filter(x=>x>0);
      if (closes.length >= 200) {
        const last200 = closes.slice(-200);
        const ma = last200.reduce((s,x)=>s+x,0) / last200.length;
        if (Number.isFinite(ma) && ma>0) return ma;
      }
    }catch(e){}

    // 2) CoinGecko 2000 days daily
    const cg = await withRetry(() => fetchJsonSmart("https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=2000&interval=daily"), 2);
    const prices = (cg?.prices||[]).map(p=>Number(p?.[1])||0).filter(x=>x>0);
    if (prices.length < 800) return 0;
    const last1400 = prices.length>1400 ? prices.slice(-1400) : prices;
    const ma = last1400.reduce((s,x)=>s+x,0) / last1400.length;
    return (Number.isFinite(ma) && ma>0) ? ma : 0;
  };

  // 6M ATH drawdown (%)
  const calc6mDD = async (nowPrice) => {
    // 1) CryptoCompare histoday highs
    try{
      const cc = await withRetry(() => fetchJsonSmart("https://min-api.cryptocompare.com/data/v2/histoday?fsym=BTC&tsym=USD&limit=200"), 2);
      if (cc?.Response === "Error") throw new Error(cc?.Message || "CC Error");
      const arr = cc?.Data?.Data || [];
      const highs = arr.map(x=>Number(x?.high)||0).filter(x=>x>0);
      if (highs.length >= 30 && nowPrice>0) {
        const hi = Math.max(...highs.slice(-180));
        if (hi>0) return Math.max(0, ((hi-nowPrice)/hi)*100);
      }
    }catch(e){}

    // 2) CoinGecko 200 days
    const cg = await withRetry(() => fetchJsonSmart("https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=200&interval=daily"), 2);
    const prices = (cg?.prices||[]).map(p=>Number(p?.[1])||0).filter(x=>x>0);
    if (prices.length < 30 || !(nowPrice>0)) return 0;
    const hi = Math.max(...prices);
    return hi>0 ? Math.max(0, ((hi-nowPrice)/hi)*100) : 0;
  };

  const autofillFromApis = async () => {
    addLog("æ­£åœ¨é€£æ¥è¡›æ˜Ÿæ•¸æ“š...", "system");
    try {
      // 1) FNG
      const fngData = await withRetry(() => fetchJsonSmart("https://api.alternative.me/fng/?limit=1&format=json"), 2);
      const fng = clamp(parseInt(fngData?.data?.[0]?.value ?? "50", 10), 0, 100);

      // 2) Prices (CC first -> CG fallback)
      let btc=0, eth=0, ada=0, src="CC";
      try {
        const cc = await withRetry(() => fetchJsonSmart("https://min-api.cryptocompare.com/data/pricemulti?fsyms=BTC,ETH,ADA&tsyms=USD"), 2);
        if(cc?.BTC?.USD) { btc = cc.BTC.USD; eth = cc.ETH.USD; ada = cc.ADA.USD; }
        else throw new Error("CC fail");
      } catch(e) {
        src="CG";
        const cg = await withRetry(() => fetchJsonSmart("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,cardano&vs_currencies=usd"), 2);
        btc = cg?.bitcoin?.usd ?? 0;
        eth = cg?.ethereum?.usd ?? 0;
        ada = cg?.cardano?.usd ?? 0;
      }
      if(!(btc>0)) throw new Error("No Price Data");

      // 3) 200W + 6M DD
      const ma200w = await calc200wMA(src);
      const below200w = (ma200w>0 && btc < ma200w) ? 1 : 0;
      const dd6m = await calc6mDD(btc);

      // 4) Update UI + inputs
      updateInput("btcPrice", Math.round(btc));
      updateInput("fngIndex", fng);

      if(eth>0) updateInput("ethBtcRatio", (eth/btc).toFixed(5));
      if(ada>0) updateInput("adaBtcRatio", (ada/btc).toFixed(7));

      updateInput("athDrawdownPct", dd6m.toFixed(2));
      updateInput("below200w", String(below200w));

      setUi(p => ({
        ...p,
        btcPrice: Number(btc),
        fngIndex: Number(fng),
        ethBtcRatio: eth>0 ? (eth/btc) : p.ethBtcRatio,
        adaBtcRatio: ada>0 ? (ada/btc) : p.adaBtcRatio,
        athDrawdownPct: Number(dd6m.toFixed(2)),
        ma200w: ma200w,
        below200w: below200w,
        dataSource: src
      }));

      addLog(`æ•¸æ“šæ›´æ–°æˆåŠŸ (${src})`, "success");

      // Sniper Alert
      if(eth/btc >= ETH_ALERT_RATIO) addLog(`ETH/BTC æ¥è¿‘è­¦æˆ’å€¼ (${(eth/btc).toFixed(5)})`, "alert");
      if(ada/btc >= ADA_ALERT_RATIO) addLog(`ADA/BTC æ¥è¿‘è­¦æˆ’å€¼ (${(ada/btc).toFixed(7)})`, "alert");

    } catch(e) {
      console.error(e);
      addLog("è‡ªå‹•æŠ“å–å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥", "warning");
    }
  };  /* ===== Actions ===== */
  const executeWeekly = () => {
    const price = parseNum(ui.btcPrice, 0);
    const fng = clamp(parseNum(ui.fngIndex, 50), 0, 100);
    if(!(price>0)) return setModal({title:"éŒ¯èª¤", body:"è«‹è¼¸å…¥æœ‰æ•ˆçš„ BTC åƒ¹æ ¼"});

    // Month Logic
    const nowKey = monthKeyNow();
    let parts = state.monthPartsRemaining;
    let newMonth = false;
    let lastMonthKey = state.lastMonthKey;

    if(state.lastMonthKey !== nowKey) {
      parts = MONTH_PARTS;
      newMonth = true;
      lastMonthKey = nowKey;
    }

    // DCA Strategy
    let action = "", spend=0, save=0, greed = state.consecutiveGreedWeeks;

    if(fng < 20) { action="æ¥µåº¦ææ…Œ (A)ï¼š3è²·0å­˜"; spend=3; save=0; greed=0; }
    else if(fng <= 40) { action="ææ‡¼ (B)ï¼š2è²·1å­˜"; spend=2; save=1; greed=0; }
    else if(fng <= 75) { action="ä¸­æ€§ (C)ï¼š1è²·2å­˜"; spend=1; save=2; greed=0; }
    else {
      if(greed >= GREED_WEEKS_FOR_INSURANCE) {
        action="è²ªå©ª (D)ã€é•·ç‰›ä¿éšªã€‘ï¼š1è²·2å­˜"; spend=1; save=2; greed++;
      } else {
        action="è²ªå©ª (D)ï¼š0è²·3å­˜"; spend=0; save=3; greed++;
      }
    }

    // Check Month Parts Budget
    if(spend + save > parts) {
      const available = parts;
      if(spend > available) { spend = available; save = 0; } 
      else { save = available - spend; }
      action += `ï¼ˆä»½é¡é™åˆ¶ï¼š${available}/3ï¼‰`;
    }

    const usdtSpent = spend * PART;
    const usdtSaved = save * PART;

    // ===== Black Swan (Chapter 3) =====
    const athDD = clamp(parseNum(ui.athDrawdownPct, 0), 0, 100);
    const below200w = Number(ui.below200w||0) === 1;
    const blackSwanTriggered = (fng < 20) || (athDD >= 30) || below200w;

    let blackSwan = { ...state.blackSwan };
    let reserveAfterSave = (state.usdtReserve || 0) + usdtSaved;
    let blackSwanSpent = 0;

    // If active: update lowPrice and rebound
    if (blackSwan.active){
      const prevLow = blackSwan.lowPrice > 0 ? blackSwan.lowPrice : price;
      const newLow = Math.min(prevLow, price);
      const rb = reboundPctFrom(newLow, price);

      blackSwan.lowPrice = newLow;
      setUi(p=>({ ...p, reboundPct: Number(rb.toFixed(2)) }));
      updateInput("reboundPct", rb.toFixed(2));

      if (rb > BLACK_SWAN_STOP_REBOUND){
        blackSwan.active = false;
        blackSwan.remainingWeeks = 0;
        addLog(`é»‘å¤©éµåœæ­¢ï¼šåå½ˆ ${rb.toFixed(2)}% > ${BLACK_SWAN_STOP_REBOUND}%`, "warning");
      }
    }

    // Start black swan
    if(!blackSwan.active && blackSwanTriggered){
      if(reserveAfterSave > 0){
        const reason = (fng < 20) ? "FNG<20" : (athDD >= 30 ? "6Må›æ’¤>=30%" : "è·Œç ´200W");
        blackSwan = {
          active: true,
          remainingWeeks: BLACK_SWAN_WEEKS,
          weeklyBudget: reserveAfterSave / BLACK_SWAN_WEEKS,
          startedAtISO: new Date().toISOString(),
          reason,
          anchorPrice: price,
          lowPrice: price
        };
        addLog(`é»‘å¤©éµå•Ÿå‹•ï¼š${reason}ï½œé å‚™é‡‘åˆ†4é€±è²·å…¥`, "alert");
      }
    }

    // Black swan buy this "weekly press"
    if(blackSwan.active && blackSwan.remainingWeeks > 0){
      const spendNow = Math.max(0, Math.min(reserveAfterSave, blackSwan.weeklyBudget));
      if(spendNow > 0){
        blackSwanSpent = spendNow;
        reserveAfterSave -= spendNow;
        blackSwan.remainingWeeks -= 1;
        addLog(`é»‘å¤©éµè²·å…¥ï¼šå‹•ç”¨ ${Math.floor(spendNow)}Uï¼ˆå‰© ${blackSwan.remainingWeeks} é€±ï¼‰`, "success");
      }
      if(blackSwan.remainingWeeks <= 0){
        blackSwan.active = false;
        addLog("é»‘å¤©éµçµæŸï¼š4é€±è²·å…¥å®Œæˆ", "system");
      }
    }

    const totalSpent = usdtSpent + blackSwanSpent;
    const btcBought = totalSpent > 0 ? (totalSpent / price) : 0;

    // State Update
    const newState = {
      ...state,
      btcHot: (state.btcHot || 0) + btcBought,
      usdtReserve: reserveAfterSave,
      consecutiveGreedWeeks: greed,
      monthPartsRemaining: Math.max(0, parts - spend - save),
      lastMonthKey: lastMonthKey,
      blackSwan
    };

    setState(newState);

    addLog(`é€±å ±åŸ·è¡Œï¼š${action}`, usdtSpent > 0 ? "success" : "warning");
    if(newMonth) addLog("æ–°æœˆä»½é¡åº¦å·²é‡ç½® (3/3)", "system");
    if(usdtSaved>0) addLog(`å­˜å…¥é å‚™é‡‘ï¼š+${usdtSaved}U`, "info");
    if(totalSpent>0) addLog(`æœ¬é€±æŠ•å…¥ï¼š${Math.floor(totalSpent)}U â†’ ${btcBought.toFixed(6)} BTC`, "success");

    setModal({
      title: "åŸ·è¡Œå ±å‘Š",
      body: (
        <div className="space-y-2">
          <div className="text-emerald-400 font-bold">{action}</div>
          <div className="grid grid-cols-2 gap-2 text-sm">
            <span>æŠ•å…¥: ${Math.floor(usdtSpent)}</span>
            <span>å­˜å…¥: ${Math.floor(usdtSaved)}</span>
            <span>é»‘å¤©éµ: ${Math.floor(blackSwanSpent)}</span>
            <span>å‰©ä»½é¡: {newState.monthPartsRemaining}/3</span>
            <span className="col-span-2">è²·å…¥: {btcBought.toFixed(6)} BTC</span>
          </div>
        </div>
      )
    });
  };

  const moveCold = () => {
    if(state.btcHot < 0.05) return setModal({title:"æ‹’çµ•", body:"æœªé” 0.05 BTC é–€æª»"});
    const amt = state.btcHot;
    setState(p => ({ ...p, btcCold: p.btcCold + amt, btcHot: 0 }));
    addLog(`æé ˜ ${fmt(amt,6)} BTC è‡³å†·éŒ¢åŒ…`, "secure");
  };

  const addReserve = () => {
    const add = Math.max(0, Math.floor(parseNum(draftRef.current.extraReserveAdd, 0)));
    if(!(add>0)) return setModal({title:"éŒ¯èª¤", body:"è«‹è¼¸å…¥è¦åŠ å…¥çš„é å‚™é‡‘ï¼ˆæ­£æ•´æ•¸ï¼‰"});
    setState(p => ({ ...p, usdtReserve: (p.usdtReserve||0) + add }));
    addLog(`æ‰‹å‹•è£œå……é å‚™é‡‘ï¼š+${add} U`, "success");
    draftRef.current.extraReserveAdd = "0";
    updateInput("extraReserveAdd", "0");
  };

  // ç‹™æ“Šï¼šåˆ°åƒ¹æ‰å¯æŒ‰ï¼Œè¼¸å…¥å¯¦å¾— BTC
  const snipeConvert = (asset) => {
    const ratio = asset==="ETH" ? Number(ui.ethBtcRatio||0) : Number(ui.adaBtcRatio||0);
    const target = asset==="ETH" ? ETH_SNIPE_RATIO : ADA_SNIPE_RATIO;

    if(ratio < target){
      return setModal({title:"æœªé”é–€æª»", body:`${asset}/BTC éœ€ â‰¥ ${target}ï¼ˆç›®å‰ ${ratio}ï¼‰`});
    }

    const holding = asset==="ETH" ? state.eth : state.ada;
    if(!(holding>0)) return setModal({title:"è³‡ç”¢ä¸è¶³", body:`ç›®å‰ ${asset} æŒæœ‰ç‚º 0`});

    const got = prompt(`${asset} ç‹™æ“Šï¼šå…¨æ•¸æ› BTC\nè«‹è¼¸å…¥å¯¦éš›æ›åˆ°çš„ BTC æ•¸é‡ï¼š`, "");
    if(!got) return;
    const btc = parseNum(got, NaN);
    if(!(btc>0)) return setModal({title:"è¼¸å…¥éŒ¯èª¤", body:"BTC å¿…é ˆ > 0"});

    setState(p => ({
      ...p,
      btcHot: (p.btcHot||0) + btc,
      eth: asset==="ETH" ? 0 : p.eth,
      ada: asset==="ADA" ? 0 : p.ada
    }));
    addLog(`[ç‹™æ“Šæ‰‹] ${asset} â†’ BTC +${btc.toFixed(6)}ï¼ˆratio=${ratio}ï¼‰`, "success");
    setModal({title:"å®Œæˆ", body:`å·²å®Œæˆ ${asset} ç‹™æ“Šæ› BTCï¼š+${btc.toFixed(6)} BTC`});
  };

  /* ===== Components ===== */
  const Card = ({children, className=""}) => (
    <div className={`bg-slate-800 border border-slate-700 rounded-2xl p-4 shadow-lg ${className}`}>
      {children}
    </div>
  );

  const Battery = ({level}) => (
    <div className="flex gap-1">
      {[1,2,3].map(i => (
        <div key={i} className={`h-3 w-6 rounded-sm border border-slate-600 ${
          i <= level ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]' : 'bg-slate-800'
        }`} />
      ))}
    </div>
  );

  const TabBtn = ({id, label}) => (
    <button 
      onClick={() => setTab(id)}
      className={`flex-1 py-3 text-sm font-bold rounded-xl transition-all ${
        tab === id ? 'bg-slate-700 text-emerald-400' : 'text-slate-500 hover:bg-slate-800'
      }`}
    >
      {label}
    </button>
  );

  const InputField = ({id, label, defaultVal, onCommit}) => (
    <div className="space-y-1">
      <label className="text-xs text-slate-400 ml-1">{label}</label>
      <input
        id={id}
        type="text"
        inputMode="decimal"
        defaultValue={defaultVal}
        onInput={(e)=>{ draftRef.current[id] = e.target.value; }}
        onBlur={(e)=> onCommit(e.target.value)}
        className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-lg font-mono
                   focus:outline-none focus:border-emerald-500 transition-colors"
        autoCorrect="off" autoCapitalize="off" spellCheck={false}
      />
    </div>
  );

  /* ===== Render ===== */
  const totalBtcLabel = fmt(totalBtc);
  const fngBucket =
    ui.fngIndex < 20 ? {label:"æ¥µåº¦ææ…Œ", cls:"text-red-400"} :
    ui.fngIndex <= 40 ? {label:"ææ‡¼", cls:"text-yellow-400"} :
    ui.fngIndex <= 75 ? {label:"ä¸­æ€§/åè²ª", cls:"text-slate-300"} :
    {label:"è²ªå©ª", cls:"text-emerald-400"};  return (
    <div className="min-h-screen pb-safe">
      {/* Sticky Header */}
      <div className="sticky top-0 z-20 bg-slate-900/90 backdrop-blur border-b border-slate-800 px-4 py-3 shadow-2xl">
        <div className="flex justify-between items-end mb-2">
          <div>
            <div className="text-[10px] text-slate-500 tracking-widest uppercase">Project 2030</div>
            <div className="text-xl font-black font-mono tracking-tight text-white">
              {totalBtcLabel} <span className="text-sm text-slate-500">/ {GOAL_BTC} BTC</span>
            </div>
          </div>
          <div className="text-right">
            <div className="text-[10px] text-slate-500">å‰©é¤˜å¤©æ•¸</div>
            <div className="text-sm font-bold text-emerald-400">{daysLeft} å¤©</div>
          </div>
        </div>
        <div className="h-2 bg-slate-800 rounded-full overflow-hidden">
          <div className="h-full bg-gradient-to-r from-emerald-600 to-green-400 transition-all duration-1000" style={{width: `${progress}%`}} />
        </div>
      </div>

      <div className="p-4 space-y-4 max-w-lg mx-auto">
        {/* Asset Dashboard */}
        <div className="grid grid-cols-2 gap-3">
          <Card className="relative overflow-hidden group">
            <div className="text-xs text-slate-400">ç†±éŒ¢åŒ… (Hot)</div>
            <div className="text-xl font-mono font-bold text-emerald-300">{fmt(state.btcHot)}</div>
            {state.btcHot >= 0.05 && (
              <button onClick={moveCold} className="mt-2 w-full text-xs bg-emerald-900/50 text-emerald-400 border border-emerald-800 rounded py-1 animate-pulse">
                å¯æé ˜è‡³å†·éŒ¢åŒ…
              </button>
            )}
          </Card>
          <Card>
            <div className="text-xs text-slate-400">å†·éŒ¢åŒ… (Cold)</div>
            <div className="text-xl font-mono font-bold text-blue-300">{fmt(state.btcCold)}</div>
            <div className="text-[10px] text-slate-500 mt-1">çµ•å°é˜²ç¦¦é ˜åŸŸ</div>
          </Card>
        </div>

        <Card className="flex justify-between items-center bg-gradient-to-r from-slate-800 to-slate-800/50">
          <div>
            <div className="text-xs text-yellow-500/80 mb-1">é»‘å¤©éµé å‚™é‡‘ (USDT)</div>
            <div className="text-2xl font-mono font-bold text-yellow-400">${Math.floor(state.usdtReserve).toLocaleString()}</div>
            <div className="mt-2 flex gap-2">
              <input
                id="extraReserveAdd"
                defaultValue={draftRef.current.extraReserveAdd}
                inputMode="numeric"
                onInput={(e)=>{ draftRef.current.extraReserveAdd = e.target.value; }}
                className="w-28 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm font-mono"
                placeholder="åŠ é å‚™é‡‘"
              />
              <button onClick={addReserve} className="px-3 py-2 text-sm font-bold rounded-lg bg-emerald-700 hover:bg-emerald-600">
                åŠ å…¥
              </button>
            </div>
          </div>
          <div className="text-right">
            <div className="text-[10px] text-slate-500 mb-1">æœ¬æœˆä»½é¡</div>
            <Battery level={state.monthPartsRemaining} />
            <div className="text-[10px] text-slate-500 mt-2">è³‡æ–™æºï¼š{ui.dataSource}</div>
          </div>
        </Card>

        {/* Navigation */}
        <div className="flex bg-slate-900 p-1 rounded-2xl border border-slate-800">
          <TabBtn id="home" label="è¡Œå‹•ä¸­å¿ƒ" />
          <TabBtn id="convert" label="ç‹™æ“Šæ¨¡å¼" />
          <TabBtn id="sop" label="æ†²æ³•" />
        </div>

        {/* Tab Content */}
        {tab === "home" && (
          <div className="space-y-4 animate-fade-in">
            <Card>
              <div className="flex justify-between items-center mb-4">
                <h3 className="font-bold text-white flex items-center gap-2">
                  <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse-green"></span>
                  æ¯é€±æ±ºç­–
                </h3>
                <button onClick={autofillFromApis} className="text-xs bg-slate-700 px-3 py-1.5 rounded-lg text-slate-300 active:scale-95 transition-transform">
                  ğŸ“¡ æ›´æ–°æ•¸æ“š
                </button>
              </div>

              <div className="grid grid-cols-2 gap-4 mb-4">
                <InputField
                  id="btcPrice"
                  label="BTC åƒ¹æ ¼"
                  defaultVal={draftRef.current.btcPrice}
                  onCommit={(v)=>{
                    updateInput("btcPrice", v);
                    applyUiNumber("btcPrice", v, ui.btcPrice);
                  }}
                />
                <InputField
                  id="fngIndex"
                  label="æè²ªæŒ‡æ•¸"
                  defaultVal={draftRef.current.fngIndex}
                  onCommit={(v)=>{
                    const n = clamp(Math.round(parseNum(v, ui.fngIndex)), 0, 100);
                    updateInput("fngIndex", n);
                    setUi(p=>({ ...p, fngIndex: n }));
                  }}
                />
              </div>

              {/* å¯æ‹–æ‹‰æè²ªï¼šä¸ç”¨éµç›¤ */}
              <div className="bg-slate-900/50 rounded-xl p-3 mb-4 border border-slate-700/50">
                <div className="flex justify-between text-xs text-slate-400 mb-2">
                  <span>æè²ªå€é–“</span>
                  <span className={fngBucket.cls}>{fngBucket.label}</span>
                </div>
                <input
                  type="range" min="0" max="100" value={ui.fngIndex}
                  onChange={(e)=>{
                    const n = clamp(parseInt(e.target.value,10)||0, 0, 100);
                    setUi(p=>({ ...p, fngIndex: n }));
                    updateInput("fngIndex", n);
                  }}
                  className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                />
              </div>

              <button onClick={executeWeekly} className="w-full py-4 bg-emerald-600 hover:bg-emerald-500 active:bg-emerald-700 text-white font-bold rounded-xl shadow-lg shadow-emerald-900/20 transition-all active:scale-[0.98]">
                åŸ·è¡ŒæŒ‡ä»¤ (EXECUTE)
              </button>
            </Card>

            {/* Black Swan Monitor */}
            <Card className={(ui.athDrawdownPct >= 30 || Number(ui.below200w)===1 || ui.fngIndex<20) ? "border-red-500/50 bg-red-900/10" : "opacity-90"}>
              <div className="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">é¢¨éšªç›£æ§ (é»‘å¤©éµ)</div>
              <div className="grid grid-cols-3 gap-2 text-center">
                <div className="bg-slate-900 p-2 rounded-lg">
                  <div className="text-[10px] text-slate-500">6M å›æ’¤</div>
                  <div className={`font-mono font-bold ${ui.athDrawdownPct>=30 ? 'text-red-400' : 'text-slate-300'}`}>{Number(ui.athDrawdownPct).toFixed(2)}%</div>
                </div>
                <div className="bg-slate-900 p-2 rounded-lg">
                  <div className="text-[10px] text-slate-500">200W</div>
                  <div className="font-mono font-bold text-slate-300">
                    {ui.ma200w>0 ? Math.round(ui.ma200w).toLocaleString() : "?"}
                  </div>
                </div>
                <div className="bg-slate-900 p-2 rounded-lg">
                  <div className="text-[10px] text-slate-500">è·Œç ´200W</div>
                  <div className={`font-mono font-bold ${Number(ui.below200w)===1 ? 'text-red-400' : 'text-slate-300'}`}>
                    {Number(ui.below200w)===1 ? "æ˜¯" : "å¦"}
                  </div>
                </div>
              </div>

              <div className="mt-3 grid grid-cols-2 gap-2 text-center">
                <div className="bg-slate-900 p-2 rounded-lg">
                  <div className="text-[10px] text-slate-500">FNG</div>
                  <div className={`font-mono font-bold ${ui.fngIndex<20 ? 'text-red-400' : 'text-slate-300'}`}>{ui.fngIndex}</div>
                </div>
                <div className="bg-slate-900 p-2 rounded-lg">
                  <div className="text-[10px] text-slate-500">åå½ˆ%</div>
                  <div className={`font-mono font-bold ${Number(ui.reboundPct)>15 ? 'text-red-400' : 'text-slate-300'}`}>{Number(ui.reboundPct).toFixed(2)}%</div>
                </div>
              </div>

              {/* æ‰‹å‹•åˆ‡ below200wï¼ˆæŠ“ä¸åˆ°æ™‚å¯ç”¨ï¼‰ */}
              <div className="mt-3 flex justify-between items-center bg-slate-900/60 border border-slate-700/50 rounded-xl px-3 py-2">
                <div className="text-xs text-slate-400">æ‰‹å‹•åˆ‡æ›ï¼šè·Œç ´ 200W</div>
                <button
                  onClick={()=> {
                    const next = Number(ui.below200w||0)===1 ? 0 : 1;
                    setUi(p=>({ ...p, below200w: next }));
                    updateInput("below200w", next);
                    addLog(`æ‰‹å‹•è¨­å®šï¼šè·Œç ´200W=${next? "ON":"OFF"}`, "system");
                  }}
                  className={`px-3 py-1.5 rounded-lg text-xs font-bold ${Number(ui.below200w)===1 ? "bg-red-600/80" : "bg-slate-700"}`}
                >
                  {Number(ui.below200w)===1 ? "ON" : "OFF"}
                </button>
              </div>
            </Card>
          </div>
        )}

        {tab === "convert" && (
          <div className="space-y-4 animate-fade-in">
            <Card className="border-l-4 border-l-fuchsia-500">
              <h3 className="font-bold text-fuchsia-400 mb-2">ETH ç‹™æ“Šæ‰‹</h3>
              <div className="flex justify-between items-end mb-2">
                <div className="text-xs text-slate-400">ç•¶å‰åŒ¯ç‡: <span className="text-white font-mono">{Number(ui.ethBtcRatio).toFixed(5)}</span></div>
                <div className="text-xs text-slate-400">ç›®æ¨™: <span className="text-fuchsia-300 font-mono">{ETH_SNIPE_RATIO}</span></div>
              </div>
              <div className="h-2 bg-slate-900 rounded-full overflow-hidden mb-3">
                <div className="h-full bg-fuchsia-600 transition-all" style={{width: `${Math.min(100, (Number(ui.ethBtcRatio)/ETH_SNIPE_RATIO)*100)}%`}} />
              </div>
              <div className="text-xs text-slate-500 leading-relaxed bg-slate-900 p-2 rounded mb-3">
                æŒæœ‰ {fmt(state.eth, 2)} ETHã€‚ç­‰å¾…æœŸé–“è«‹ç¢ºä¿å…¨å€‰è³ªæŠ¼ã€‚
              </div>
              <button
                onClick={()=>snipeConvert("ETH")}
                disabled={!(Number(ui.ethBtcRatio) >= ETH_SNIPE_RATIO && state.eth>0)}
                className={`w-full py-3 rounded-xl font-bold ${
                  (Number(ui.ethBtcRatio) >= ETH_SNIPE_RATIO && state.eth>0)
                    ? "bg-fuchsia-600 hover:bg-fuchsia-500"
                    : "bg-slate-700 text-slate-500 cursor-not-allowed"
                }`}
              >
                ETH åˆ°åƒ¹åŸ·è¡Œï¼ˆå…¨æ› BTCï¼‰
              </button>
            </Card>

            <Card className="border-l-4 border-l-blue-500">
              <h3 className="font-bold text-blue-400 mb-2">ADA ç‹™æ“Šæ‰‹</h3>
              <div className="flex justify-between items-end mb-2">
                <div className="text-xs text-slate-400">ç•¶å‰åŒ¯ç‡: <span className="text-white font-mono">{Number(ui.adaBtcRatio).toFixed(7)}</span></div>
                <div className="text-xs text-slate-400">ç›®æ¨™: <span className="text-blue-300 font-mono">{ADA_SNIPE_RATIO}</span></div>
              </div>
              <div className="h-2 bg-slate-900 rounded-full overflow-hidden mb-3">
                <div className="h-full bg-blue-600 transition-all" style={{width: `${Math.min(100, (Number(ui.adaBtcRatio)/ADA_SNIPE_RATIO)*100)}%`}} />
              </div>
              <div className="text-xs text-slate-500 leading-relaxed bg-slate-900 p-2 rounded mb-3">
                æŒæœ‰ {Math.floor(state.ada).toLocaleString()} ADAã€‚ç­‰å¾…æœŸé–“è«‹å§”è¨—/æµå‹•è³ªæŠ¼ã€‚
              </div>
              <button
                onClick={()=>snipeConvert("ADA")}
                disabled={!(Number(ui.adaBtcRatio) >= ADA_SNIPE_RATIO && state.ada>0)}
                className={`w-full py-3 rounded-xl font-bold ${
                  (Number(ui.adaBtcRatio) >= ADA_SNIPE_RATIO && state.ada>0)
                    ? "bg-blue-600 hover:bg-blue-500"
                    : "bg-slate-700 text-slate-500 cursor-not-allowed"
                }`}
              >
                ADA åˆ°åƒ¹åŸ·è¡Œï¼ˆå…¨æ› BTCï¼‰
              </button>
            </Card>
          </div>
        )}

        {tab === "sop" && (
          <div className="space-y-4 animate-fade-in text-sm text-slate-300 leading-relaxed">
            <Card>
              <h3 className="font-bold text-yellow-400 mb-2">æ ¸å¿ƒä¿¡æ¢</h3>
              <ul className="list-disc pl-4 space-y-1 marker:text-yellow-600">
                <li>æˆ‘çš„ç›®æ¨™æ˜¯ BTC é¡†æ•¸ï¼Œä¸æ˜¯æ³•å¹£æ•¸å­—ã€‚</li>
                <li>æˆ‘ä¸é æ¸¬å¸‚å ´ï¼Œæˆ‘åªåŸ·è¡Œè¦å‰‡ã€‚</li>
                <li>åªè¦æ´»è‘—ï¼ˆä¸çˆ†å€‰ã€ä¸äº‚å‹•ï¼‰ï¼Œæ™‚é–“æœƒå¸¶æˆ‘åˆ°çµ‚é»ã€‚</li>
              </ul>
            </Card>

            <Card>
              <h3 className="font-bold text-yellow-400 mb-2">å¥‘ç´„é‡é»</h3>
              <ul className="list-disc pl-4 space-y-1 marker:text-yellow-600">
                <li>DCAï¼šA/B/C/D + é•·ç‰›ä¿éšªï¼ˆ>75 é€£çºŒ 8 é€±å¾Œ 1è²·2å­˜ï¼‰ã€‚</li>
                <li>é»‘å¤©éµï¼šFNG&lt;20 æˆ– 6Må›æ’¤â‰¥30% æˆ– è·Œç ´200W â†’ é å‚™é‡‘åˆ†4é€±è²·å…¥ã€‚</li>
                <li>åœæ­¢ï¼šåå½ˆ &gt; 15% ç«‹å³åœæ­¢é»‘å¤©éµè²·å…¥ã€‚</li>
                <li>ç‹™æ“Šï¼šETH 0.058ã€ADA 0.0000085 åˆ°åƒ¹ç›´æ¥æ› BTCã€‚</li>
                <li>å†·éŒ¢åŒ…ï¼šç†±éŒ¢åŒ… â‰¥ 0.05 BTC å¿…æé ˜ã€‚</li>
              </ul>
            </Card>

            <div className="grid grid-cols-2 gap-2">
              <button onClick={() => setModal({mode:"export", title:"åŒ¯å‡ºå‚™ä»½", body:null})}
                className="py-3 bg-slate-800 border border-slate-700 rounded-xl text-slate-200 hover:text-white font-bold">
                åŒ¯å‡ºå‚™ä»½
              </button>
              <button onClick={() => setModal({mode:"import", title:"åŒ¯å…¥å‚™ä»½", body:null})}
                className="py-3 bg-slate-800 border border-slate-700 rounded-xl text-slate-200 hover:text-white font-bold">
                åŒ¯å…¥å‚™ä»½
              </button>
            </div>

            <div className="text-center text-[10px] text-slate-600 font-mono">
              Build v3.final | Target: 2030
            </div>
          </div>
        )}

        {/* Logger */}
        <div className="border-t border-slate-800 pt-4 mt-8">
          <div className="text-[10px] text-slate-500 mb-2 font-mono uppercase">System Logs</div>
          <div className="space-y-1.5 font-mono text-xs max-h-32 overflow-y-auto">
            {state.logs.length === 0 && <div className="text-slate-700">Ready...</div>}
            {state.logs.map(log => (
              <div key={log.id} className={
                log.type === 'alert' ? 'text-red-400' :
                log.type === 'success' ? 'text-emerald-400' :
                log.type === 'secure' ? 'text-blue-400' :
                log.type === 'warning' ? 'text-yellow-300' :
                'text-slate-400'
              }>
                <span className="opacity-50">[{log.date.slice(5)}]</span> {log.msg}
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Modal */}
      {modal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in">
          <div className="bg-slate-800 border border-slate-600 w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h3 className="text-xl font-bold text-white mb-4">{modal.title}</h3>

            {modal.mode === "export" && (
              <div className="space-y-3">
                <textarea
                  readOnly
                  value={JSON.stringify({schema:"p2030-v3-backup", exportedAt:new Date().toISOString(), state, ui, draft: draftRef.current}, null, 2)}
                  className="w-full h-56 bg-black/40 border border-slate-700 rounded-xl p-3 text-xs mono text-slate-200"
                />
                <button
                  onClick={async ()=>{
                    const text = JSON.stringify({schema:"p2030-v3-backup", exportedAt:new Date().toISOString(), state, ui, draft: draftRef.current}, null, 2);
                    try{
                      await navigator.clipboard.writeText(text);
                      setModal({title:"å·²è¤‡è£½", mode:"info", body:"å‚™ä»½ JSON å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚"});
                    }catch(e){
                      setModal({title:"è¤‡è£½å¤±æ•—", mode:"info", body:"è«‹æ‰‹å‹•é¸å–ä¸¦è¤‡è£½ã€‚"});
                    }
                  }}
                  className="w-full py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl text-white font-bold"
                >
                  ä¸€éµè¤‡è£½
                </button>
              </div>
            )}

            {modal.mode === "import" && (
              <div className="space-y-3">
                <textarea
                  id="importBox"
                  placeholder="è²¼ä¸Šå‚™ä»½ JSONâ€¦"
                  className="w-full h-56 bg-black/40 border border-slate-700 rounded-xl p-3 text-xs mono text-slate-200"
                />
                <button
                  onClick={()=>{
                    try{
                      const el = document.getElementById("importBox");
                      const obj = JSON.parse(el.value || "{}");
                      if(obj?.schema !== "p2030-v3-backup") throw new Error("bad schema");
                      setState({ ...initialStateNow(), ...obj.state });
                      if(obj.ui) setUi(p=>({ ...p, ...obj.ui }));
                      if(obj.draft) draftRef.current = { ...draftRef.current, ...obj.draft };
                      setModal({title:"åŒ¯å…¥æˆåŠŸ", mode:"info", body:"å·²åŒ¯å…¥ä¸¦è¦†è“‹ç›®å‰è³‡æ–™ã€‚"});
                      addLog("å·²åŒ¯å…¥å‚™ä»½ä¸¦è¦†è“‹ç›®å‰è³‡æ–™ã€‚", "success");
                    }catch(e){
                      setModal({title:"åŒ¯å…¥å¤±æ•—", mode:"info", body:"JSON æ ¼å¼ä¸æ­£ç¢ºæˆ–ä¸æ˜¯æœ¬ç‰ˆæœ¬å‚™ä»½ã€‚"});
                    }
                  }}
                  className="w-full py-3 bg-sky-600 hover:bg-sky-500 rounded-xl text-white font-bold"
                >
                  åŒ¯å…¥ä¸¦è¦†è“‹
                </button>
              </div>
            )}

            {(!modal.mode || modal.mode === "info") && (
              <div className="text-slate-300 mb-6 whitespace-pre-wrap">{modal.body}</div>
            )}

            <button onClick={() => setModal(null)} className="mt-4 w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-xl text-white font-bold">
              é—œé–‰
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
</script>
</body>
</html>
