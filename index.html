<html lang="zh-TW"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no,date=no,email=no,address=no">
  <meta name="theme-color" content="#0f172a">
  <link rel="manifest" href="./manifest.webmanifest">
  <title>Project 2030ï¼šçµ‚æ¥µé˜²ç¦¦åŸ·è¡Œæ†²æ³• v7.1</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin=""></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin=""></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    html, body, #root { height: 100%; }
    html{-webkit-text-size-adjust:100%;text-size-adjust:100%;}
    body{
      margin:0;
      background:#0f172a;
      color:#f1f5f9;
      -webkit-tap-highlight-color:transparent;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      overflow:hidden;
      overscroll-behavior-y: contain;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; }
    .app-shell{ height:100%; }
    .content-scroll{
      height:100%;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      padding-top: env(safe-area-inset-top);
      padding-bottom: calc(var(--tabbar-h, 78px) + 4px);
    }
    .tabbar{
      position:fixed; left:0; right:0; bottom:0;
      background: rgba(15,23,42,.95);
      backdrop-filter: blur(12px);
      border-top: 1px solid rgba(51,65,85,.6);
      z-index: 30;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .tabbar button{touch-action:manipulation;}
    .tabbar-inner{
      display:flex;
      gap:8px;
      max-width: 32rem;
      margin: 0 auto;
      padding: 8px 10px 6px;
    }
    ::-webkit-scrollbar{ width:4px; }
    ::-webkit-scrollbar-track{ background:#1e293b; }
    ::-webkit-scrollbar-thumb{ background:#475569; border-radius:2px; }
    @keyframes pulse-green{
      0%{ box-shadow:0 0 0 0 rgba(16,185,129,.7); }
      70%{ box-shadow:0 0 0 10px rgba(16,185,129,0); }
      100%{ box-shadow:0 0 0 0 rgba(16,185,129,0); }
    }
    .animate-pulse-green{ animation:pulse-green 2s infinite; }
    @keyframes fade-in{
      from{ opacity:0; transform:translateY(8px); }
      to{ opacity:1; transform:translateY(0); }
    }
    .animate-fade-in{ animation:fade-in .3s cubic-bezier(.16,1,.3,1) both; }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useEffect, useMemo, useRef, useState } = React;

window.onerror = function (msg, src, line, col) {
  try{
    const root = document.getElementById("root");
    if(root){
      root.innerHTML = `
        <div style="padding:16px;color:#fff;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;">
          <div style="font-size:18px;font-weight:800;margin-bottom:8px;">âš ï¸ App ç™¼ç”ŸéŒ¯èª¤ï¼ˆé¿å…é»‘å±ï¼‰</div>
          <div style="opacity:.9;margin-bottom:8px;">${String(msg)}</div>
          <div style="opacity:.7;font-size:12px;">${String(src)} : ${line}:${col}</div>
        </div>
      `;
    }
  }catch(e){}
  return false;
};

/* ===== Constants ===== */
const PLAN_START_ISO = "2026-02-01T00:00:00+08:00";

const DEFAULT_GOAL_BTC = 3.0;
const DEFAULT_TARGET_YEAR = 2030;
const DEFAULT_MONTHLY_DCA = 400; // ç´„ NT$ 13,000
const FIXED_MONTH_PARTS = 4;

const SAVE_KEY = "p2030_v7_constitution_save";
const APP_VERSION = "7.1.0";
const LEGACY_SAVE_KEYS = ["p2030_v6_constitution_save","p2030_v5_constitution_save","p2030_v4_constitution_save"];
const CACHE_KEY_METRICS = "p2030_v7_metrics_cache";

const URL_PARAMS = new URLSearchParams(window.location.search || "");
const TAB_ALLOWLIST = new Set(["home", "convert", "sop", "system"]);
const INITIAL_TAB = TAB_ALLOWLIST.has(URL_PARAMS.get("tab")) ? URL_PARAMS.get("tab") : "home";
const EMBED_MODE = URL_PARAMS.get("embed") === "1";
const HIDE_TABBAR = URL_PARAMS.get("hideTabbar") === "1" || EMBED_MODE;

const calcPlanMonthsByTargetYear = (targetYear) => {
  const s = new Date(PLAN_START_ISO);
  const e = new Date(`${targetYear}-12-31T00:00:00+08:00`);
  const raw = (e.getFullYear() - s.getFullYear()) * 12 + (e.getMonth() - s.getMonth()) + 1;
  return Math.max(1, raw);
};
const calcReserveCap = (monthlyDca) => Math.max(0, Number(monthlyDca || 0) * 6);

const normalizeConfig = (raw = {}) => {
  const goalBtc = Math.max(0.01, Number(raw.goalBtc ?? DEFAULT_GOAL_BTC) || DEFAULT_GOAL_BTC);
  const yearRaw = parseInt(raw.targetYear ?? DEFAULT_TARGET_YEAR, 10);
  const currentYear = new Date().getFullYear();
  const targetYear = Math.min(2100, Math.max(currentYear, Number.isFinite(yearRaw) ? yearRaw : DEFAULT_TARGET_YEAR));
  const monthlyRaw = Number(raw.monthlyDca ?? DEFAULT_MONTHLY_DCA);
  const monthlyDca = Math.max(50, Number.isFinite(monthlyRaw) ? monthlyRaw : DEFAULT_MONTHLY_DCA);
  return { goalBtc, targetYear, monthlyDca };
};

const EXCHANGE_RISK_CAP_PCT = 20;
const SINGLE_STABLECOIN_CAP_PCT = 50;

const GREED_WEEKS_FOR_INSURANCE = 8;
const BLACK_SWAN_WEEKS = 4;
const BLACK_SWAN_STOP_REBOUND = 15;

const ETH_SNIPE_RATIO = 0.058;
const ADA_SNIPE_RATIO = 0.0000085;

const ETH_ALERT_RATIO = 0.045;
const ADA_ALERT_RATIO = 0.000008;

const APPENDIX_ETH_BASE = 34;
const APPENDIX_ADA_BASE = 74000;
const APPENDIX_CURRENT_BTC = 0.136;
const APPENDIX_DCA_AVG_PRICE = 90000;

const PLAN_MONTHS_DEFAULT = calcPlanMonthsByTargetYear(DEFAULT_TARGET_YEAR);

/* ===== Helpers ===== */
const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
const parseNum = (s, fallback = NaN) => {
  const n = Number(String(s ?? "").replace(/,/g,"").trim());
  return Number.isFinite(n) ? n : fallback;
};
const fmt = (n, d=4) => Number(n||0).toFixed(d);
const monthKeyNow = () => {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
};
const todayMMDD = () => new Date().toLocaleDateString("zh-TW", { month:"2-digit", day:"2-digit" });
const reboundPctFrom = (low, now) => (low>0 && now>0) ? ((now-low)/low)*100 : 0;
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

const parseLooseJson = (text) => {
  const s = String(text || "");
  const i1 = s.indexOf("{");
  const i2 = s.indexOf("[");
  let i = -1;
  if (i1 === -1) i = i2;
  else if (i2 === -1) i = i1;
  else i = Math.min(i1, i2);
  if (i < 0) throw new Error("JSON not found");
  return JSON.parse(s.slice(i).trim());
};

const ensureDiscipline = (obj = {}) => ({
  ruleExec: !!obj.ruleExec,
  noEmotion: !!obj.noEmotion,
  coldWallet: !!obj.coldWallet,
  fullRecord: !!obj.fullRecord
});
const calcDisciplineScore = (d) =>
  (d.ruleExec ? 25 : 0) +
  (d.noEmotion ? 25 : 0) +
  (d.coldWallet ? 25 : 0) +
  (d.fullRecord ? 25 : 0);

const triggerConfetti = () => {
  if (typeof confetti !== "function") return;
  const count = 150;
  const defaults = { origin: { y: 0.72 } };
  const fire = (ratio, opts) => confetti(Object.assign({}, defaults, opts, { particleCount: Math.floor(count * ratio) }));
  fire(0.25, { spread: 26, startVelocity: 55 });
  fire(0.2, { spread: 60 });
  fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
  fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
  fire(0.1, { spread: 120, startVelocity: 45 });
};

/* ===== Initial State ===== */
const initialStateNow = () => ({
  btcHot: 0.0,
  btcCold: APPENDIX_CURRENT_BTC,
  usdtReserve: 0,

  eth: 34.0,
  ada: 74000.0,

  ethStaked: true,
  adaStaked: true,

  logs: [],
  consecutiveGreedWeeks: 0,

  monthPartsRemaining: FIXED_MONTH_PARTS,
  lastMonthKey: monthKeyNow(),
  lastWeeklyExecISO: null,
  lastWeeklyResult: null,

  reserveRebuyMonthKey: null,
  ethUnstakeArmed: false,
  adaUnstakeArmed: false,
  disciplineByMonth: {},

  blackSwan: {
    active: false,
    remainingWeeks: 0,
    weeklyBudget: 0,
    startedAtISO: null,
    reason: null,
    anchorPrice: 0,
    lowPrice: 0,
    lastSpent: 0
  }
});

const sanitizeLoadedState = (raw) => {
  const st = { ...initialStateNow(), ...(raw || {}) };
  st.monthPartsRemaining = clamp(parseInt(st.monthPartsRemaining, 10) || 0, 0, FIXED_MONTH_PARTS);
  st.usdtReserve = Math.max(0, Number(st.usdtReserve || 0));
  st.btcHot = Math.max(0, Number(st.btcHot || 0));
  st.btcCold = Math.max(0, Number(st.btcCold || 0));
  st.eth = Math.max(0, Number(st.eth || 0));
  st.ada = Math.max(0, Number(st.ada || 0));
  if (!st.blackSwan || typeof st.blackSwan !== "object") st.blackSwan = initialStateNow().blackSwan;
  st.blackSwan.remainingWeeks = clamp(parseInt(st.blackSwan.remainingWeeks, 10) || 0, 0, BLACK_SWAN_WEEKS);
  st.blackSwan.weeklyBudget = Math.max(0, Number(st.blackSwan.weeklyBudget || 0));
  st.blackSwan.lastSpent = Math.max(0, Number(st.blackSwan.lastSpent || 0));
  if (!Array.isArray(st.logs)) st.logs = [];
  if (typeof st.lastWeeklyExecISO !== "string") st.lastWeeklyExecISO = null;
  if (!st.lastWeeklyResult || typeof st.lastWeeklyResult !== "object") {
    st.lastWeeklyResult = null;
  } else {
    st.lastWeeklyResult = {
      executedAtISO: typeof st.lastWeeklyResult.executedAtISO === "string" ? st.lastWeeklyResult.executedAtISO : st.lastWeeklyExecISO,
      mode: String(st.lastWeeklyResult.mode || "normal"),
      btcBought: Math.max(0, Number(st.lastWeeklyResult.btcBought || 0)),
      spentUsdt: Math.max(0, Number(st.lastWeeklyResult.spentUsdt || 0)),
      reserveDeltaUsdt: Number(st.lastWeeklyResult.reserveDeltaUsdt || 0),
      reserveBeforeUsdt: Math.max(0, Number(st.lastWeeklyResult.reserveBeforeUsdt || 0)),
      reserveAfterUsdt: Math.max(0, Number(st.lastWeeklyResult.reserveAfterUsdt || 0)),
      btcPriceUsd: Math.max(0, Number(st.lastWeeklyResult.btcPriceUsd || 0)),
      monthKey: String(st.lastWeeklyResult.monthKey || monthKeyNow()),
      source: String(st.lastWeeklyResult.source || "executeWeekly")
    };
  }
  return st;
};

function App(){
  const [state, setState] = useState(initialStateNow());
  const [tab, setTab] = useState(INITIAL_TAB);
  const [modal, setModal] = useState(null);
  const [showAdvanced, setShowAdvanced] = useState(false);
  const [privacyMode, setPrivacyMode] = useState(false);
  const [config, setConfig] = useState(normalizeConfig());
  const [bridgeHint, setBridgeHint] = useState(null);

  const tabbarRef = useRef(null);

  const draftRef = useRef({
    btcPrice: "90000",
    fngIndex: "50",
    ethBtcRatio: "0.050",
    adaBtcRatio: "0.000008",
    athDrawdownPct: "0",
    ma200w: "0",
    below200w: "0",
    reboundPct: "0",
    extraReserveAdd: "0",
    singleExchangeRiskPct: "0",
    singleStablecoinRiskPct: "0"
  });

  const [ui, setUi] = useState({
    btcPrice: 90000,
    fngIndex: 50,
    ethBtcRatio: 0.050,
    adaBtcRatio: 0.000008,
    athDrawdownPct: 0,
    ma200w: 0,
    below200w: 0,
    reboundPct: 0,
    singleExchangeRiskPct: 0,
    singleStablecoinRiskPct: 0,
    dataSource: "Manual",
    maUpdatedAt: 0,
    ddUpdatedAt: 0
  });

  const goalBtc = config.goalBtc;
  const targetYear = config.targetYear;
  const monthlyDca = config.monthlyDca;
  const monthParts = FIXED_MONTH_PARTS;
  const partUsdt = monthlyDca / monthParts;
  const reserveCap = calcReserveCap(monthlyDca);
  const targetDate = new Date(`${targetYear}-12-31T23:59:59+08:00`).getTime();
  const planMonths = calcPlanMonthsByTargetYear(targetYear);

  const addLog = (msg, type="info") => {
    const log = { id: Date.now() + Math.random(), date: todayMMDD(), msg, type };
    setState(prev => ({ ...prev, logs: [log, ...prev.logs].slice(0, 320) }));
  };

  const updateInput = (name, val) => {
    draftRef.current[name] = String(val);
    const el = document.getElementById(name);
    if (el) el.value = String(val);
  };

  const commitUiNumber = (key, raw, fallback) => {
    let n = parseNum(raw, fallback);
    if (!Number.isFinite(n)) n = fallback;
    setUi(p => ({ ...p, [key]: n }));
    return n;
  };

  const measureTabbar = () => {
    try{
      if (HIDE_TABBAR) {
        document.documentElement.style.setProperty("--tabbar-h", "0px");
        return;
      }
      const el = tabbarRef.current;
      if(!el) return;
      const h = el.offsetHeight || 0;
      if(h > 0) document.documentElement.style.setProperty("--tabbar-h", `${h}px`);
    }catch(e){}
  };

  useEffect(() => {
    measureTabbar();
    window.addEventListener("resize", measureTabbar);
    window.addEventListener("orientationchange", measureTabbar);
    return () => {
      window.removeEventListener("resize", measureTabbar);
      window.removeEventListener("orientationchange", measureTabbar);
    };
  }, []);
  useEffect(() => { setTimeout(measureTabbar, 200); }, [tab]);

  useEffect(() => {
    try{
      let saved = localStorage.getItem(SAVE_KEY);
      if(!saved){
        for(const k of LEGACY_SAVE_KEYS){
          const candidate = localStorage.getItem(k);
          if(candidate){ saved = candidate; break; }
        }
      }
      if(saved){
        const parsed = JSON.parse(saved);

        const loadedConfig = normalizeConfig(parsed?.config || {});
        setConfig(loadedConfig);

        const rawState = parsed?.state ? parsed.state : parsed;
        const nowKey = monthKeyNow();
        if (rawState?.lastMonthKey && rawState.lastMonthKey !== nowKey){
          rawState.monthPartsRemaining = FIXED_MONTH_PARTS;
          rawState.lastMonthKey = nowKey;
        }
        setState(sanitizeLoadedState(rawState));

        if(parsed?.ui) setUi(p=>({ ...p, ...parsed.ui }));
        if(parsed?.draft) draftRef.current = { ...draftRef.current, ...parsed.draft };

        addLog("è®€å–æœ¬æ©Ÿå­˜æª”å®Œæˆã€‚", "system");
      }else{
        addLog("Project 2030 v7 å•Ÿå‹•ã€‚å¯è‡ªè¨‚æœˆæŠ•å…¥ã€ç›®æ¨™ BTC èˆ‡ç›®æ¨™å¹´ä»½ã€‚", "system");
      }
    }catch(e){
      console.error(e);
    }
  }, []);

  useEffect(() => {
    try{
      localStorage.setItem(SAVE_KEY, JSON.stringify({
        schema:"p2030-save-v7",
        savedAtISO: new Date().toISOString(),
        config,
        state,
        ui,
        draft: draftRef.current
      }));
    }catch(e){}
  }, [state, config, ui]);

  useEffect(() => {
    if (HIDE_TABBAR) {
      try { document.documentElement.style.setProperty("--tabbar-h", "0px"); } catch(_){}
    }
    const onBridgeMessage = (event) => {
      try{
        const payload = event?.data;
        if (!payload || payload.type !== "hodl-context") return;

        const targetYear = parseInt(payload.horizonYear, 10);
        const goalBtc = Number(payload.targetBtc);
        const monthlyDca = Number(payload.monthlyBudgetTwd);
        const hasAnyConfig = Number.isFinite(targetYear) || Number.isFinite(goalBtc) || Number.isFinite(monthlyDca);

        if (hasAnyConfig) {
          setConfig(prev => normalizeConfig({
            goalBtc: Number.isFinite(goalBtc) && goalBtc > 0 ? goalBtc : prev.goalBtc,
            targetYear: Number.isFinite(targetYear) ? targetYear : prev.targetYear,
            monthlyDca: Number.isFinite(monthlyDca) && monthlyDca > 0 ? monthlyDca : prev.monthlyDca
          }));
        }

        setBridgeHint({
          atISO: payload.atISO || new Date().toISOString(),
          sourceVersion: payload.sourceVersion || "HODL",
          monthlyBudgetTwd: Number(payload.monthlyBudgetTwd || 0),
          targetBtc: Number(payload.targetBtc || 0),
          horizonYear: Number(payload.horizonYear || 0),
          btcHolding: Number(payload.btcHolding || 0)
        });
        addLog("å·²æ¥æ”¶ HODL è¡Œå‹•åŒæ­¥åƒæ•¸ã€‚", "system");
      }catch(_){ }
    };

    window.addEventListener("message", onBridgeMessage);
    return () => window.removeEventListener("message", onBridgeMessage);
  }, []);

  /* ===== Backup / Import / Reset ===== */
  const exportData = async () => {
    const payload = JSON.stringify({ schema:"p2030-backup-v3", exportedAtISO:new Date().toISOString(), config, state, ui, draft: draftRef.current }, null, 2);
    try{
      await navigator.clipboard.writeText(payload);
      setModal({ title:"åŒ¯å‡ºæˆåŠŸ", body:"âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚\nè«‹è²¼åˆ°è¨˜äº‹æœ¬/é›²ç«¯ä¿å­˜ã€‚" });
    }catch(e){
      setModal({
        title:"è«‹æ‰‹å‹•è¤‡è£½",
        body: (
          <textarea readOnly className="w-full h-56 bg-black/40 border border-slate-700 rounded-xl p-3 text-xs mono text-slate-200">
{payload}
          </textarea>
        )
      });
    }
  };

  const importData = () => {
    setModal({
      title:"é‚„åŸå‚™ä»½",
      body: (
        <div className="space-y-3">
          <div className="text-xs text-slate-400">è²¼ä¸Šä½ ä¹‹å‰åŒ¯å‡ºçš„å‚™ä»½ JSONï¼š</div>
          <textarea id="importBox" className="w-full h-56 bg-black/40 border border-slate-700 rounded-xl p-3 text-xs mono text-slate-200" placeholder="è²¼ä¸Š JSON..." />
          <button
            onClick={()=>{
              try{
                const el = document.getElementById("importBox");
                const obj = JSON.parse(el.value || "{}");
                const st = (obj?.schema==="p2030-backup-v3" || obj?.schema==="p2030-backup-v2" || obj?.schema==="p2030-backup-v1") ? obj.state : obj;
                if(!(st && typeof st.btcHot === "number")) throw new Error("bad");
                const loadedConfig = normalizeConfig(obj?.config || config);
                setConfig(loadedConfig);
                setState(sanitizeLoadedState(st));
                if(obj.ui) setUi(p=>({ ...p, ...obj.ui }));
                if(obj.draft) draftRef.current = { ...draftRef.current, ...obj.draft };
                addLog("å·²å¾å‚™ä»½é‚„åŸè³‡æ–™ã€‚", "success");
                setModal({ title:"é‚„åŸæˆåŠŸ", body:"âœ… å·²å¥—ç”¨å‚™ä»½è³‡æ–™ï¼ˆå«é•·æœŸåƒæ•¸ï¼‰ã€‚" });
              }catch(e){
                setModal({ title:"é‚„åŸå¤±æ•—", body:"âŒ JSON æ ¼å¼éŒ¯èª¤æˆ–ä¸æ˜¯æœ¬ App çš„å‚™ä»½ã€‚" });
              }
            }}
            className="w-full py-3 bg-sky-600 hover:bg-sky-500 rounded-xl text-white font-bold"
          >
            åŒ¯å…¥ä¸¦è¦†è“‹
          </button>
        </div>
      )
    });
  };

  const doHardReset = () => {
    try{
      localStorage.removeItem(SAVE_KEY);
      localStorage.removeItem(CACHE_KEY_METRICS);
    }catch(e){}
    setConfig(normalizeConfig());
    const init = initialStateNow();
    init.logs = [{ id: Date.now(), date: todayMMDD(), msg:"å·²é‡ç½®ï¼šæ‰€æœ‰è³‡æ–™æ¸…ç©ºï¼Œå›åˆ°åˆå§‹ç‹€æ…‹ã€‚", type:"system" }];
    setState(init);
    setUi({
      btcPrice: 90000,
      fngIndex: 50,
      ethBtcRatio: 0.050,
      adaBtcRatio: 0.000008,
      athDrawdownPct: 0,
      ma200w: 0,
      below200w: 0,
      reboundPct: 0,
      singleExchangeRiskPct: 0,
      singleStablecoinRiskPct: 0,
      dataSource: "Manual",
      maUpdatedAt: 0,
      ddUpdatedAt: 0
    });
    draftRef.current = {
      btcPrice:"90000",
      fngIndex:"50",
      ethBtcRatio:"0.050",
      adaBtcRatio:"0.000008",
      athDrawdownPct:"0",
      ma200w:"0",
      below200w:"0",
      reboundPct:"0",
      extraReserveAdd:"0",
      singleExchangeRiskPct:"0",
      singleStablecoinRiskPct:"0"
    };
    setTimeout(() => {
      updateInput("btcPrice","90000");
      updateInput("fngIndex","50");
      updateInput("ethBtcRatio","0.050");
      updateInput("adaBtcRatio","0.000008");
      updateInput("athDrawdownPct","0");
      updateInput("ma200w","0");
      updateInput("below200w","0");
      updateInput("reboundPct","0");
      updateInput("extraReserveAdd","0");
      updateInput("singleExchangeRiskPct","0");
      updateInput("singleStablecoinRiskPct","0");
    }, 0);
    setModal({ title:"å·²é‡ç½®", body:"âœ… æ‰€æœ‰è³‡æ–™å·²æ¸…ç©ºã€‚\nï¼ˆå»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½å†é‡ç½®ï¼‰" });
  };

  const resetAll = () => {
    setModal({
      title:"ç¢ºèªé‡ç½®",
      body: (
        <div className="space-y-3">
          <div className="text-sm text-slate-300">
            é€™æœƒæ¸…ç©ºï¼šæŒå€‰ã€é å‚™é‡‘ã€é»‘å¤©éµé€²åº¦ã€Logsã€é€±é–ã€‚<br/>
            <span className="text-yellow-300 font-bold">å»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ã€‚</span>
          </div>
          <button onClick={doHardReset} className="w-full py-3 bg-red-600 hover:bg-red-500 rounded-xl text-white font-bold">
            æˆ‘ç¢ºå®šè¦é‡ç½®
          </button>
        </div>
      )
    });
  };

  /* ===== Weekly lock ===== */
  const isSameISOWeek = (isoA, isoB) => {
    if(!isoA || !isoB) return false;
    const weekKey = (d) => {
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = date.getUTCDay() || 7;
      date.setUTCDate(date.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((date - yearStart)/86400000) + 1)/7);
      return `${date.getUTCFullYear()}-W${weekNo}`;
    };
    return weekKey(new Date(isoA)) === weekKey(new Date(isoB));
  };
  const canExecuteThisWeek = !isSameISOWeek(state.lastWeeklyExecISO, new Date().toISOString());

  const unlockThisWeek = () => {
    setModal({
      title:"ç¢ºèªè§£é–",
      body: (
        <div className="space-y-3">
          <div className="text-sm text-slate-300">
            é€™æœƒè§£é™¤ã€Œæœ¬é€±å·²åŸ·è¡Œé–ã€ï¼Œè®“ä½ å¯ä»¥é‡æ–°æŒ‰ä¸€æ¬¡ã€‚<br/>
            <span className="text-yellow-300 font-bold">åƒ…åœ¨æŠ“éŒ¯/æ‰“éŒ¯æ™‚ä½¿ç”¨ã€‚</span>
          </div>
          <button
            onClick={()=>{
              setState(prev => ({ ...prev, lastWeeklyExecISO: null }));
              addLog("å·²æ‰‹å‹•è§£é–æœ¬é€±åŸ·è¡Œé–ã€‚", "warning");
              setModal({ title:"å·²è§£é–", body:"âœ… æœ¬é€±åŸ·è¡Œé–å·²è§£é™¤ã€‚" });
            }}
            className="w-full py-3 bg-yellow-500 hover:bg-yellow-400 rounded-xl text-slate-900 font-black"
          >
            æˆ‘ç¢ºå®šè¦è§£é–
          </button>
        </div>
      )
    });
  };

  /* ===== Derived ===== */
  const totalBtc = useMemo(() => (state.btcHot + state.btcCold), [state.btcHot, state.btcCold]);
  const progress = clamp((totalBtc / goalBtc) * 100, 0, 100);
  const daysLeft = Math.max(0, Math.ceil((targetDate - Date.now()) / (1000*60*60*24)));

  const portfolioUsdApprox =
    (totalBtc * (ui.btcPrice || 0)) +
    (state.eth * (ui.ethBtcRatio || 0) * (ui.btcPrice || 0)) +
    (state.ada * (ui.adaBtcRatio || 0) * (ui.btcPrice || 0)) +
    (state.usdtReserve || 0);

  const stablePct = portfolioUsdApprox > 0 ? ((state.usdtReserve||0) / portfolioUsdApprox * 100) : 0;
  const reserveOverflow = Math.max(0, (state.usdtReserve || 0) - reserveCap);
  const reserveCapPct = reserveCap > 0 ? clamp(((state.usdtReserve || 0) / reserveCap) * 100, 0, 160) : 0;

  const inEthLiquidityZone =
    Number(ui.ethBtcRatio || 0) >= ETH_SNIPE_RATIO * 0.85 &&
    Number(ui.ethBtcRatio || 0) < ETH_SNIPE_RATIO;
  const inAdaLiquidityZone =
    Number(ui.adaBtcRatio || 0) >= ADA_SNIPE_RATIO * 0.85 &&
    Number(ui.adaBtcRatio || 0) < ADA_SNIPE_RATIO;

  const appendixEthBase = state.eth;
  const appendixAdaBase = state.ada;
  const appendixCurrentBtc = totalBtc;
  const appendixEthBtc = appendixEthBase * ETH_SNIPE_RATIO;
  const appendixAdaBtc = appendixAdaBase * ADA_SNIPE_RATIO;
  const appendixDcaTotal = planMonths * monthlyDca;
  const appendixDcaBtc = appendixDcaTotal / APPENDIX_DCA_AVG_PRICE;
  const appendixTotalBtc = appendixEthBtc + appendixAdaBtc + appendixDcaBtc + appendixCurrentBtc;
  const appendixGapBtc = Math.max(0, goalBtc - appendixTotalBtc);

  const currentMonthKey = monthKeyNow();
  const currentDiscipline = ensureDiscipline(state.disciplineByMonth?.[currentMonthKey]);
  const disciplineScore = calcDisciplineScore(currentDiscipline);

  const setDisciplineFlag = (key, val) => {
    setState(prev => {
      const mk = monthKeyNow();
      const oldMonth = ensureDiscipline(prev.disciplineByMonth?.[mk]);
      return {
        ...prev,
        disciplineByMonth: {
          ...prev.disciplineByMonth,
          [mk]: { ...oldMonth, [key]: !!val }
        }
      };
    });
  };

  const openPlanSettings = () => {
    setModal({
      title:"é•·æœŸåƒæ•¸è¨­å®š",
      body: (
        <div className="space-y-3">
          <div className="text-xs text-slate-400">å¯èª¿æ•´ï¼šæœˆæŠ•å…¥é‡‘é¡ã€ç›®æ¨™ BTCã€ç›®æ¨™å¹´ä»½ï¼ˆé•·æœŸå¯ç”¨ï¼‰ã€‚</div>
          <div className="grid grid-cols-1 gap-2">
            <input id="cfgMonthlyDca" type="number" step="1" defaultValue={String(monthlyDca)} className="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-sm font-mono" placeholder="æ¯æœˆæŠ•å…¥ USDT" />
            <input id="cfgGoalBtc" type="number" step="0.0001" defaultValue={String(goalBtc)} className="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-sm font-mono" placeholder="ç›®æ¨™ BTC" />
            <input id="cfgTargetYear" type="number" step="1" defaultValue={String(targetYear)} className="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-sm font-mono" placeholder="ç›®æ¨™å¹´ä»½ï¼ˆYYYYï¼‰" />
          </div>
          <div className="text-xs text-slate-500">åˆ†å±¤åŸ·è¡Œå›ºå®š 4 ä»½ï¼›æ¯ä»½è‡ªå‹•ç­‰æ–¼æœˆæŠ•å…¥ Ã· 4ã€‚</div>
          <button
            onClick={()=>{
              const monthly = Math.max(50, parseNum(document.getElementById("cfgMonthlyDca")?.value, monthlyDca));
              const goal = Math.max(0.01, parseNum(document.getElementById("cfgGoalBtc")?.value, goalBtc));
              const yearRaw = parseInt(document.getElementById("cfgTargetYear")?.value, 10);
              const currentYear = new Date().getFullYear();
              const target = Math.min(2100, Math.max(currentYear, Number.isFinite(yearRaw) ? yearRaw : targetYear));

              const nextCfg = normalizeConfig({ monthlyDca: monthly, goalBtc: goal, targetYear: target });
              setConfig(nextCfg);
              addLog(`åƒæ•¸æ›´æ–°ï¼šæœˆæŠ•å…¥ ${Math.round(nextCfg.monthlyDca)}Uï½œç›®æ¨™ ${nextCfg.goalBtc} BTCï½œ${nextCfg.targetYear} å¹´`, "system");
              setModal({ title:"å·²æ›´æ–°", body:`âœ… é•·æœŸåƒæ•¸å·²å¥—ç”¨\næœˆæŠ•å…¥ï¼š${Math.round(nextCfg.monthlyDca)}U\næ¯ä»½ï¼šç´„ ${(nextCfg.monthlyDca/4).toFixed(2)}U\nç›®æ¨™ï¼š${nextCfg.goalBtc} BTCï¼ˆ${nextCfg.targetYear}ï¼‰` });
            }}
            className="w-full py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-bold"
          >
            å¥—ç”¨é•·æœŸåƒæ•¸
          </button>
        </div>
      )
    });
  };

  const openHoldingsEditor = () => {
    setModal({
      title:"ç›®å‰ BTC æŒæœ‰è¨­å®š",
      body: (
        <div className="space-y-3">
          <div className="text-xs text-slate-400">ä½ å¯ç›´æ¥ä¿®æ­£ç›®å‰æŒæœ‰é‡ï¼ˆç†±éŒ¢åŒ… / å†·éŒ¢åŒ…ï¼‰ã€‚</div>
          <div className="grid grid-cols-1 gap-2">
            <input id="cfgBtcHot" type="number" step="0.000001" defaultValue={String(state.btcHot)} className="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-sm font-mono" placeholder="ç†±éŒ¢åŒ… BTC" />
            <input id="cfgBtcCold" type="number" step="0.000001" defaultValue={String(state.btcCold)} className="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-sm font-mono" placeholder="å†·éŒ¢åŒ… BTC" />
          </div>
          <button
            onClick={()=>{
              const hot = Math.max(0, parseNum(document.getElementById("cfgBtcHot")?.value, state.btcHot));
              const cold = Math.max(0, parseNum(document.getElementById("cfgBtcCold")?.value, state.btcCold));
              setState(prev => ({ ...prev, btcHot: hot, btcCold: cold }));
              addLog(`å·²æ›´æ–°ç›®å‰ BTC æŒæœ‰ï¼šHot ${hot.toFixed(6)} / Cold ${cold.toFixed(6)}`, "system");
              setModal({ title:"å·²æ›´æ–°", body:`âœ… ç›®å‰æŒæœ‰é‡å·²å¥—ç”¨\nHotï¼š${hot.toFixed(6)} BTC\nColdï¼š${cold.toFixed(6)} BTC\nTotalï¼š${(hot+cold).toFixed(6)} BTC` });
            }}
            className="w-full py-3 bg-sky-600 hover:bg-sky-500 rounded-xl font-bold"
          >
            å¥—ç”¨ç›®å‰æŒæœ‰é‡
          </button>
        </div>
      )
    });
  };

  /* ===== API fetch ===== */
  const fetchTextWithTimeout = async (url, ms) => {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), ms);
    try{
      const res = await fetch(url, { cache:"no-store", signal: ctrl.signal });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.text();
    }finally{
      clearTimeout(t);
    }
  };

  const fetchJsonSmart = async (url) => {
    try{ return parseLooseJson(await fetchTextWithTimeout(url, 5000)); }catch(e){}
    try{ return parseLooseJson(await fetchTextWithTimeout("https://api.allorigins.win/raw?url=" + encodeURIComponent(url), 8000)); }catch(e){}
    const j = "https://r.jina.ai/" + url.replace(/^https?:\/\//, "");
    return parseLooseJson(await fetchTextWithTimeout(j, 10000));
  };

  const withRetry = async (fn, tries=2) => {
    let last = null;
    for(let i=0;i<tries;i++){
      try{ return await fn(); }
      catch(e){ last = e; await sleep(1000); }
    }
    throw last;
  };

  const calc200wMA_fromBinance = async () => {
    const url = "https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1w&limit=200";
    let data = [];
    try { data = parseLooseJson(await fetchTextWithTimeout(url, 5000)); }
    catch(e) { data = await fetchJsonSmart(url); }

    if(!Array.isArray(data) || data.length < 200) throw new Error("Binance weekly data incomplete");
    const closes = data.map(k => parseFloat(k?.[4])).filter(n => Number.isFinite(n) && n > 0);
    if(closes.length < 200) throw new Error("Binance closes < 200");
    const sum = closes.slice(-200).reduce((a,b)=>a+b,0);
    return sum / 200;
  };

  const calc200wMA_fromCC = async () => {
    const cc = await fetchJsonSmart("https://min-api.cryptocompare.com/data/v2/histoweek?fsym=BTC&tsym=USD&limit=200");
    if (cc?.Response === "Error") throw new Error(cc?.Message || "CC histoweek Error");
    const arr = cc?.Data?.Data || [];
    const closes = arr.map(x => Number(x?.close)||0).filter(x => x > 0);
    if (closes.length < 200) throw new Error("CC weekly data incomplete");
    return closes.slice(-200).reduce((a,b)=>a+b,0) / 200;
  };

  const calc6mHigh = async () => {
    try{
      const url = "https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1d&limit=185";
      let data = [];
      try { data = parseLooseJson(await fetchTextWithTimeout(url, 5000)); }
      catch(e) { data = await fetchJsonSmart(url); }
      if(Array.isArray(data) && data.length > 100){
        const highs = data.map(k => parseFloat(k?.[2])).filter(n => Number.isFinite(n) && n > 0);
        if(highs.length > 30) return Math.max(...highs);
      }
    }catch(e){}
    const cc = await fetchJsonSmart("https://min-api.cryptocompare.com/data/v2/histoday?fsym=BTC&tsym=USD&limit=185");
    if (cc?.Response === "Error") throw new Error(cc?.Message || "CC histoday Error");
    const highs = (cc?.Data?.Data || []).map(x => Number(x?.high)||0).filter(n=>n>0);
    if(highs.length < 30) throw new Error("6m highs insufficient");
    return Math.max(...highs);
  };

  const autofillFromApis = async () => {
    addLog("æ­£åœ¨é€£æ¥å¸‚å ´æ•¸æ“š...", "system");

    const cache = (() => { try { return JSON.parse(localStorage.getItem(CACHE_KEY_METRICS)); } catch { return null; } })();
    if(cache && cache.ts && (Date.now() - cache.ts) < 60_000 * 3){
      const { btc, fng, ethBtc, adaBtc, dd6m, ma200w, below200w, src } = cache;
      if(btc){ updateInput("btcPrice", Math.round(btc)); setUi(p=>({ ...p, btcPrice: btc })); }
      if(Number.isFinite(fng)){ updateInput("fngIndex", fng); setUi(p=>({ ...p, fngIndex: fng })); }
      if(ethBtc){ updateInput("ethBtcRatio", Number(ethBtc).toFixed(5)); setUi(p=>({ ...p, ethBtcRatio: ethBtc })); }
      if(adaBtc){ updateInput("adaBtcRatio", Number(adaBtc).toFixed(7)); setUi(p=>({ ...p, adaBtcRatio: adaBtc })); }
      if(Number.isFinite(dd6m)){ updateInput("athDrawdownPct", Number(dd6m).toFixed(2)); setUi(p=>({ ...p, athDrawdownPct: Number(dd6m), ddUpdatedAt: Date.now() })); }
      if(Number.isFinite(ma200w) && ma200w > 0){ updateInput("ma200w", String(Math.round(ma200w))); setUi(p=>({ ...p, ma200w: Number(ma200w), maUpdatedAt: Date.now() })); }
      if(typeof below200w === "number"){ updateInput("below200w", String(below200w)); setUi(p=>({ ...p, below200w })); }
      setUi(p=>({ ...p, dataSource: src || "Cache" }));
      addLog("ä½¿ç”¨å¿«å–æ•¸æ“šï¼ˆ3åˆ†é˜å…§ï¼‰", "system");
      return;
    }

    try{
      const fngP = withRetry(()=>fetchJsonSmart("https://api.alternative.me/fng/?limit=1&format=json"));
      const priceP = withRetry(()=>fetchJsonSmart("https://min-api.cryptocompare.com/data/pricemulti?fsyms=BTC,ETH,ADA&tsyms=USD"));
      const [fngData, priceData] = await Promise.all([fngP, priceP]);

      const fng = clamp(parseInt(fngData?.data?.[0]?.value ?? "50", 10), 0, 100);
      const btc = Number(priceData?.BTC?.USD || 0);
      const eth = Number(priceData?.ETH?.USD || 0);
      const ada = Number(priceData?.ADA?.USD || 0);
      if(!(btc > 0)) throw new Error("Price fetch failed");

      const ethBtc = eth > 0 ? (eth / btc) : 0;
      const adaBtc = ada > 0 ? (ada / btc) : 0;

      let ma200w = 0;
      let high6m = 0;
      try{
        [ma200w, high6m] = await Promise.all([
          calc200wMA_fromBinance().catch(()=>calc200wMA_fromCC()),
          calc6mHigh()
        ]);
      }catch(e){
        addLog("é€²éšæŒ‡æ¨™æŠ“å–éƒ¨åˆ†å¤±æ•—ï¼ˆå¯æ‰‹å‹•è¼¸å…¥ï¼‰", "warning");
      }

      const below200w = (ma200w > 0 && btc < ma200w) ? 1 : 0;
      const dd6m = (high6m > 0 && btc > 0) ? Math.max(0, ((high6m - btc) / high6m) * 100) : 0;

      updateInput("btcPrice", Math.round(btc));
      updateInput("fngIndex", fng);
      updateInput("ethBtcRatio", ethBtc.toFixed(5));
      updateInput("adaBtcRatio", adaBtc.toFixed(7));
      updateInput("athDrawdownPct", dd6m.toFixed(2));
      if(ma200w > 0){
        updateInput("ma200w", String(Math.round(ma200w)));
        updateInput("below200w", String(below200w));
      }

      setUi(p=>({
        ...p,
        btcPrice: btc,
        fngIndex: fng,
        ethBtcRatio: ethBtc,
        adaBtcRatio: adaBtc,
        athDrawdownPct: Number(dd6m.toFixed(2)),
        ddUpdatedAt: Date.now(),
        ma200w: ma200w,
        maUpdatedAt: ma200w > 0 ? Date.now() : p.maUpdatedAt,
        below200w: (ma200w > 0 ? below200w : p.below200w),
        dataSource: "Live-Binance"
      }));

      localStorage.setItem(CACHE_KEY_METRICS, JSON.stringify({
        ts: Date.now(), btc, fng, ethBtc, adaBtc,
        dd6m: Number(dd6m.toFixed(2)),
        ma200w, below200w, src: "Live-Binance"
      }));

      addLog(`æ›´æ–°æˆåŠŸï½œ6Mâ‰ˆ${dd6m.toFixed(2)}%ï½œ200W=${ma200w>0?Math.round(ma200w):"N/A"}`, "success");
      if(ethBtc >= ETH_ALERT_RATIO) addLog(`æé†’ï¼šETH/BTC â‰¥ ${ETH_ALERT_RATIO}ï¼ˆæº–å‚™ç‹™æ“Šï¼‰`, "alert");
      if(adaBtc >= ADA_ALERT_RATIO) addLog(`æé†’ï¼šADA/BTC â‰¥ ${ADA_ALERT_RATIO}ï¼ˆæº–å‚™ç‹™æ“Šï¼‰`, "alert");
    }catch(e){
      console.error(e);
      addLog("æ•¸æ“šæŠ“å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯", "warning");
    }
  };

  useEffect(() => { setTimeout(autofillFromApis, 120); }, []);

  /* ===== Actions ===== */
  const addReserve = () => {
    const add = Math.max(0, Math.floor(parseNum(draftRef.current.extraReserveAdd, 0)));
    if (!(add > 0)) {
      setModal({ title:"éŒ¯èª¤", body:"è«‹è¼¸å…¥æ­£æ•´æ•¸" });
      return;
    }
    setState(prev => {
      const next = (prev.usdtReserve || 0) + add;
      if (next > reserveCap) addLog(`é å‚™é‡‘å·²é«˜æ–¼ä¸Šé™ ${Math.round(reserveCap)}Uï¼ˆè¶…å‡º ${Math.floor(next - reserveCap)}Uï¼‰`, "warning");
      return { ...prev, usdtReserve: next };
    });
    addLog(`æ‰‹å‹•è£œå……é å‚™é‡‘ï¼š+${add} U`, "success");
    draftRef.current.extraReserveAdd = "0";
    updateInput("extraReserveAdd", "0");
  };

  const moveCold = () => {
    if(state.btcHot < 0.05){
      setModal({ title:"æ‹’çµ•", body:"æœªé” 0.05 BTC é–€æª»" });
      return;
    }
    const amt = state.btcHot;
    setState(p=>({ ...p, btcCold: (p.btcCold||0) + amt, btcHot: 0 }));
    addLog(`æé ˜ ${fmt(amt,6)} BTC è‡³å†·éŒ¢åŒ…`, "secure");
    triggerConfetti();
    setModal({ title:"ğŸ‰ é˜²ç¦¦å¢å¼·", body:`æˆåŠŸæé ˜ ${fmt(amt,6)} BTC è‡³å†·éŒ¢åŒ…ï¼` });
  };

  const confirmSnipeConvert = (asset) => {
    const ratio = asset === "ETH" ? Number(ui.ethBtcRatio || 0) : Number(ui.adaBtcRatio || 0);
    const target = asset === "ETH" ? ETH_SNIPE_RATIO : ADA_SNIPE_RATIO;
    const holding = asset === "ETH" ? state.eth : state.ada;

    if (ratio < target) {
      setModal({ title:"æœªé”é–€æª»", body:`${asset}/BTC éœ€ â‰¥ ${target}\nç›®å‰ï¼š${ratio}` });
      return;
    }
    if (!(holding > 0)) {
      setModal({ title:"è³‡ç”¢ä¸è¶³", body:`ç›®å‰ ${asset} ç‚º 0` });
      return;
    }

    setModal({
      title: `${asset} ç‹™æ“Šè½‰æ›`,
      body: (
        <div className="space-y-3">
          <div className="text-sm text-slate-300">
            ç›®å‰åŒ¯ç‡ï¼š<span className="mono">{ratio}</span>ï¼ˆç›®æ¨™ {target}ï¼‰<br/>
            æŒå€‰ï¼š<span className="mono">{holding.toLocaleString()}</span> {asset}
          </div>
          <input
            id="snipeBtcInput"
            type="number"
            step="0.000001"
            placeholder="è¼¸å…¥å¯¦éš›ç²å¾— BTC"
            className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-lg font-mono"
          />
          <button
            onClick={() => {
              const el = document.getElementById("snipeBtcInput");
              const btc = parseNum(el?.value, NaN);
              if (!(btc > 0)) {
                setModal({ title:"è¼¸å…¥éŒ¯èª¤", body:"è«‹è¼¸å…¥æœ‰æ•ˆ BTC æ•¸é‡" });
                return;
              }

              setState(p => ({
                ...p,
                btcHot: (p.btcHot || 0) + btc,
                eth: asset === "ETH" ? 0 : p.eth,
                ada: asset === "ADA" ? 0 : p.ada
              }));

              addLog(`ç‹™æ“ŠæˆåŠŸï¼š${asset} â†’ ${btc.toFixed(6)} BTC`, "success");
              triggerConfetti();
              setModal({ title:"ğŸ‰ ä»»å‹™å®Œæˆ", body:`å·²å°‡ ${asset} è½‰æ›ç‚º ${btc.toFixed(6)} BTC` });
            }}
            className="w-full py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-black"
          >
            ç¢ºèªè½‰æ›
          </button>
        </div>
      )
    });
  };

  const executeWeekly = () => {
    if (!canExecuteThisWeek) {
      setModal({ title:"æœ¬é€±å·²åŸ·è¡Œ", body:"å·²é–å®šï¼šæœ¬é€±ä½ å·²æŒ‰éä¸€æ¬¡åŸ·è¡Œã€‚\nï¼ˆå¦‚æŠ“éŒ¯/æ‰“éŒ¯ï¼Œå¯åˆ°ã€ç³»çµ±ã€‘â†’ã€è§£é–ã€‘ï¼‰" });
      return;
    }

    const price = parseNum(ui.btcPrice, 0);
    const fng = clamp(parseNum(ui.fngIndex, 50), 0, 100);
    if (!(price > 0)) {
      setModal({ title:"éŒ¯èª¤", body:"è«‹è¼¸å…¥æœ‰æ•ˆçš„ BTC åƒ¹æ ¼" });
      return;
    }

    const nowKey = monthKeyNow();
    let monthPartsLeft = clamp(state.monthPartsRemaining, 0, FIXED_MONTH_PARTS);
    let lastMonthKey = state.lastMonthKey;
    let monthRefilled = false;
    if (lastMonthKey !== nowKey) {
      monthPartsLeft = FIXED_MONTH_PARTS;
      lastMonthKey = nowKey;
      monthRefilled = true;
    }

    let greed = state.consecutiveGreedWeeks;
    let spend = 0, save = 0, action = "";
    let bucket = "";

    if (fng < 20) { bucket = "A"; greed = 0; }
    else if (fng <= 40) { bucket = "B"; greed = 0; }
    else if (fng <= 75) { bucket = "C"; greed = 0; }
    else { bucket = "D"; greed += 1; }

    if (monthPartsLeft <= 0) {
      action = `æœ¬æœˆä»½é¡å·²ç”¨å®Œï¼ˆ0/${FIXED_MONTH_PARTS}ï¼‰ï½œæœ¬æ¬¡ä¸æ–°å¢æœˆè–ªè³‡é‡‘`;
    } else {
      if (bucket === "A") { action = "A æ¥µåº¦ææ…Œï¼š4è²·0å­˜ï¼ˆå¯å•Ÿå‹•é»‘å¤©éµï¼‰"; spend = 4; save = 0; }
      if (bucket === "B") { action = "B ææ‡¼ï¼š3è²·1å­˜"; spend = 3; save = 1; }
      if (bucket === "C") { action = "C ä¸­æ€§/åè²ªï¼š2è²·2å­˜"; spend = 2; save = 2; }
      if (bucket === "D") {
        if (greed > GREED_WEEKS_FOR_INSURANCE) {
          action = `D è²ªå©ªã€é•·ç‰›ä¿éšªã€‘ï¼š1è²·3å­˜ï¼ˆå·²é€£çºŒ ${greed} é€±>75ï¼‰`;
          spend = 1; save = 3;
        } else {
          action = `D è²ªå©ªï¼š0è²·4å­˜ï¼ˆé€£çºŒ ${greed} é€±>75ï¼‰`;
          spend = 0; save = 4;
        }
      }

      const need = spend + save;
      if (need > monthPartsLeft) {
        const sp = Math.min(spend, monthPartsLeft);
        const left = monthPartsLeft - sp;
        const sv = Math.min(save, left);
        spend = sp; save = sv;
        action += `ï¼ˆä»½é¡ä¸è¶³ï¼šè²·${sp}å­˜${sv}ï¼‰`;
      }
    }

    const usdtSpent = spend * partUsdt;
    const usdtSaved = save * partUsdt;

    const athDD = clamp(parseNum(ui.athDrawdownPct, 0), 0, 100);
    const below200w = Number(ui.below200w || 0) === 1;
    const blackTriggered = (fng < 20) || (athDD >= 30) || below200w;

    let blackSwan = { ...state.blackSwan, lastSpent: 0 };
    let reserveAfterSave = (state.usdtReserve || 0) + usdtSaved;
    let blackSpent = 0;

    if (blackTriggered && !(reserveAfterSave > 0) && !blackSwan.active) {
      addLog("é»‘å¤©éµæ¢ä»¶å·²è§¸ç™¼ï¼Œä½†é å‚™é‡‘=0 â†’ ç„¡æ³•å•Ÿå‹•ï¼ˆè«‹å…ˆç´¯ç©é å‚™é‡‘ï¼‰", "warning");
    }

    if (blackSwan.active) {
      const prevLow = blackSwan.lowPrice > 0 ? blackSwan.lowPrice : price;
      const newLow = Math.min(prevLow, price);
      const rb = reboundPctFrom(newLow, price);
      blackSwan.lowPrice = newLow;
      setUi(p => ({ ...p, reboundPct: Number(rb.toFixed(2)) }));
      updateInput("reboundPct", rb.toFixed(2));

      if (rb > BLACK_SWAN_STOP_REBOUND) {
        blackSwan.active = false;
        blackSwan.remainingWeeks = 0;
        addLog(`é»‘å¤©éµåœæ­¢ï¼šåå½ˆ ${rb.toFixed(2)}% > ${BLACK_SWAN_STOP_REBOUND}%`, "warning");
      }
    }

    if (!blackSwan.active && blackTriggered && reserveAfterSave > 0) {
      const reason = (fng < 20) ? "FNG<20" : (athDD >= 30 ? "6Må›æ’¤>=30%" : "è·Œç ´200W");
      blackSwan = {
        ...blackSwan,
        active: true,
        remainingWeeks: BLACK_SWAN_WEEKS,
        weeklyBudget: reserveAfterSave / BLACK_SWAN_WEEKS,
        startedAtISO: new Date().toISOString(),
        reason,
        anchorPrice: price,
        lowPrice: price,
        lastSpent: 0
      };
      addLog(`é»‘å¤©éµå•Ÿå‹•ï¼š${reason}ï½œé å‚™é‡‘åˆ†4é€±è²·å…¥`, "alert");
    }

    if (blackSwan.active && blackSwan.remainingWeeks > 0) {
      const spendNow = Math.max(0, Math.min(reserveAfterSave, blackSwan.weeklyBudget));
      if (spendNow > 0) {
        blackSpent = spendNow;
        blackSwan.lastSpent = spendNow;
        reserveAfterSave -= spendNow;
        blackSwan.remainingWeeks -= 1;
        addLog(`é»‘å¤©éµè²·å…¥ï¼š${Math.floor(spendNow)}Uï¼ˆå‰© ${blackSwan.remainingWeeks} é€±ï¼‰`, "success");
      }
      if (blackSwan.remainingWeeks <= 0) {
        blackSwan.active = false;
        addLog("é»‘å¤©éµçµæŸï¼š4é€±è²·å…¥å®Œæˆ", "system");
      }
    }

    // é å‚™é‡‘ä¸Šé™æ¢æ¬¾ï¼šæ¯æœˆè‡³å°‘ 1 ä»½å›è£œ BTC
    let reserveCapRebuySpent = 0;
    let reserveRebuyMonthKey = state.reserveRebuyMonthKey || null;
    if (!blackSwan.active && reserveAfterSave > reserveCap) {
      if (reserveRebuyMonthKey !== nowKey) {
        reserveCapRebuySpent = Math.min(partUsdt, reserveAfterSave);
        reserveAfterSave -= reserveCapRebuySpent;
        reserveRebuyMonthKey = nowKey;
        addLog(`é å‚™é‡‘ä¸Šé™æ¢æ¬¾ï¼šè¶…é ${Math.round(reserveCap)}Uï¼Œå·²è‡ªå‹•å›è£œ BTC ${reserveCapRebuySpent.toFixed(2)}U`, "info");
      } else {
        addLog(`é å‚™é‡‘å·²è¶…ä¸Šé™ï¼ˆ+${Math.floor(reserveAfterSave - reserveCap)}Uï¼‰ï¼Œæœ¬æœˆå·²åŸ·è¡Œéå›è£œ`, "warning");
      }
    }

    const totalSpent = usdtSpent + blackSpent + reserveCapRebuySpent;
    const btcBought = totalSpent > 0 ? (totalSpent / price) : 0;

    const usedParts = spend + save;
    const newMonthParts = Math.max(0, monthPartsLeft - usedParts);

    const execISO = new Date().toISOString();
    setState(prev => ({
      ...prev,
      btcHot: (prev.btcHot || 0) + btcBought,
      usdtReserve: reserveAfterSave,
      consecutiveGreedWeeks: greed,
      monthPartsRemaining: newMonthParts,
      lastMonthKey,
      blackSwan,
      reserveRebuyMonthKey,
      lastWeeklyExecISO: execISO,
      lastWeeklyResult: {
        executedAtISO: execISO,
        mode: blackSpent > 0 ? "black-swan" : "normal",
        btcBought: btcBought,
        spentUsdt: totalSpent,
        reserveDeltaUsdt: (usdtSaved - blackSpent - reserveCapRebuySpent),
        reserveBeforeUsdt: Number(state.usdtReserve || 0),
        reserveAfterUsdt: reserveAfterSave,
        btcPriceUsd: price,
        monthKey: nowKey,
        source: `executeWeekly_v${APP_VERSION}`
      }
    }));

    if (monthRefilled) addLog(`æœˆä»½æ›´æ–°ï¼šè£œå……æœ¬æœˆä»½é¡ ${FIXED_MONTH_PARTS}/${FIXED_MONTH_PARTS}ï¼ˆ${Math.round(monthlyDca)}Uï¼‰`, "system");
    addLog(`é€±å ±ï¼š${action}`, usdtSpent > 0 ? "success" : "warning");
    if (usdtSaved > 0) addLog(`å­˜å…¥é å‚™é‡‘ï¼š+${usdtSaved}U`, "info");
    if (reserveCapRebuySpent > 0) addLog(`ä¸Šé™å›è£œï¼š-${reserveCapRebuySpent}U`, "info");
    if (totalSpent > 0) addLog(`æœ¬é€±æŠ•å…¥ï¼š${Math.floor(totalSpent)}U â†’ ${btcBought.toFixed(6)} BTC`, "success");

    setModal({
      title:"åŸ·è¡Œå ±å‘Š",
      body: (
        <div className="space-y-2">
          <div className="text-emerald-300 font-bold">{action}</div>
          <div className="grid grid-cols-2 gap-2 text-sm text-slate-300">
            <span>DCAæŠ•å…¥: ${Math.round(usdtSpent)}</span>
            <span>å­˜å…¥é å‚™é‡‘: ${Math.round(usdtSaved)}</span>
            <span>é»‘å¤©éµ: ${Math.round(blackSpent)}</span>
            <span>ä¸Šé™å›è£œ: ${Math.round(reserveCapRebuySpent)}</span>
            <span>å‰©ä»½é¡: {newMonthParts}/{FIXED_MONTH_PARTS}</span>
            <span>é å‚™é‡‘é¤˜é¡: ${Math.floor(reserveAfterSave)}</span>
            <span className="col-span-2 text-white font-bold text-lg mt-2">è²·å…¥: {btcBought.toFixed(6)} BTC</span>
          </div>
        </div>
      )
    });
  };

  /* ===== UI Components ===== */
  const Card = ({children, className=""}) => (
    <div className={`bg-slate-800 border border-slate-700/50 rounded-2xl p-5 shadow-lg ${className}`}>{children}</div>
  );

  const Battery = ({level}) => (
    <div className="flex gap-1">
      {Array.from({ length: FIXED_MONTH_PARTS }, (_, idx) => idx + 1).map(i => (
        <div key={i} className={`h-2.5 w-4 rounded-sm border border-slate-600 ${i <= level ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]' : 'bg-slate-800'}`} />
      ))}
    </div>
  );

  const TabBtn = ({id, label, icon}) => (
    <button
      onClick={() => setTab(id)}
      className={`flex-1 rounded-xl py-2 text-xs font-bold transition-all flex flex-col items-center justify-center gap-1
        ${tab === id ? "bg-slate-800 text-emerald-300 border border-slate-700" : "text-slate-300/70 hover:bg-slate-800/60"}`}
    >
      <span className="text-base">{icon}</span>
      <span className="text-[11px]">{label}</span>
    </button>
  );

  const InputField = ({id, label, defaultVal, onCommit}) => (
    <div className="space-y-1">
      <label className="text-xs text-slate-400 ml-1">{label}</label>
      <input
        id={id}
        type="text"
        inputMode="decimal"
        defaultValue={defaultVal}
        onInput={(e)=>{ draftRef.current[id] = e.target.value; }}
        onBlur={(e)=> onCommit(e.target.value)}
        className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-lg font-mono focus:outline-none focus:border-emerald-500 transition-colors"
        autoCorrect="off" autoCapitalize="off" spellCheck={false}
      />
    </div>
  );

  const renderModalBody = () => {
    if(!modal) return null;
    if(typeof modal.body === "string") return <div className="text-slate-300 mb-6 whitespace-pre-wrap">{modal.body}</div>;
    return <div className="text-slate-300 mb-6">{modal.body}</div>;
  };

  return (
    <div className="app-shell select-none">
      <div className="content-scroll">
        <div className="sticky top-0 z-20 bg-slate-900/90 backdrop-blur border-b border-slate-800 px-5 py-4 shadow-2xl">
          <div className="flex justify-between items-end mb-3">
            <div onClick={()=>setPrivacyMode(!privacyMode)} className="cursor-pointer">
              <div className="text-[10px] text-slate-500 tracking-widest uppercase mb-1">
                Project 2030 v7 {privacyMode ? "ğŸ™ˆ" : ""} {EMBED_MODE ? "Â· EMBED" : ""}
              </div>
              <div className="text-2xl font-black font-mono tracking-tight text-white flex items-center gap-2">
                {privacyMode ? "****" : fmt(totalBtc)} <span className="text-sm text-slate-500 font-normal">/ {fmt(goalBtc,4)}</span>
              </div>
              <div className="text-[10px] text-slate-500 mt-1">é»æ“Šåˆ‡æ›éš±ç§æ¨¡å¼ï½œç›®æ¨™å¹´ {targetYear}</div>
            </div>
            <div className="text-right">
              <div className="text-[10px] text-slate-500 mb-1">å€’æ•¸ï¼ˆè‡³ {targetYear}/12/31ï¼‰</div>
              <div className="text-sm font-bold text-emerald-400 font-mono">{daysLeft} D</div>
              <div className={`text-[10px] mt-1 ${stablePct>30 ? "text-yellow-300" : "text-slate-500"}`}>
                ç©©å®šå¹£å æ¯”â‰ˆ{stablePct.toFixed(1)}%
              </div>
            </div>
          </div>
          <div className="h-1.5 bg-slate-800 rounded-full overflow-hidden">
            <div className="h-full bg-gradient-to-r from-emerald-600 to-green-400 transition-all duration-1000" style={{width: `${progress}%`}} />
          </div>
        </div>

        <div className="p-4 space-y-4 max-w-lg mx-auto">
          <div className="grid grid-cols-2 gap-3">
            <Card>
              <div className="text-xs text-slate-400">ç†±éŒ¢åŒ… (Hot)</div>
              <div className="text-xl font-mono font-bold text-emerald-300 my-1">{privacyMode ? "****" : fmt(state.btcHot)}</div>
              <button
                onClick={moveCold}
                disabled={!(state.btcHot >= 0.05)}
                className={`w-full text-xs rounded py-2 font-bold border transition-all
                  ${state.btcHot >= 0.05
                    ? "bg-emerald-900/50 text-emerald-300 border-emerald-800"
                    : "bg-slate-900 text-slate-600 border-slate-700 opacity-50"}`}
              >
                {state.btcHot >= 0.05 ? "æé ˜è‡³å†·éŒ¢åŒ… â”" : "æœªé” 0.05 é–€æª»"}
              </button>
            </Card>

            <Card>
              <div className="text-xs text-slate-400">å†·éŒ¢åŒ… (Cold)</div>
              <div className="text-xl font-mono font-bold text-blue-300 my-1">{privacyMode ? "****" : fmt(state.btcCold)}</div>
              <div className="text-[10px] text-slate-500 mt-2">çµ•å°é˜²ç¦¦é ˜åŸŸ</div>
            </Card>
          </div>

          <Card className="bg-gradient-to-r from-slate-800 to-slate-800/80">
            <div className="flex justify-between items-start">
              <div>
                <div className="text-xs text-yellow-500/80 mb-1">é å‚™é‡‘ (USDT)</div>
                <div className="text-2xl font-mono font-bold text-yellow-400">
                  {privacyMode ? "****" : Math.floor(state.usdtReserve).toLocaleString()}
                </div>
                <div className="mt-3 flex gap-2">
                  <input
                    id="extraReserveAdd"
                    defaultValue="0"
                    type="number"
                    onInput={(e)=>draftRef.current.extraReserveAdd = e.target.value}
                    className="w-24 bg-slate-900 text-xs p-2 rounded border border-slate-700"
                  />
                  <button onClick={addReserve} className="text-xs bg-slate-700 px-3 rounded font-bold">
                    ï¼‹é å‚™é‡‘
                  </button>
                </div>
              </div>
              <div className="text-right">
                <div className="text-[10px] text-slate-500 mb-1">æœ¬æœˆä»½é¡</div>
                <div className="inline-block"><Battery level={state.monthPartsRemaining} /></div>
                <div className="text-[10px] text-slate-600 mt-2">{ui.dataSource}</div>
              </div>
            </div>

            <div className="mt-3 text-xs text-slate-300">
              ä¸Šé™ {Math.round(reserveCap)}U ï½œ ç›®å‰ {Math.floor(state.usdtReserve)}U
              {reserveOverflow>0 && <span className="text-red-300"> ï½œ è¶…é¡ +{Math.floor(reserveOverflow)}U</span>}
            </div>
            <div className="mt-2 w-full h-2 bg-slate-900/80 rounded-full overflow-hidden">
              <div className={`h-full ${state.usdtReserve > reserveCap ? "bg-red-500":"bg-yellow-500"}`} style={{width:`${Math.min(100,reserveCapPct)}%`}} />
            </div>

            <div className="mt-4 bg-slate-900/60 border border-slate-700/50 rounded-xl p-3">
              <div className="flex justify-between text-xs text-slate-400">
                <span>é»‘å¤©éµç‹€æ…‹</span>
                <span className={state.blackSwan.active ? "text-red-300 font-bold" : "text-slate-400"}>
                  {state.blackSwan.active ? "ACTIVE" : "IDLE"}
                </span>
              </div>
              <div className="mt-2 text-xs text-slate-300">
                {state.blackSwan.active
                  ? `åŸå› ï¼š${state.blackSwan.reason}ï½œå‰©é¤˜é€±æ•¸ï¼š${state.blackSwan.remainingWeeks}/${BLACK_SWAN_WEEKS}ï½œæœ¬é€±æ‰£ï¼š${Math.floor(state.blackSwan.lastSpent||0)}U`
                  : "æœªå•Ÿå‹•ã€‚"}
              </div>
            </div>
          </Card>

          {tab === "home" && (
            <div className="space-y-4 animate-fade-in">
              {bridgeHint && (
                <Card className="border-emerald-700/50 bg-emerald-900/20">
                  <div className="flex justify-between items-start gap-3">
                    <div>
                      <h3 className="font-bold text-emerald-300">ğŸ”— å·²æ¥æ”¶ HODL è¡Œå‹•åŒæ­¥</h3>
                      <div className="text-xs text-slate-300 mt-1">
                        ä¾†æºç‰ˆæœ¬ï¼š{bridgeHint.sourceVersion} ï½œ åŒæ­¥æ™‚é–“ï¼š{new Date(bridgeHint.atISO).toLocaleString("zh-TW")}
                      </div>
                    </div>
                    <button onClick={()=>setBridgeHint(null)} className="text-xs bg-slate-700 px-2 py-1 rounded">éš±è—</button>
                  </div>
                  <div className="grid grid-cols-2 gap-2 text-xs text-slate-200 mt-3">
                    <div>æœˆæŠ•å…¥ï¼š<span className="mono">{Math.round(bridgeHint.monthlyBudgetTwd || 0)} U</span></div>
                    <div>ç›®æ¨™ BTCï¼š<span className="mono">{Number(bridgeHint.targetBtc || 0).toFixed(4)}</span></div>
                    <div>ç›®æ¨™å¹´ï¼š<span className="mono">{bridgeHint.horizonYear || "-"}</span></div>
                    <div>HODL BTCï¼š<span className="mono">{Number(bridgeHint.btcHolding || 0).toFixed(6)}</span></div>
                  </div>
                </Card>
              )}
              <Card>
                <div className="flex justify-between items-center mb-4">
                  <h3 className="font-bold text-white flex items-center gap-2">
                    <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse-green"></span>
                    æ¯é€±æ±ºç­–
                  </h3>
                  <button
                    onClick={autofillFromApis}
                    className="text-xs bg-slate-700 px-3 py-1.5 rounded-lg text-slate-300 active:scale-95 transition-transform"
                  >
                    ğŸ“¡ æ›´æ–°
                  </button>
                </div>

                <div className="grid grid-cols-2 gap-4 mb-4">
                  <InputField
                    id="btcPrice"
                    label="BTC åƒ¹æ ¼"
                    defaultVal={draftRef.current.btcPrice}
                    onCommit={(v)=>{ updateInput("btcPrice", v); commitUiNumber("btcPrice", v, ui.btcPrice); }}
                  />
                  <InputField
                    id="fngIndex"
                    label="æè²ªæŒ‡æ•¸"
                    defaultVal={draftRef.current.fngIndex}
                    onCommit={(v)=>{
                      const n = clamp(Math.round(parseNum(v, ui.fngIndex)), 0, 100);
                      updateInput("fngIndex", n);
                      setUi(p=>({ ...p, fngIndex: n }));
                    }}
                  />
                </div>

                <div className="bg-slate-900/50 rounded-xl p-3 mb-4 border border-slate-700/50">
                  <div className="flex justify-between text-xs text-slate-400 mb-2">
                    <span>æè²ª</span>
                    <span className={
                      ui.fngIndex < 20 ? "text-red-400" :
                      ui.fngIndex <= 40 ? "text-yellow-400" :
                      ui.fngIndex <= 75 ? "text-slate-300" : "text-emerald-400"
                    }>{ui.fngIndex} / 100</span>
                  </div>
                  <input
                    type="range" min="0" max="100" value={ui.fngIndex}
                    onChange={(e)=>{
                      const n = clamp(parseInt(e.target.value,10)||0, 0, 100);
                      setUi(p=>({ ...p, fngIndex: n }));
                      updateInput("fngIndex", n);
                    }}
                    className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                  />
                </div>

                <button
                  onClick={()=>setShowAdvanced(!showAdvanced)}
                  className="w-full mb-3 text-xs text-slate-500 py-2 border border-dashed border-slate-700 rounded-lg"
                >
                  {showAdvanced ? "æ”¶èµ·é€²éšè¨­å®š" : "é€²éšè¨­å®šï¼ˆåŒ¯ç‡ / 6Må›æ’¤ / 200Wï¼‰"}
                </button>

                {showAdvanced && (
                  <div className="space-y-3 mb-4 animate-fade-in">
                    <div className="grid grid-cols-2 gap-3">
                      <InputField
                        id="ethBtcRatio"
                        label="ETH/BTC"
                        defaultVal={draftRef.current.ethBtcRatio}
                        onCommit={(v)=>{ updateInput("ethBtcRatio", v); commitUiNumber("ethBtcRatio", v, ui.ethBtcRatio); }}
                      />
                      <InputField
                        id="adaBtcRatio"
                        label="ADA/BTC"
                        defaultVal={draftRef.current.adaBtcRatio}
                        onCommit={(v)=>{ updateInput("adaBtcRatio", v); commitUiNumber("adaBtcRatio", v, ui.adaBtcRatio); }}
                      />
                      <InputField
                        id="athDrawdownPct"
                        label="6M å›æ’¤%"
                        defaultVal={draftRef.current.athDrawdownPct}
                        onCommit={(v)=>{ updateInput("athDrawdownPct", v); commitUiNumber("athDrawdownPct", v, ui.athDrawdownPct); }}
                      />
                      <InputField
                        id="ma200w"
                        label="200W MA"
                        defaultVal={draftRef.current.ma200w}
                        onCommit={(v)=>{
                          updateInput("ma200w", v);
                          const ma = commitUiNumber("ma200w", v, ui.ma200w);
                          const below = (ma>0 && ui.btcPrice>0 && ui.btcPrice < ma) ? 1 : 0;
                          setUi(p=>({ ...p, below200w: below }));
                          updateInput("below200w", String(below));
                        }}
                      />
                    </div>

                    <div className="flex justify-between items-center bg-slate-900/60 border border-slate-700/50 rounded-xl px-3 py-2">
                      <div className="text-xs text-slate-400">è·Œç ´ 200Wï¼ˆå¯æ‰‹å‹•åˆ‡æ›ï¼‰</div>
                      <button
                        onClick={()=>{
                          const next = Number(ui.below200w||0)===1 ? 0 : 1;
                          setUi(p=>({ ...p, below200w: next }));
                          updateInput("below200w", String(next));
                          addLog(`æ‰‹å‹•è¨­å®šï¼šè·Œç ´200W=${next ? "ON":"OFF"}`, "system");
                        }}
                        className={`px-3 py-1.5 rounded-lg text-xs font-bold ${Number(ui.below200w)===1 ? "bg-red-600/80" : "bg-slate-700"}`}
                      >
                        {Number(ui.below200w)===1 ? "ON" : "OFF"}
                      </button>
                    </div>
                  </div>
                )}

                <button
                  onClick={executeWeekly}
                  className={`w-full py-4 text-white font-bold rounded-xl shadow-lg transition-all
                    ${canExecuteThisWeek ? "bg-emerald-600 hover:bg-emerald-500" : "bg-slate-700 text-slate-500 opacity-70"}`}
                >
                  {canExecuteThisWeek ? "åŸ·è¡Œæœ¬é€±æ±ºç­–" : "æœ¬é€±å·²åŸ·è¡Œï¼ˆé–å®šï¼‰"}
                </button>
              </Card>

              <div className="px-2">
                <div className="text-[10px] text-slate-500 mb-2 font-mono uppercase">System Logs</div>
                <div className="space-y-1.5 font-mono text-xs max-h-44 overflow-y-auto pr-2">
                  {state.logs.length === 0 && <div className="text-slate-700">System Ready...</div>}
                  {state.logs.map(log => (
                    <div
                      key={log.id}
                      className={
                        log.type === "alert" ? "text-red-300" :
                        log.type === "success" ? "text-emerald-300" :
                        log.type === "secure" ? "text-sky-300" :
                        log.type === "warning" ? "text-yellow-300" : "text-slate-300"
                      }
                    >
                      <span className="opacity-40">[{log.date.slice(5)}]</span> {log.msg}
                    </div>
                  ))}
                </div>
              </div>
              <div className="h-6"></div>
            </div>
          )}

          {tab === "convert" && (
            <div className="space-y-4 animate-fade-in">
              <Card className="border-l-4 border-l-fuchsia-500">
                <h3 className="font-bold text-fuchsia-300 mb-2">ETH ç‹™æ“Šæ‰‹</h3>
                <div className="text-xs text-slate-300 mb-2">
                  åŒ¯ç‡ <span className="text-white mono">{Number(ui.ethBtcRatio||0).toFixed(5)}</span>
                  {" "} / ç›®æ¨™ <span className="text-fuchsia-200 mono">{ETH_SNIPE_RATIO}</span>
                </div>

                <div className={`text-[11px] mb-2 px-2 py-1 rounded ${inEthLiquidityZone ? "bg-yellow-900/40 text-yellow-200 border border-yellow-700/50" : "text-slate-500"}`}>
                  {inEthLiquidityZone
                    ? "âš ï¸ å·²é€²å…¥ç›®æ¨™å‰ 10%~15% å€é–“ï¼šå»ºè­°åˆ†æ‰¹è§£é™¤è³ªæŠ¼ã€‚"
                    : "å°šæœªé€²å…¥æµå‹•æ€§å€é–“ï¼ˆç›®æ¨™å‰ 10%~15%ï¼‰ã€‚"}
                </div>

                <button
                  onClick={()=>{
                    setState(p=>({ ...p, ethUnstakeArmed: !p.ethUnstakeArmed }));
                    addLog(`ETH è§£è³ªæŠ¼è¨ˆç•«ï¼š${!state.ethUnstakeArmed ? "å·²å•Ÿå‹•" : "å·²å–æ¶ˆ"}`, "system");
                  }}
                  className={`w-full mb-2 py-2 rounded-lg text-xs font-bold ${state.ethUnstakeArmed ? "bg-yellow-600 text-slate-900" : "bg-slate-700 text-slate-200"}`}
                >
                  {state.ethUnstakeArmed ? "å·²å•Ÿå‹•è§£è³ªæŠ¼" : "æ¨™è¨˜ï¼šå•Ÿå‹•è§£è³ªæŠ¼"}
                </button>

                <button onClick={()=>confirmSnipeConvert("ETH")} className="w-full py-3 rounded-xl font-black bg-fuchsia-600 hover:bg-fuchsia-500">
                  ç‹™æ“ŠæˆåŠŸï¼ˆè¼¸å…¥å¯¦å¾—BTCï¼‰
                </button>
              </Card>

              <Card className="border-l-4 border-l-blue-500">
                <h3 className="font-bold text-blue-300 mb-2">ADA ç‹™æ“Šæ‰‹</h3>
                <div className="text-xs text-slate-300 mb-2">
                  åŒ¯ç‡ <span className="text-white mono">{Number(ui.adaBtcRatio||0).toFixed(7)}</span>
                  {" "} / ç›®æ¨™ <span className="text-blue-200 mono">{ADA_SNIPE_RATIO}</span>
                </div>

                <div className={`text-[11px] mb-2 px-2 py-1 rounded ${inAdaLiquidityZone ? "bg-yellow-900/40 text-yellow-200 border border-yellow-700/50" : "text-slate-500"}`}>
                  {inAdaLiquidityZone
                    ? "âš ï¸ å·²é€²å…¥ç›®æ¨™å‰ 10%~15% å€é–“ï¼šå»ºè­°åˆ†æ‰¹è§£é™¤è³ªæŠ¼ã€‚"
                    : "å°šæœªé€²å…¥æµå‹•æ€§å€é–“ï¼ˆç›®æ¨™å‰ 10%~15%ï¼‰ã€‚"}
                </div>

                <button
                  onClick={()=>{
                    setState(p=>({ ...p, adaUnstakeArmed: !p.adaUnstakeArmed }));
                    addLog(`ADA è§£è³ªæŠ¼è¨ˆç•«ï¼š${!state.adaUnstakeArmed ? "å·²å•Ÿå‹•" : "å·²å–æ¶ˆ"}`, "system");
                  }}
                  className={`w-full mb-2 py-2 rounded-lg text-xs font-bold ${state.adaUnstakeArmed ? "bg-yellow-600 text-slate-900" : "bg-slate-700 text-slate-200"}`}
                >
                  {state.adaUnstakeArmed ? "å·²å•Ÿå‹•è§£è³ªæŠ¼" : "æ¨™è¨˜ï¼šå•Ÿå‹•è§£è³ªæŠ¼"}
                </button>

                <button onClick={()=>confirmSnipeConvert("ADA")} className="w-full py-3 rounded-xl font-black bg-blue-600 hover:bg-blue-500">
                  ç‹™æ“ŠæˆåŠŸï¼ˆè¼¸å…¥å¯¦å¾—BTCï¼‰
                </button>
              </Card>

              <div className="h-6"></div>
            </div>
          )}

          {tab === "sop" && (
            <div className="space-y-4 animate-fade-in text-sm text-slate-300 leading-relaxed">
              <Card>
                <h3 className="font-bold text-yellow-300 mb-2">ğŸ›¡ï¸ {targetYear} ç›®æ¨™ {fmt(goalBtc,4)} BTCã€Šçµ‚æ¥µé˜²ç¦¦ãƒ»åŸ·è¡Œæ†²æ³•ã€‹</h3>
                <div className="text-xs text-slate-400">
                  åŸ·è¡ŒæœŸé–“ï¼š2026.02 - {targetYear}.12ï¼ˆ{planMonths} å€‹æœˆï¼‰ï½œåŸ·è¡Œäººï¼š[é™³ç¥¥è±ª]
                </div>
                <div className="text-xs text-slate-300 mt-2">
                  æˆ°ç•¥è¦–è§’ï¼šåšç©ºæ³•å¹£å´©å£ï¼Œåšå¤šæ•¸ä½æ–‡æ˜ã€‚<br/>
                  ç¸½ç›®æ¨™ï¼š{targetYear} å¹´åº•å‰é”æˆ {fmt(goalBtc,4)} BTCï¼ˆé¡†æ•¸ç‚ºå”¯ä¸€ KPIï¼‰ã€‚<br/>
                  BTC æ˜¯ç›¾ã€ETH/ADA æ˜¯çŸ›ï¼›å…ˆæ±‚ä¸æ­»ï¼Œå†æ±‚æ”¾å¤§ã€‚
                </div>
              </Card>

              <Card>
                <h3 className="font-bold text-emerald-300 mb-2">ğŸ’ æ ¸å¿ƒä¿¡æ¢</h3>
                <ul className="list-disc pl-4 space-y-1 text-xs">
                  <li>BTC æœ¬ä½ï¼šç›®æ¨™æ˜¯ BTC é¡†æ•¸ï¼Œä¸æ˜¯æ³•å¹£å¸‚å€¼ã€‚</li>
                  <li>å‰µæŠ•æ€ç¶­ï¼šETH/ADA ä¸å› çŸ­æœŸæ³¢å‹•è³¤è³£ã€‚</li>
                  <li>å…ˆæ±‚ä¸æ­»ï¼Œå†æ±‚æ”¾å¤§ï¼šé¢¨æ§å„ªå…ˆæ–¼å ±é…¬ã€‚</li>
                  <li>ä¸å¾—è‡¨å ´æ”¹è¦å‰‡ï¼šæ“ä½œä»¥æ†²æ³•ç‚ºæº–ã€‚</li>
                </ul>
              </Card>

              <Card>
                <h3 className="font-bold text-emerald-300 mb-2">âš”ï¸ ç¬¬ä¸€ç« ï¼šå®šæŠ•é€²æ”»æ¨¡çµ„ï¼ˆæœˆè–ª DCAï¼‰</h3>
                <ul className="list-disc pl-4 space-y-1 text-xs">
                  <li>æ¯æœˆæŠ•å…¥ï¼š{Math.round(monthlyDca)}Uï¼Œåˆ† 4 ä»½ï¼ˆæ¯ä»½ç´„ {partUsdt.toFixed(2)}Uï¼‰ã€‚</li>
                  <li>æ–°å¢è³‡é‡‘ 100% åªè²· BTCï¼Œä¸æ”¤å¹³å±±å¯¨å¹£ã€‚</li>
                  <li>A/B/C/D æè²ªåˆ†å±¤åŸ·è¡Œã€‚</li>
                  <li>é•·ç‰›ä¿éšªï¼šé€£çºŒé«˜è²ªå©ªå¾Œï¼Œå¼·åˆ¶è‡³å°‘æŠ•å…¥ 1 ä»½ï¼Œé¿å…è¸ç©ºã€‚</li>
                  <li>é å‚™é‡‘ä¸Šé™ï¼š{Math.round(reserveCap)}Uï¼ˆ=6å€‹æœˆæœˆæŠ•å…¥ï¼‰ï¼Œè¶…éå³æ¯æœˆè‡³å°‘ 1 ä»½å›è£œ BTCã€‚</li>
                </ul>
              </Card>

              <Card>
                <h3 className="font-bold text-amber-300 mb-2">ğŸ§­ æƒ…ç·’åˆ†å±¤åŸ·è¡Œï¼ˆæ¯é€±ï¼‰</h3>
                <div className="text-xs space-y-1">
                  <div>A å€ï¼ˆ&lt;20ï¼‰ï¼š4è²·0å­˜ + å•Ÿå‹•é»‘å¤©éµé å‚™é‡‘</div>
                  <div>B å€ï¼ˆ20~40ï¼‰ï¼š3è²·1å­˜</div>
                  <div>C å€ï¼ˆ40~75ï¼‰ï¼š2è²·2å­˜</div>
                  <div>D å€ï¼ˆ&gt;75ï¼‰ï¼š0è²·4å­˜ï¼›é€£çºŒ 2 å€‹æœˆå¾Œå•Ÿå‹•é•·ç‰›ä¿éšª 1è²·3å­˜ï¼ˆ4ä»½åˆ¶å›ºå®šï¼‰</div>
                </div>
              </Card>

              <Card>
                <h3 className="font-bold text-fuchsia-300 mb-2">ğŸ”„ ç¬¬äºŒç« ï¼šå‰µæŠ•ç­‰å¾…æ¨¡çµ„</h3>
                <ul className="list-disc pl-4 space-y-1 text-xs">
                  <li>ETH ç›®æ¨™ï¼š{ETH_SNIPE_RATIO}ï¼›ADA ç›®æ¨™ï¼š{ADA_SNIPE_RATIO}ã€‚</li>
                  <li>ä¸åˆ°ç›®æ¨™åŸå‰‡ä¸é›¢å ´ï¼Œä»¥è³ªæŠ¼è¤‡åˆ©å°æŠ—ç­‰å¾…æˆæœ¬ã€‚</li>
                  <li>é€²å…¥ç›®æ¨™å‰ 10%~15% å€é–“ï¼Œå•Ÿå‹•åˆ†æ‰¹è§£é™¤è³ªæŠ¼ã€‚</li>
                </ul>
              </Card>

              <Card>
                <h3 className="font-bold text-red-300 mb-2">ğŸ§± ç¬¬ä¸‰ç« ï¼šçµ‚æ¥µé˜²ç¦¦ï¼ˆé»‘å¤©éµï¼‰</h3>
                <ul className="list-disc pl-4 space-y-1 text-xs">
                  <li>è§¸ç™¼æ¢ä»¶ä»»ä¸€æˆç«‹ï¼š6M å›æ’¤ â‰¥30%ã€FNG &lt;20ã€è·Œç ´ 200Wã€‚</li>
                  <li>é å‚™é‡‘åˆ† 4 é€±ç­‰é¡è²·å…¥ BTCã€‚</li>
                  <li>è‹¥åå½ˆ &gt;15%ï¼Œåœæ­¢ç•¶æœŸåŠ ç¢¼ï¼Œä¿ç•™å½ˆè—¥ã€‚</li>
                </ul>
              </Card>

              <Card>
                <h3 className="font-bold text-sky-300 mb-2">ğŸ§  ç¬¬å››ç« ï¼šéµè¡€ç´€å¾‹èˆ‡å ´å¤– Alpha</h3>
                <ul className="list-disc pl-4 space-y-1 text-xs">
                  <li>ç†±éŒ¢åŒ… BTC â‰¥ 0.05 ç«‹å³æé ˜å†·éŒ¢åŒ…ã€‚</li>
                  <li>å–®ä¸€äº¤æ˜“æ‰€æ›éšª â‰¤ {EXCHANGE_RISK_CAP_PCT}%ã€‚</li>
                  <li>å–®ä¸€ç©©å®šå¹£æ›éšª â‰¤ {SINGLE_STABLECOIN_CAP_PCT}%ã€‚</li>
                  <li>è­¦å ±æœªéŸ¿ï¼šä¸äº¤æ˜“ã€ä¸é æ¸¬ã€å°ˆæ³¨æœ¬æ¥­ç¾é‡‘æµã€‚</li>
                </ul>
              </Card>

              <Card>
                <h3 className="font-bold text-amber-300 mb-2">ğŸ“ˆ é™„éŒ„ Aï¼šç›®æ¨™æ ¸ç®—ï¼ˆæ›´æ–°ç‰ˆï¼‰</h3>
                <div className="text-xs space-y-1">
                  <div>ETH å¯å…Œï¼š{appendixEthBase.toLocaleString()} Ã— {ETH_SNIPE_RATIO} = <span className="mono">{appendixEthBtc.toFixed(3)}</span> BTC</div>
                  <div>ADA å¯å…Œï¼š{appendixAdaBase.toLocaleString()} Ã— {ADA_SNIPE_RATIO} = <span className="mono">{appendixAdaBtc.toFixed(3)}</span> BTC</div>
                  <div>DCA é ä¼°ï¼š{Math.round(monthlyDca)} Ã— {planMonths} / {APPENDIX_DCA_AVG_PRICE.toLocaleString()} â‰ˆ <span className="mono">{appendixDcaBtc.toFixed(3)}</span> BTC</div>
                  <div>ç¾æœ‰ BTCï¼š<span className="mono">{appendixCurrentBtc.toFixed(3)}</span> BTC</div>
                  <div>ç¸½é ä¼°æˆ°åŠ›ï¼šç´„ <span className="mono">{appendixTotalBtc.toFixed(3)}</span> BTC</div>
                  <div>è·é›¢ç›®æ¨™å°šå·®ï¼š<span className="mono">{appendixGapBtc.toFixed(3)}</span> BTC</div>
                  <div>DCA ç¸½é¡ï¼ˆ{planMonths} å€‹æœˆï¼‰ï¼š<span className="mono">{appendixDcaTotal.toLocaleString(undefined,{maximumFractionDigits:0})}</span> Uï¼ˆç´„ NT$ {(appendixDcaTotal * 32.5).toLocaleString(undefined,{maximumFractionDigits:0})}ï¼‰</div>
                </div>
              </Card>

              <div className="h-8"></div>
            </div>
          )}

          {tab === "system" && (
            <div className="space-y-4 animate-fade-in">
              <Card>
                <h3 className="font-bold text-white mb-2">ğŸ›ï¸ é•·æœŸå¯èª¿è¨­å®š</h3>
                <div className="text-xs text-slate-300 space-y-1 mb-3">
                  <div>æœˆæŠ•å…¥ï¼š<span className="mono">{Math.round(monthlyDca)}U</span>ï¼ˆæ¯ä»½ç´„ {partUsdt.toFixed(2)}Uï¼‰</div>
                  <div>ç›®æ¨™ï¼š<span className="mono">{fmt(goalBtc,4)} BTC</span></div>
                  <div>ç›®æ¨™å¹´ä»½ï¼š<span className="mono">{targetYear}</span></div>
                  <div>ç›®å‰æŒæœ‰ï¼š<span className="mono">{fmt(totalBtc,6)} BTC</span></div>
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <button onClick={openPlanSettings} className="bg-emerald-700 py-3 rounded-xl font-bold text-sm">èª¿æ•´ç›®æ¨™/å¹´ä»½/æœˆæŠ•å…¥</button>
                  <button onClick={openHoldingsEditor} className="bg-sky-700 py-3 rounded-xl font-bold text-sm">èª¿æ•´ç›®å‰ BTC æŒæœ‰</button>
                </div>
              </Card>

              <Card>
                <h3 className="font-bold text-white mb-2">ğŸ’¾ å‚™ä»½ / é‚„åŸ</h3>
                <p className="text-xs text-slate-400 mb-4">è³‡æ–™åªå­˜åœ¨æœ¬æ©Ÿã€‚æ›æ‰‹æ©Ÿ/æ¸…å¿«å–å‰è«‹å…ˆåŒ¯å‡ºå‚™ä»½ã€‚</p>
                <div className="grid grid-cols-2 gap-3">
                  <button onClick={exportData} className="bg-emerald-700 py-3 rounded-xl font-bold text-sm">åŒ¯å‡ºå‚™ä»½</button>
                  <button onClick={importData} className="bg-slate-700 py-3 rounded-xl font-bold text-sm text-slate-200">é‚„åŸå‚™ä»½</button>
                </div>
              </Card>

              <Card>
                <h3 className="font-bold text-white mb-2">ğŸ§· å°æ‰‹æ–¹é¢¨éšªæ¢æ¬¾</h3>
                <div className="grid grid-cols-2 gap-3 mb-2">
                  <InputField
                    id="singleExchangeRiskPct"
                    label={`å–®ä¸€äº¤æ˜“æ‰€æ›éšª%ï¼ˆä¸Šé™ ${EXCHANGE_RISK_CAP_PCT}%ï¼‰`}
                    defaultVal={draftRef.current.singleExchangeRiskPct}
                    onCommit={(v)=>{
                      const n = clamp(parseNum(v, ui.singleExchangeRiskPct), 0, 100);
                      updateInput("singleExchangeRiskPct", n);
                      setUi(p=>({ ...p, singleExchangeRiskPct: n }));
                    }}
                  />
                  <InputField
                    id="singleStablecoinRiskPct"
                    label={`å–®ä¸€ç©©å®šå¹£æ›éšª%ï¼ˆä¸Šé™ ${SINGLE_STABLECOIN_CAP_PCT}%ï¼‰`}
                    defaultVal={draftRef.current.singleStablecoinRiskPct}
                    onCommit={(v)=>{
                      const n = clamp(parseNum(v, ui.singleStablecoinRiskPct), 0, 100);
                      updateInput("singleStablecoinRiskPct", n);
                      setUi(p=>({ ...p, singleStablecoinRiskPct: n }));
                    }}
                  />
                </div>
                <div className="text-xs space-y-1">
                  <div className={ui.singleExchangeRiskPct > EXCHANGE_RISK_CAP_PCT ? "text-red-300" : "text-slate-300"}>
                    äº¤æ˜“æ‰€æ›éšªï¼š{ui.singleExchangeRiskPct.toFixed(1)}%ï¼ˆä¸Šé™ {EXCHANGE_RISK_CAP_PCT}%ï¼‰
                  </div>
                  <div className={ui.singleStablecoinRiskPct > SINGLE_STABLECOIN_CAP_PCT ? "text-red-300" : "text-slate-300"}>
                    å–®ä¸€ç©©å®šå¹£æ›éšªï¼š{ui.singleStablecoinRiskPct.toFixed(1)}%ï¼ˆä¸Šé™ {SINGLE_STABLECOIN_CAP_PCT}%ï¼‰
                  </div>
                </div>
              </Card>

              <Card>
                <h3 className="font-bold text-white mb-2">ğŸ¯ æ¯æœˆç´€å¾‹è©•åˆ†ï¼ˆ0â€“100ï¼‰</h3>
                <div className="text-xs text-slate-400 mb-2">æœˆä»½ï¼š{currentMonthKey}</div>
                <div className="grid grid-cols-2 gap-2 text-xs">
                  <button onClick={()=>setDisciplineFlag("ruleExec", !currentDiscipline.ruleExec)} className={`py-2 rounded-lg font-bold ${currentDiscipline.ruleExec ? "bg-emerald-700 text-white" : "bg-slate-700 text-slate-200"}`}>ä¾è¦åŸ·è¡Œ +25</button>
                  <button onClick={()=>setDisciplineFlag("noEmotion", !currentDiscipline.noEmotion)} className={`py-2 rounded-lg font-bold ${currentDiscipline.noEmotion ? "bg-emerald-700 text-white" : "bg-slate-700 text-slate-200"}`}>ç„¡æƒ…ç·’äº¤æ˜“ +25</button>
                  <button onClick={()=>setDisciplineFlag("coldWallet", !currentDiscipline.coldWallet)} className={`py-2 rounded-lg font-bold ${currentDiscipline.coldWallet ? "bg-emerald-700 text-white" : "bg-slate-700 text-slate-200"}`}>å†·éŒ¢åŒ…é”æ¨™ +25</button>
                  <button onClick={()=>setDisciplineFlag("fullRecord", !currentDiscipline.fullRecord)} className={`py-2 rounded-lg font-bold ${currentDiscipline.fullRecord ? "bg-emerald-700 text-white" : "bg-slate-700 text-slate-200"}`}>è¨˜éŒ„å®Œæ•´ +25</button>
                </div>
                <div className="mt-3 text-sm font-bold text-amber-300">æœ¬æœˆç´€å¾‹åˆ†æ•¸ï¼š{disciplineScore} / 100</div>
              </Card>

              <Card>
                <h3 className="font-bold text-white mb-2">ğŸ”“ æœ¬é€±é–</h3>
                <div className="text-xs text-slate-300">
                  ç‹€æ…‹ï¼š{canExecuteThisWeek ? "æœªåŸ·è¡Œï¼ˆå¯æŒ‰ï¼‰" : "å·²åŸ·è¡Œï¼ˆé–å®šï¼‰"}<br/>
                  lastWeeklyExecISOï¼š{state.lastWeeklyExecISO ? state.lastWeeklyExecISO : "null"}
                </div>
                <button onClick={unlockThisWeek} className="mt-3 w-full bg-yellow-500 hover:bg-yellow-400 py-3 rounded-xl font-black text-slate-900">
                  è§£é–æœ¬é€±åŸ·è¡Œ
                </button>
              </Card>

              <Card>
                <h3 className="font-bold text-white mb-2">ğŸ§¯ é‡ç½®</h3>
                <p className="text-xs text-slate-400 mb-4">æ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼ˆå« Logs / é€±é–ï¼‰ã€‚è«‹å…ˆåŒ¯å‡ºå‚™ä»½ã€‚</p>
                <button onClick={resetAll} className="w-full bg-red-600 hover:bg-red-500 py-3 rounded-xl font-bold text-sm text-white">
                  é‡ç½®å…¨éƒ¨è³‡æ–™
                </button>
              </Card>

              <Card>
                <h3 className="font-bold text-white mb-2">ğŸ‘ï¸ éš±ç§</h3>
                <div className="flex justify-between items-center">
                  <span className="text-sm text-slate-300">éš±ç§æ¨¡å¼ï¼ˆéš±è—é‡‘é¡ï¼‰</span>
                  <button
                    onClick={()=>setPrivacyMode(!privacyMode)}
                    className={`px-3 py-1 rounded text-xs font-bold ${privacyMode ? "bg-emerald-600" : "bg-slate-700"}`}
                  >
                    {privacyMode ? "ON" : "OFF"}
                  </button>
                </div>
              </Card>

              <Card>
                <h3 className="font-bold text-white mb-2">ğŸ§¾ ç³»çµ±è³‡è¨Š</h3>
                <div className="text-xs text-slate-400">
                  Buildï¼šv7-flex-goal-year-monthlyï½œè³‡æ–™æºï¼š{ui.dataSource}
                </div>
              </Card>

              <div className="h-8"></div>
            </div>
          )}
        </div>
      </div>

      {!HIDE_TABBAR && (
        <div className="tabbar" ref={tabbarRef}>
          <div className="tabbar-inner">
            <TabBtn id="home" label="è¡Œå‹•" icon="âš¡" />
            <TabBtn id="convert" label="ç‹™æ“Š" icon="ğŸ¯" />
            <TabBtn id="sop" label="æ†²æ³•" icon="ğŸ“œ" />
            <TabBtn id="system" label="ç³»çµ±" icon="ğŸ’¾" />
          </div>
        </div>
      )}

      {modal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in"
             onClick={(e)=> e.target===e.currentTarget && setModal(null)}>
          <div className="bg-slate-800 border border-slate-600 w-full max-w-sm rounded-2xl p-6 shadow-2xl relative">
            <h3 className="text-xl font-bold text-white mb-4">{modal.title}</h3>
            {renderModalBody()}
            <button onClick={()=>setModal(null)} className="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-xl text-white font-bold">
              é—œé–‰
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);

if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}
</script>


</body></html>