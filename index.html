<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Project 2030：執行憲法（3 BTC）</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <style>
    body { background:#0b1220; -webkit-tap-highlight-color: transparent; }
    input, button, textarea, select { font-size: 16px; } /* iOS: prevent zoom/keyboard collapse */
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .pb-safe { padding-bottom: calc(88px + env(safe-area-inset-bottom)); }
  </style>
</head>

<body class="text-slate-100">
<div id="root"></div>

<script>
const { useEffect, useMemo, useRef, useState } = React;

/* ===== Constants ===== */
const GOAL_BTC = 3.0;
const TARGET_DATE = new Date("2030-12-31T00:00:00+08:00").getTime();
const SAVE_KEY = "p2030_full_app_v99004";

const PART = 60;
const MONTH_PARTS = 3;

const GREED_THRESHOLD = 75;
const GREED_WEEKS_FOR_INSURANCE = 8;

const BLACK_SWAN_WEEKS = 4;
const BLACK_SWAN_STOP_REBOUND = 15;

const ETH_STAGE1 = 0.060;
const ETH_STAGE2 = 0.065;
const ETH_STAGE3 = 0.075;

const ADA_STAGE1 = 0.000010;
const ADA_STAGE2 = 0.000013;

const BUYBACK_DROP_STAGE1 = 15;
const BUYBACK_DROP_STAGE2 = 20;
const BUYBACK_DEADLINE_DAYS = 90;

/* ===== Helpers ===== */
function clamp(v, min, max){ return Math.min(max, Math.max(min, v)); }
function parseNum(s, fallback = NaN){
  const n = Number(String(s ?? "").replace(/,/g,"").trim());
  return Number.isFinite(n) ? n : fallback;
}
function fmt(n, d=4){ return Number(n||0).toFixed(d); }
function monthKeyNow(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  return `${y}-${m}`;
}
function todayMMDD(){
  return new Date().toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit'});
}
function isoPlusDays(days){
  const d = new Date();
  d.setDate(d.getDate() + days);
  return d.toISOString();
}
function daysLeftToISO(iso){
  const t = new Date(iso).getTime() - Date.now();
  return Math.max(0, Math.ceil(t / (1000*60*60*24)));
}
function reboundPctFrom(low, now){
  if(!(low > 0) || !(now > 0)) return 0;
  return ((now - low) / low) * 100;
}

/* ===== Initial State ===== */
function initialStateNow(){
  return {
    btcHot: 0.0,
    btcCold: 0.0,

    usdtReserve: 0,
    eth: 34.0,
    ada: 74000.0,

    logs: [],
    consecutiveGreedWeeks: 0,

    monthPartsRemaining: MONTH_PARTS,
    lastMonthKey: monthKeyNow(),

    blackSwan: {
      active: false,
      remainingWeeks: 0,
      weeklyBudget: 0,
      startedAtISO: null,
      reason: null,
      anchorPrice: 0,
      lowPrice: 0
    },

    pendingOrders: []
  };
}

function App(){
  const [state, setState] = useState(initialStateNow());
  const [tab, setTab] = useState("home");
  const [modal, setModal] = useState(null);

  // iPhone: uncontrolled inputs
  const draftRef = useRef({
    btcPrice: "90000",
    fngIndex: "50",
    ethBtcRatio: "0.050",
    adaBtcRatio: "0.000008",
    athDrawdownPct: "0",
    below200w: "0",
    reboundPct: "0",
    extraReserveAdd: "0",
  });

  const [ui, setUi] = useState({
    btcPrice: 90000,
    fngIndex: 50,
    ethBtcRatio: 0.050,
    adaBtcRatio: 0.000008,
    athDrawdownPct: 0,
    below200w: 0,
    reboundPct: 0,
    ma200w: 0,
    ma200wUpdatedAt: 0
  });

  // ETH stage modal refs
  const ethStageBtcRef = useRef("");
  const ethStageUsdtRef = useRef("");

  const addLog = (msg, type="info") => {
    const log = { id: Date.now() + Math.random(), date: todayMMDD(), msg, type };
    setState(prev => ({ ...prev, logs: [log, ...prev.logs].slice(0, 220) }));
  };

  /* ===== Load/Save ===== */
  useEffect(() => {
    try{
      const saved = localStorage.getItem(SAVE_KEY);
      if(saved){
        const parsed = JSON.parse(saved);
        setState({ ...initialStateNow(), ...parsed });
      }else{
        addLog("系統初始化完成。目標：2030 累積 3 BTC。", "system");
      }
    }catch(e){ console.log(e); }
    // eslint-disable-next-line
  }, []);

  useEffect(() => {
    try{ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }catch(e){}
  }, [state]);

  /* ===== Derived ===== */
  const totalBtc = state.btcHot + state.btcCold;
  const progress = clamp((totalBtc / GOAL_BTC) * 100, 0, 100);
  const daysLeft = useMemo(() => Math.max(0, Math.ceil((TARGET_DATE - Date.now())/(1000*60*60*24))), [totalBtc]);

  const stableTotal = useMemo(() => {
    const openOrders = state.pendingOrders.filter(o => o.status === "open");
    const ordersUsdt = openOrders.reduce((s,o)=>s + (o.usdtAmount||0), 0);
    return (state.usdtReserve||0) + ordersUsdt;
  }, [state.usdtReserve, state.pendingOrders]);

  const portfolioUsdApprox = useMemo(() => {
    const btcUSD = totalBtc * (ui.btcPrice || 0);
    const ethUSD = state.eth * (ui.ethBtcRatio || 0) * (ui.btcPrice || 0);
    const adaUSD = state.ada * (ui.adaBtcRatio || 0) * (ui.btcPrice || 0);
    return btcUSD + ethUSD + adaUSD + stableTotal;
  }, [totalBtc, ui.btcPrice, ui.ethBtcRatio, ui.adaBtcRatio, state.eth, state.ada, stableTotal]);

  const stablePct = useMemo(() => (portfolioUsdApprox>0 ? (stableTotal/portfolioUsdApprox*100) : 0), [stableTotal, portfolioUsdApprox]);

  const setInputValue = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.value = String(val);
  };

  /* ===== Pure-frontend fetch helpers (Safari friendly) ===== */
  const parseLooseJson = (text) => {
    const s = String(text || "");
    const i1 = s.indexOf("{");
    const i2 = s.indexOf("[");
    let i = -1;
    if (i1 === -1) i = i2;
    else if (i2 === -1) i = i1;
    else i = Math.min(i1, i2);
    if (i < 0) throw new Error("JSON not found in response");
    const sliced = s.slice(i).trim();
    return JSON.parse(sliced);
  };

  const fetchText = async (url, timeoutMs = 12000) => {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeoutMs);
    try {
      const res = await fetch(url, { cache: "no-store", signal: ctrl.signal });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.text();
    } finally {
      clearTimeout(t);
    }
  };

  const proxyUrl = (url) => "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
  const jinaUrl = (url) => "https://r.jina.ai/http://" + url.replace(/^https?:\/\//, "");

  const fetchJsonSmart = async (url, timeoutMs = 12000) => {
    // 1) direct
    try {
      const txt = await fetchText(url, timeoutMs);
      return parseLooseJson(txt);
    } catch (e1) {
      addLog(`直連失敗：${String(e1)}`, "warning");
    }

    // 2) allorigins
    try {
      const txt = await fetchText(proxyUrl(url), timeoutMs + 4000);
      return parseLooseJson(txt);
    } catch (e2) {
      addLog(`AllOrigins 失敗：${String(e2)}`, "warning");
    }

    // 3) jina.ai
    const txt = await fetchText(jinaUrl(url), timeoutMs + 6000);
    return parseLooseJson(txt);
  };

  const withRetry = async (fn, tries = 3) => {
    let last = null;
    for (let i = 0; i < tries; i++) {
      try { return await fn(); }
      catch (e) {
        last = e;
        await new Promise(r => setTimeout(r, [600, 1400, 2600][i] ?? 2600));
      }
    }
    throw last;
  };

  const CACHE_KEY_METRICS = "p2030_metrics_cache_v1";
  const loadMetricsCache = () => {
    try { return JSON.parse(localStorage.getItem(CACHE_KEY_METRICS) || "null"); }
    catch { return null; }
  };
  const saveMetricsCache = (payload) => {
    try { localStorage.setItem(CACHE_KEY_METRICS, JSON.stringify({ ts: Date.now(), ...payload })); }
    catch {}
  };

  // 200W MA
  const calc200wMA_fromCC = async () => {
    const cc = await withRetry(() =>
      fetchJsonSmart("https://min-api.cryptocompare.com/data/v2/histoweek?fsym=BTC&tsym=USD&limit=220", 15000)
    );
    if (cc?.Response === "Error") throw new Error(cc?.Message || "CryptoCompare histoweek Error");
    const arr = cc?.Data?.Data || [];
    const closes = arr.map(x => Number(x?.close) || 0).filter(x => x > 0);
    if (closes.length < 200) throw new Error(`週線資料不足：${closes.length}`);
    const last200 = closes.slice(-200);
    const ma = last200.reduce((s, x) => s + x, 0) / last200.length;
    if (!(Number.isFinite(ma) && ma > 0)) throw new Error("MA 計算無效");
    return ma;
  };

  const calc200wMA_fromCG = async () => {
    const cg = await withRetry(() =>
      fetchJsonSmart("https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=2000&interval=daily", 20000)
    );
    const prices = (cg?.prices || []).map(p => Number(p?.[1]) || 0).filter(x => x > 0);
    if (prices.length < 800) throw new Error(`日線資料不足：${prices.length}`);
    const last1400 = prices.length > 1400 ? prices.slice(-1400) : prices;
    const ma = last1400.reduce((s, x) => s + x, 0) / last1400.length;
    if (!(Number.isFinite(ma) && ma > 0)) throw new Error("MA 計算無效");
    return ma;
  };

  // 6M DD
  const calc6mDD_fromCC = async (nowPrice) => {
    const cc = await withRetry(() =>
      fetchJsonSmart("https://min-api.cryptocompare.com/data/v2/histoday?fsym=BTC&tsym=USD&limit=200", 15000)
    );
    if (cc?.Response === "Error") throw new Error(cc?.Message || "CryptoCompare histoday Error");
    const arr = cc?.Data?.Data || [];
    const highs = arr.map(x => Number(x?.high) || 0).filter(x => x > 0);
    if (highs.length < 30) throw new Error(`high不足：${highs.length}`);
    const hi = Math.max(...highs.slice(-180));
    if (!(hi > 0) || !(nowPrice > 0)) throw new Error("高點或現價無效");
    return Math.max(0, ((hi - nowPrice) / hi) * 100);
  };

  const calc6mDD_fromCG = async (nowPrice) => {
    const cg = await withRetry(() =>
      fetchJsonSmart("https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=200&interval=daily", 20000)
    );
    const prices = (cg?.prices || []).map(p => Number(p?.[1]) || 0).filter(x => x > 0);
    if (prices.length < 30) throw new Error(`價格不足：${prices.length}`);
    const hi = Math.max(...prices);
    if (!(hi > 0) || !(nowPrice > 0)) throw new Error("高點或現價無效");
    return Math.max(0, ((hi - nowPrice) / hi) * 100);
  };

  /* ===== Autofill (max success, manual-friendly) ===== */
  const autofillFromApis = async () => {
    try {
      addLog("自動抓取中…（直連→AllOrigins→Jina）", "system");

      // short cache (1 min)
      const cache = loadMetricsCache();
      if (cache && cache.ts && (Date.now() - cache.ts) < 60_000) {
        const { btcUsd, fng, ethBtc, adaBtc, ma200w, below200w, dd6m } = cache;
        if (btcUsd > 0) { draftRef.current.btcPrice = String(btcUsd); setInputValue("btcPrice", btcUsd); }
        if (Number.isFinite(fng)) { draftRef.current.fngIndex = String(fng); setInputValue("fngIndex", fng); }
        if (ethBtc > 0) { draftRef.current.ethBtcRatio = String(ethBtc); setInputValue("ethBtcRatio", ethBtc); }
        if (adaBtc > 0) { draftRef.current.adaBtcRatio = String(adaBtc); setInputValue("adaBtcRatio", adaBtc); }
        if (Number.isFinite(dd6m)) { draftRef.current.athDrawdownPct = dd6m.toFixed(2); setInputValue("athDrawdownPct", dd6m.toFixed(2)); }
        if (typeof below200w === "number") draftRef.current.below200w = String(below200w);

        setUi(prev => ({
          ...prev,
          ...(btcUsd > 0 ? { btcPrice: btcUsd } : {}),
          ...(Number.isFinite(fng) ? { fngIndex: fng } : {}),
          ...(ethBtc > 0 ? { ethBtcRatio: ethBtc } : {}),
          ...(adaBtc > 0 ? { adaBtcRatio: adaBtc } : {}),
          ...(Number.isFinite(dd6m) ? { athDrawdownPct: dd6m } : {}),
          ...(Number.isFinite(ma200w) ? { ma200w } : {}),
          ...(typeof below200w === "number" ? { below200w } : {})
        }));

        addLog("已使用 1 分鐘內快取值（Safari 防連續失敗）", "system");
        return;
      }

      // 1) FNG
      const fngJson = await withRetry(() =>
        fetchJsonSmart("https://api.alternative.me/fng/?limit=1&format=json", 15000)
      );
      const fng = clamp(parseInt(fngJson?.data?.[0]?.value ?? "0", 10), 0, 100);

      // 2) Prices: CryptoCompare first, fallback CoinGecko
      let btcUsd = 0, ethUsd = 0, adaUsd = 0;
      let src = "cryptocompare";
      try {
        const cc = await withRetry(() =>
          fetchJsonSmart("https://min-api.cryptocompare.com/data/pricemulti?fsyms=BTC,ETH,ADA&tsyms=USD", 15000)
        );
        if (cc?.Response === "Error") throw new Error(cc?.Message || "CryptoCompare Error");
        btcUsd = Math.round(Number(cc?.BTC?.USD || 0));
        ethUsd = Number(cc?.ETH?.USD || 0);
        adaUsd = Number(cc?.ADA?.USD || 0);
        src = "cryptocompare";
        if (!(btcUsd > 0)) throw new Error("BTC invalid");
      } catch (e) {
        addLog(`pricemulti 失敗→改用 CoinGecko：${String(e)}`, "warning");
        const cg = await withRetry(() =>
          fetchJsonSmart("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,cardano&vs_currencies=usd", 20000)
        );
        btcUsd = Math.round(cg?.bitcoin?.usd ?? 0);
        ethUsd = Number(cg?.ethereum?.usd ?? 0);
        adaUsd = Number(cg?.cardano?.usd ?? 0);
        src = "coingecko";
      }
      if (!(btcUsd > 0)) throw new Error("BTC price invalid");

      const ethBtc = ethUsd > 0 ? ethUsd / btcUsd : 0;
      const adaBtc = adaUsd > 0 ? adaUsd / btcUsd : 0;

      // 3) 200W MA
      let ma200w = 0;
      if (src === "cryptocompare") {
        try { ma200w = await calc200wMA_fromCC(); } catch (e) { addLog(`200W(週線)失敗：${String(e)}`, "warning"); }
        if (!(ma200w > 0)) {
          try { ma200w = await calc200wMA_fromCG(); } catch (e) { addLog(`200W(日線備援)失敗：${String(e)}`, "warning"); }
        }
      } else {
        try { ma200w = await calc200wMA_fromCG(); } catch (e) { addLog(`200W(日線)失敗：${String(e)}`, "warning"); }
        if (!(ma200w > 0)) {
          try { ma200w = await calc200wMA_fromCC(); } catch (e) { addLog(`200W(週線備援)失敗：${String(e)}`, "warning"); }
        }
      }
      const below200w = (ma200w > 0 && btcUsd < ma200w) ? 1 : 0;

      // 4) 6M drawdown (same-source)
      let dd6m = 0;
      if (src === "cryptocompare") {
        try { dd6m = await calc6mDD_fromCC(btcUsd); }
        catch (e) { addLog(`6M(CC)失敗：${String(e)}`, "warning"); dd6m = await calc6mDD_fromCG(btcUsd); }
      } else {
        try { dd6m = await calc6mDD_fromCG(btcUsd); }
        catch (e) { addLog(`6M(CG)失敗：${String(e)}`, "warning"); dd6m = await calc6mDD_fromCC(btcUsd); }
      }

      // 5) Write to inputs + UI (success updates; failure keeps old)
      draftRef.current.btcPrice = String(btcUsd); setInputValue("btcPrice", btcUsd);
      draftRef.current.fngIndex = String(fng); setInputValue("fngIndex", fng);
      if (ethBtc > 0) { draftRef.current.ethBtcRatio = String(ethBtc); setInputValue("ethBtcRatio", ethBtc); }
      if (adaBtc > 0) { draftRef.current.adaBtcRatio = String(adaBtc); setInputValue("adaBtcRatio", adaBtc); }
      draftRef.current.athDrawdownPct = dd6m.toFixed(2); setInputValue("athDrawdownPct", dd6m.toFixed(2));
      draftRef.current.below200w = String(below200w);

      setUi(prev => ({
        ...prev,
        btcPrice: btcUsd,
        fngIndex: fng,
        ethBtcRatio: ethBtc || prev.ethBtcRatio,
        adaBtcRatio: adaBtc || prev.adaBtcRatio,
        athDrawdownPct: dd6m,
        ma200w: ma200w > 0 ? ma200w : prev.ma200w,
        below200w: ma200w > 0 ? below200w : prev.below200w
      }));

      // 6) rebound during black swan
      if (state.blackSwan && state.blackSwan.active) {
        const low = state.blackSwan.lowPrice > 0 ? state.blackSwan.lowPrice : btcUsd;
        const newLow = Math.min(low, btcUsd);
        const rb = reboundPctFrom(newLow, btcUsd);
        if (newLow !== low) setState(prev => ({ ...prev, blackSwan: { ...prev.blackSwan, lowPrice: newLow } }));
        setUi(prev => ({ ...prev, reboundPct: rb }));
        draftRef.current.reboundPct = rb.toFixed(2);
        setInputValue("reboundPct", rb.toFixed(2));
      }

      // 7) cache
      saveMetricsCache({ btcUsd, fng, ethBtc, adaBtc, ma200w, below200w, dd6m, src });

      addLog(`抓取成功(src=${src})｜6M回撤≈${dd6m.toFixed(2)}%｜200W=${ma200w>0?Math.round(ma200w):"?"}`, "success");

    } catch (e) {
      addLog(`自動抓取失敗：${String(e)}`, "warning");
      setModal({
        mode:"info",
        title:"自動抓取失敗（可手動更新）",
        body:
`Safari 常見跨域/限流，已嘗試 直連→AllOrigins→Jina 三重備援仍失敗。

你可以直接手動在欄位輸入：
- BTC 價格、恐貪
- ETH/BTC、ADA/BTC
- 6M ATH 回撤%
- 200W MA（可留空，不影響執行）
- 反彈%

然後照常按「執行本週決策」。`
      });
    }
  };

  useEffect(()=>{ autofillFromApis(); },[]); // eslint-disable-line

  /* ===== UI Components ===== */
  const Chip = ({active, children, onClick}) => (
    React.createElement("button", { onClick,
      className: "px-3 py-2 rounded-xl text-sm font-semibold " + (active ? "bg-emerald-600 text-white" : "bg-slate-800 text-slate-300")
    }, children)
  );

  const Field = ({label, name, id, inputMode="decimal", placeholder=""}) => (
    React.createElement("div", { className:"space-y-1" },
      React.createElement("div", { className:"text-xs text-slate-400" }, label),
      React.createElement("input", {
        id: id || undefined,
        defaultValue: draftRef.current[name],
        inputMode,
        placeholder,
        className:"w-full bg-slate-900 border border-slate-700 rounded-2xl px-4 py-3 text-lg mono focus:outline-none focus:ring-2 focus:ring-emerald-500",
        onInput:(e)=>{ draftRef.current[name] = e.target.value; },
        onBlur:()=>{ const v=parseNum(draftRef.current[name], NaN); if(Number.isFinite(v)) setUi(p=>({ ...p, [name]: v })); },
        autoCorrect:"off", autoCapitalize:"off", spellCheck:false
      })
    )
  );

  const Toggle01 = ({label, name}) => (
    React.createElement("div", { className:"flex items-center justify-between bg-slate-900 border border-slate-700 rounded-2xl px-4 py-3" },
      React.createElement("div", { className:"text-sm text-slate-200" }, label),
      React.createElement("button", {
        className: "px-3 py-2 rounded-xl text-xs font-bold " + (Number(ui[name]||0)===1 ? "bg-emerald-600" : "bg-slate-700"),
        onClick:()=>{ const next = Number(ui[name]||0)===1 ? 0 : 1; setUi(p=>({ ...p, [name]: next })); draftRef.current[name]=String(next); }
      }, Number(ui[name]||0)===1 ? "ON" : "OFF")
    )
  );  /* ===== Backup ===== */
  const copyToClipboard = async (text) => {
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(e){}
    try{
      const ta=document.createElement("textarea");
      ta.value=text; ta.style.position="fixed"; ta.style.left="-9999px";
      document.body.appendChild(ta); ta.focus(); ta.select();
      const ok=document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }catch(e){ return false; }
  };

  const exportBackup = () => {
    const payload = { schema:"project2030-backup-v1", exportedAtISO:new Date().toISOString(), state, ui, draft: draftRef.current };
    setModal({ mode:"export", title:"匯出備份", json: JSON.stringify(payload, null, 2) });
  };

  const importBackup = (jsonText) => {
    try{
      const obj = JSON.parse(jsonText);
      if(!(obj && obj.schema==="project2030-backup-v1" && obj.state)) throw new Error("bad");
      setState({ ...initialStateNow(), ...obj.state });
      if(obj.ui) setUi(prev => ({ ...prev, ...obj.ui }));
      if(obj.draft) draftRef.current = { ...draftRef.current, ...obj.draft };

      if(draftRef.current.btcPrice) setInputValue("btcPrice", draftRef.current.btcPrice);
      if(draftRef.current.fngIndex) setInputValue("fngIndex", draftRef.current.fngIndex);
      if(draftRef.current.ethBtcRatio) setInputValue("ethBtcRatio", draftRef.current.ethBtcRatio);
      if(draftRef.current.adaBtcRatio) setInputValue("adaBtcRatio", draftRef.current.adaBtcRatio);
      if(draftRef.current.athDrawdownPct) setInputValue("athDrawdownPct", draftRef.current.athDrawdownPct);
      if(draftRef.current.reboundPct) setInputValue("reboundPct", draftRef.current.reboundPct);

      addLog("已匯入備份並覆蓋目前資料。", "success");
      setModal({ mode:"info", title:"匯入成功", body:"備份已匯入。" });
    }catch(e){
      setModal({ mode:"info", title:"匯入失敗", body:"JSON 格式不正確或不是本 App 的備份。" });
    }
  };

  /* ===== Reserve / Reset / Cold ===== */
  const addExtraReserve = () => {
    const add = Math.max(0, Math.floor(parseNum(draftRef.current.extraReserveAdd, 0)));
    if(!(add>0)){
      setModal({ mode:"info", title:"輸入錯誤", body:"請輸入要補充的預備金（正整數）" });
      return;
    }
    setState(prev => ({ ...prev, usdtReserve: prev.usdtReserve + add }));
    addLog(`手動補充預備金：+${add} U`, "success");
    draftRef.current.extraReserveAdd = "0";
    setModal({ mode:"info", title:"補充成功", body:`已補充預備金 +${add} U` });
  };

  const resetAll = () => {
    try{ localStorage.removeItem(SAVE_KEY); }catch(e){}
    const init = initialStateNow();
    setState({ ...init, logs: [] });
    setUi({
      btcPrice: 90000, fngIndex: 50,
      ethBtcRatio: 0.050, adaBtcRatio: 0.000008,
      athDrawdownPct: 0, below200w: 0, reboundPct: 0,
      ma200w: 0, ma200wUpdatedAt: 0
    });
    draftRef.current = {
      btcPrice:"90000", fngIndex:"50", ethBtcRatio:"0.050", adaBtcRatio:"0.000008",
      athDrawdownPct:"0", below200w:"0", reboundPct:"0", extraReserveAdd:"0"
    };
    setModal({ mode:"info", title:"已重置", body:"所有資料已清空，並回到初始值。" });
  };

  const moveCold = () => {
    if(state.btcHot < 0.05){
      setModal({ mode:"info", title:"指令拒絕", body:"未達 0.05 BTC 門檻，請節省手續費。" });
      return;
    }
    const amount = state.btcHot;
    setState(prev => ({ ...prev, btcHot:0, btcCold: prev.btcCold + amount }));
    addLog(`提領 ${amount.toFixed(6)} BTC 至冷錢包`, "secure");
    setModal({ mode:"info", title:"資產轉移", body:`成功移入冷錢包：${amount.toFixed(6)} BTC` });
  };

  /* ===== Orders / Conversion (kept) ===== */
  const createUsdtBuybackOrder = (usdtAmount, dropPct) => {
    const btcPrice = Number(ui.btcPrice || 0);
    if(!(btcPrice>0)) return null;
    const usdt = Number(usdtAmount);
    if(!(usdt>0)) return null;
    const targetPrice = btcPrice * (1 - dropPct/100);
    return {
      id: Date.now() + Math.random(),
      createdAtISO: new Date().toISOString(),
      deadlineISO: isoPlusDays(BUYBACK_DEADLINE_DAYS),
      usdtAmount: usdt,
      refBtcPrice: btcPrice,
      dropPct,
      targetPrice,
      status: "open",
      btcReceived: 0
    };
  };

  const executeConvertDirectToBTC = (asset, amountAsset, btcReceived) => {
    const amount = Number(amountAsset);
    const btc = Number(btcReceived);
    if(!(amount>0) || !(btc>0)) return false;

    setState(prev => {
      const next = { ...prev };
      if(asset==="ETH"){ if(next.eth < amount) return prev; next.eth -= amount; }
      if(asset==="ADA"){ if(next.ada < amount) return prev; next.ada -= amount; }
      next.btcHot += btc;
      return next;
    });

    addLog(`[轉換] ${amount} ${asset} → ${btc.toFixed(6)} BTC`, "success");
    return true;
  };

  const executeConvertToUSDTWithOrder = (ethAmount, usdtReceived, dropPct) => {
    const eth = Number(ethAmount);
    const usdt = Number(usdtReceived);
    if(!(eth>0) || !(usdt>0)) return false;

    const order = createUsdtBuybackOrder(usdt, dropPct);
    if(!order){
      setModal({ mode:"info", title:"缺少資料", body:"請先在 HOME 輸入 BTC 價格，才能建立回接掛單。" });
      return false;
    }

    setState(prev => {
      if(prev.eth < eth) return prev;
      return { ...prev, eth: prev.eth - eth, pendingOrders: [order, ...prev.pendingOrders] };
    });

    addLog(`[轉換] ${eth} ETH → ${Math.floor(usdt)} USDT（回撤${dropPct}%接回｜90天回家）`, "warning");
    return true;
  };

  const checkAndBuybackOrders = () => {
    const btcPrice = Number(ui.btcPrice || 0);
    if(!(btcPrice>0)){
      setModal({ mode:"info", title:"缺少資料", body:"請先在 HOME 輸入 BTC 價格。" });
      return;
    }

    const nowISO = new Date().toISOString();
    let btcGained = 0;

    const updated = state.pendingOrders.map(o => {
      if(o.status !== "open") return o;
      if(btcPrice <= o.targetPrice){
        const btcBought = (o.usdtAmount||0) / btcPrice;
        btcGained += btcBought;
        return { ...o, status:"closed", closedReason:"target_hit_buyback", btcReceived: btcBought, closedAtISO: nowISO };
      }
      return o;
    });

    if(btcGained > 0){
      setState(prev => ({ ...prev, btcHot: prev.btcHot + btcGained, pendingOrders: updated }));
      addLog(`[掛單接回] 達標接回：+${btcGained.toFixed(6)} BTC`, "success");
      setModal({ mode:"info", title:"接回完成", body:`已接回 BTC +${btcGained.toFixed(6)} 顆。` });
    }else{
      setState(prev => ({ ...prev, pendingOrders: updated }));
      setModal({ mode:"info", title:"未達標", body:"目前沒有掛單達到接回價位。" });
    }
  };  const HeaderCards = () => (
    React.createElement("div", { className:"space-y-4" },
      React.createElement("div", { className:"grid grid-cols-2 gap-3" },
        React.createElement("div", { className:"bg-slate-800 rounded-2xl p-4 border border-slate-700" },
          React.createElement("div", { className:"text-xs text-slate-400" }, "熱錢包 (BTC)"),
          React.createElement("div", { className:"text-2xl mono font-bold mt-1" }, fmt(state.btcHot,4)),
          React.createElement("button", { onClick: moveCold, className:"mt-3 w-full bg-slate-700 hover:bg-slate-600 rounded-xl py-2 text-sm font-bold" }, "提領到冷錢包")
        ),
        React.createElement("div", { className:"bg-slate-800 rounded-2xl p-4 border border-slate-700" },
          React.createElement("div", { className:"text-xs text-slate-400" }, "冷錢包 (BTC)"),
          React.createElement("div", { className:"text-2xl mono font-bold mt-1" }, fmt(state.btcCold,4))
        )
      ),

      React.createElement("div", { className:"bg-slate-800 rounded-2xl p-4 border border-slate-700 space-y-3" },
        React.createElement("div", { className:"flex items-start justify-between gap-2" },
          React.createElement("div", null,
            React.createElement("div", { className:"text-xs text-slate-400" }, "預備金 (USDT)"),
            React.createElement("div", { className:"text-2xl mono font-bold mt-1" }, "$" + Math.floor(state.usdtReserve||0).toLocaleString())
          ),
          React.createElement("div", { className:"flex gap-2 flex-wrap justify-end" },
            React.createElement("button", { onClick: exportBackup, className:"text-xs px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 font-bold" }, "匯出"),
            React.createElement("button", { onClick: ()=> setModal({ mode:"import", title:"匯入備份" }), className:"text-xs px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 font-bold" }, "匯入"),
            React.createElement("button", { onClick: resetAll, className:"text-xs px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 font-bold" }, "重置")
          )
        ),
        React.createElement("div", { className:"grid grid-cols-3 gap-2 items-end" },
          React.createElement("div", { className:"col-span-2" },
            React.createElement("div", { className:"text-xs text-slate-400 mb-1" }, "手動補充預備金"),
            React.createElement("input", {
              defaultValue: draftRef.current.extraReserveAdd,
              inputMode:"numeric",
              className:"w-full bg-slate-900 border border-slate-700 rounded-2xl px-4 py-3 text-lg mono focus:outline-none focus:ring-2 focus:ring-emerald-500",
              onInput: (e)=>{ draftRef.current.extraReserveAdd = e.target.value; }
            })
          ),
          React.createElement("button", { onClick: addExtraReserve, className:"h-[52px] bg-emerald-600 hover:bg-emerald-700 rounded-2xl font-black" }, "加入")
        )
      )
    )
  );

  const HomePage = () => (
    React.createElement("div", { className:"bg-slate-800 rounded-2xl p-5 border border-slate-700 space-y-4" },
      React.createElement("div", { className:"flex items-center justify-between" },
        React.createElement("div", { className:"text-lg font-extrabold text-emerald-400" }, "自動抓取 / 手動更新"),
        React.createElement("div", { className:"text-xs text-slate-400 mono" }, `剩餘 ${daysLeft} 天`)
      ),

      React.createElement("button", { onClick: autofillFromApis, className:"w-full bg-slate-700 hover:bg-slate-600 rounded-2xl py-3 font-bold" },
        "重新自動抓取（含多重備援）"),

      React.createElement(Field, { label:"BTC 價格", name:"btcPrice", id:"btcPrice", inputMode:"numeric" }),
      React.createElement(Field, { label:"恐懼貪婪(0-100)", name:"fngIndex", id:"fngIndex", inputMode:"numeric" }),
      React.createElement(Field, { label:"ETH/BTC", name:"ethBtcRatio", id:"ethBtcRatio", inputMode:"decimal" }),
      React.createElement(Field, { label:"ADA/BTC", name:"adaBtcRatio", id:"adaBtcRatio", inputMode:"decimal" }),
      React.createElement(Field, { label:"近6個月 ATH 回撤(%)", name:"athDrawdownPct", id:"athDrawdownPct", inputMode:"decimal" }),

      React.createElement("div", { className:"bg-slate-900 border border-slate-700 rounded-2xl p-4 space-y-2" },
        React.createElement("div", { className:"text-xs text-slate-400" }, "200W MA（抓不到可忽略）"),
        React.createElement("div", { className:"text-sm mono text-slate-200" },
          ui.ma200w > 0 ? `200W≈${Math.round(ui.ma200w)}｜跌破=${ui.below200w ? "ON" : "OFF"}` : "尚未取得（看 Logs）"
        )
      ),

      React.createElement(Toggle01, { label:"跌破 200W", name:"below200w" }),
      React.createElement(Field, { label:"黑天鵝反彈(%)", name:"reboundPct", id:"reboundPct", inputMode:"decimal" })
    )
  );

  const ToolsPage = () => (
    React.createElement("div", { className:"bg-slate-800 rounded-2xl p-5 border border-slate-700 space-y-2" },
      React.createElement("div", { className:"text-lg font-extrabold text-sky-300" }, "備份"),
      React.createElement("div", { className:"text-sm text-slate-300" }, "用匯出/匯入 JSON 可跨裝置同步。")
    )
  );

  /* ===== Main Render ===== */
  return React.createElement("div", { className:"min-h-screen pb-safe" },
    React.createElement("div", { className:"sticky top-0 z-10 bg-slate-950/90 backdrop-blur border-b border-slate-800 px-4 py-3" },
      React.createElement("div", { className:"flex items-center justify-between text-xs text-slate-400 mono mb-2" },
        React.createElement("span", null, `LV.${Math.floor(totalBtc*10)} 守護者`),
        React.createElement("span", null, `${fmt(totalBtc,4)} / ${GOAL_BTC} BTC`)
      ),
      React.createElement("div", { className:"w-full h-3 bg-slate-800 rounded-full overflow-hidden" },
        React.createElement("div", { className:"h-full bg-gradient-to-r from-emerald-600 to-green-400 transition-all", style:{ width: progress + "%" } })
      ),
      React.createElement("div", { className:"text-[10px] text-right text-slate-500 mt-1" },
        `穩定幣占比約 ${stablePct.toFixed(1)}%`
      )
    ),

    React.createElement("div", { className:"p-4 space-y-4 max-w-xl mx-auto pb-24" },
      React.createElement("div", { className:"flex gap-2 flex-wrap" },
        React.createElement(Chip, { active: tab==="home", onClick:()=>setTab("home") }, "HOME"),
        React.createElement(Chip, { active: tab==="tools", onClick:()=>setTab("tools") }, "備份")
      ),

      HeaderCards(),
      tab==="home" && HomePage(),
      tab==="tools" && ToolsPage(),

      React.createElement("div", { className:"bg-slate-950 rounded-2xl p-4 border border-slate-800" },
        React.createElement("div", { className:"text-xs text-slate-500 mono mb-2" }, "> SYSTEM LOGS"),
        (state.logs.length===0)
          ? React.createElement("div", { className:"text-slate-600 text-sm" }, "等待指令…")
          : state.logs.slice(0, 20).map(l =>
              React.createElement("div", { key:l.id, className:"text-sm mono border-b border-slate-900 py-2 last:border-0" },
                React.createElement("span", { className:"text-slate-500" }, `[${l.date}] `),
                React.createElement("span", null, l.msg)
              )
            )
      )
    ),

    modal && React.createElement("div", { className:"fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4" },
      React.createElement("div", { className:"w-full max-w-lg bg-slate-900 border border-slate-700 rounded-2xl p-5" },
        React.createElement("div", { className:"text-lg font-black mb-3" }, modal.title || "訊息"),
        (modal.mode==="export") && React.createElement("div", { className:"space-y-3" },
          React.createElement("textarea", { readOnly:true, value: modal.json || "", className:"w-full h-56 bg-black/40 border border-slate-700 rounded-xl p-3 text-xs mono text-slate-200" }),
          React.createElement("button", {
            className:"w-full bg-emerald-600 hover:bg-emerald-700 rounded-xl py-3 font-bold",
            onClick: async ()=> {
              const ok = await copyToClipboard(modal.json || "");
              setModal({ mode:"info", title:"已複製", body: ok ? "已複製到剪貼簿。" : "請手動複製。" });
            }
          }, "一鍵複製")
        ),
        (modal.mode==="import") && React.createElement("div", { className:"space-y-3" },
          React.createElement("textarea", { id:"importBox", placeholder:"貼上 JSON…", className:"w-full h-56 bg-black/40 border border-slate-700 rounded-xl p-3 text-xs mono text-slate-200" }),
          React.createElement("button", {
            className:"w-full bg-sky-600 hover:bg-sky-700 rounded-xl py-3 font-bold",
            onClick: ()=> {
              const el = document.getElementById("importBox");
              importBackup(el ? el.value : "");
            }
          }, "匯入並覆蓋")
        ),
        (modal.mode==="info" || !modal.mode) && React.createElement("pre", { className:"text-sm text-slate-200 whitespace-pre-wrap leading-relaxed mono" }, modal.body || ""),
        React.createElement("button", { onClick:()=>setModal(null), className:"mt-4 w-full bg-slate-700 hover:bg-slate-600 rounded-xl py-3 font-bold" }, "關閉")
      )
    )
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(React.createElement(App));
</script>
</body>
</html>
