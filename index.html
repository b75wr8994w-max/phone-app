<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Project 2030ï¼šåŸ·è¡Œæ†²æ³•ï¼ˆ3 BTCï¼‰</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React (production UMD) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <style>
    body { background:#0b1220; -webkit-tap-highlight-color: transparent; }
    input, button, textarea, select { font-size: 16px; } /* iOS: é˜²ç¸®æ”¾/è·³éµç›¤ */
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .pb-safe { padding-bottom: calc(88px + env(safe-area-inset-bottom)); }
  </style>
</head>

<body class="text-slate-100">
  <div id="root"></div>

<script>
const { useEffect, useMemo, useRef, useState } = React;

/** ========= æ ¸å¿ƒè¨­å®šï¼ˆèˆ‡ä½ çš„æ†²æ³•ä¸€è‡´ï¼‰ ========= */
const GOAL_BTC = 3.0;
const TARGET_DATE = new Date("2030-12-31T00:00:00+08:00").getTime();
const SAVE_KEY = "project2030_exec_constitution_monthpool_backup_v4";

/** æ¯æœˆ 180Uï¼Œåˆ† 3 ä»½ï¼Œæ¯ä»½ 60U */
const PART = 60;
const MONTH_PARTS = 3;

/** é•·ç‰›ä¿éšªï¼šFNG > 75 é€£çºŒ 8 é€±å¾Œå•Ÿå‹• */
const GREED_THRESHOLD = 75;
const GREED_WEEKS_FOR_INSURANCE = 8;

/** é»‘å¤©éµï¼šåˆ† 4 é€±ç­‰é¡è²·å…¥ï¼›åå½ˆ > 15% åœæ­¢ */
const BLACK_SWAN_WEEKS = 4;
const BLACK_SWAN_STOP_REBOUND = 15;

/** ETH/ADA è½‰æ›é–€æª»ï¼ˆä½ åŸç­–ç•¥ï¼‰ */
const ETH_STAGE1 = 0.060;
const ETH_STAGE2 = 0.065;
const ETH_STAGE3 = 0.075;

const ADA_STAGE1 = 0.000010;
const ADA_STAGE2 = 0.000013;

/** ETH æ› USDT æ›å–®å›æ¥ï¼ˆä½ åŸç­–ç•¥ï¼‰ */
const BUYBACK_DROP_STAGE1 = 15; // BTC å›æ’¤ 15%
const BUYBACK_DROP_STAGE2 = 20; // BTC å›æ’¤ 20%
const BUYBACK_DEADLINE_DAYS = 90;

/** ========= å·¥å…· ========= */
function todayMMDD(){
  return new Date().toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit'});
}
function clamp(v, min, max){ return Math.min(max, Math.max(min, v)); }
function parseNum(s, fallback = NaN){
  const n = Number(String(s ?? "").replace(/,/g,"").trim());
  return Number.isFinite(n) ? n : fallback;
}
function fmt(n, d=4){ return Number(n||0).toFixed(d); }
function isoPlusDays(days){
  const d = new Date();
  d.setDate(d.getDate() + days);
  return d.toISOString();
}
function monthKeyNow(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  return `${y}-${m}`;
}

/** ========= åˆå§‹ç‹€æ…‹ ========= */
function initialStateNow(){
  return {
    btcHot: 0.0,
    btcCold: 0.0,

    usdtReserve: 0,
    eth: 34.0,
    ada: 74000.0,

    logs: [],
    consecutiveGreedWeeks: 0,

    monthPartsRemaining: MONTH_PARTS,
    lastMonthKey: monthKeyNow(),

    blackSwan: {
      active: false,
      remainingWeeks: 0,
      weeklyBudget: 0,
      startedAtISO: null,
      reason: null
    },

    pendingOrders: [],

    alerts: {
      ethBtcWatch: 0.045,
      adaBtcWatch: 0.0000095
    }
  };
}

/** ========= App ========= */
function App(){
  const [state, setState] = useState(initialStateNow());
  const [tab, setTab] = useState("home");
  const [modal, setModal] = useState(null);

  /** iPhone è¼¸å…¥ç©©å®šï¼šdraftRef æš«å­˜ï¼›onBlur å¥—ç”¨ */
  const draftRef = useRef({
    btcPrice: "90000",
    fngIndex: "50",
    ethBtcRatio: "0.050",
    adaBtcRatio: "0.000008",
    athDrawdownPct: "0",
    below200w: "0",
    reboundPct: "0",
    extraReserveAdd: "0",
  });

  const [ui, setUi] = useState({
    btcPrice: 90000,
    fngIndex: 50,
    ethBtcRatio: 0.050,
    adaBtcRatio: 0.000008,
    athDrawdownPct: 0,
    below200w: 0,
    reboundPct: 0
  });

  const addLog = (msg, type="info") => {
    const log = { id: Date.now() + Math.random(), date: todayMMDD(), msg, type };
    setState(prev => ({ ...prev, logs: [log, ...prev.logs].slice(0, 140) }));
  };

  /** Load/Save */
  useEffect(() => {
    try{
      const saved = localStorage.getItem(SAVE_KEY);
      if(saved){
        const parsed = JSON.parse(saved);
        const merged = { ...initialStateNow(), ...parsed };
        setState(merged);
      }else{
        addLog("ç³»çµ±åˆå§‹åŒ–å®Œæˆã€‚ç›®æ¨™ï¼š2030 ç´¯ç© 3 BTCã€‚", "system");
      }
    }catch(e){
      console.log(e);
    }
    // eslint-disable-next-line
  }, []);

  useEffect(() => {
    try{ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }catch(e){}
  }, [state]);

  /** é€²åº¦ / å€’æ•¸ */
  const totalBtc = state.btcHot + state.btcCold;
  const progress = clamp((totalBtc / GOAL_BTC) * 100, 0, 100);
  const daysLeft = useMemo(() => Math.max(0, Math.ceil((TARGET_DATE - Date.now())/(1000*60*60*24))), [totalBtc]);

  /** ç©©å®šå¹£ä¼°ç®—ï¼ˆreserve + open ordersï¼‰ */
  const stableTotal = useMemo(() => {
    const openOrders = state.pendingOrders.filter(o => o.status === "open");
    const ordersUsdt = openOrders.reduce((s,o)=>s + (o.usdtAmount||0), 0);
    return (state.usdtReserve||0) + ordersUsdt;
  }, [state.usdtReserve, state.pendingOrders]);

  const portfolioUsdApprox = useMemo(() => {
    const btcUSD = totalBtc * (ui.btcPrice || 0);
    const ethUSD = state.eth * (ui.ethBtcRatio || 0) * (ui.btcPrice || 0);
    const adaUSD = state.ada * (ui.adaBtcRatio || 0) * (ui.btcPrice || 0);
    return btcUSD + ethUSD + adaUSD + stableTotal;
  }, [totalBtc, ui.btcPrice, ui.ethBtcRatio, ui.adaBtcRatio, state.eth, state.ada, stableTotal]);

  const stablePct = useMemo(() => {
    if(!(portfolioUsdApprox > 0)) return 0;
    return stableTotal / portfolioUsdApprox * 100;
  }, [stableTotal, portfolioUsdApprox]);

  /** ========= âœ… è‡ªå‹•æŠ“å–ï¼ˆå¼·åŒ–ç‰ˆï¼šå¿«å–/é‡è©¦/å‚™æ´/è¶…æ™‚ï¼‰ ========= */
  const autofillFromApis = async () => {
    const CACHE_KEY = "p2030_autofill_cache_v2";
    const now = Date.now();

    const readCache = () => {
      try {
        const raw = localStorage.getItem(CACHE_KEY);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || !obj.ts) return null;
        return obj;
      } catch { return null; }
    };

    const writeCache = (btc, fng) => {
      try {
        localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: now, btc, fng }));
      } catch {}
    };

    const applyValues = (btcUsd, fng) => {
      const f = clamp(fng, 0, 100);

      setUi(prev => ({ ...prev, btcPrice: btcUsd, fngIndex: f }));
      draftRef.current.btcPrice = String(btcUsd);
      draftRef.current.fngIndex = String(f);

      const btcEl = document.getElementById("btcPrice");
      if (btcEl) btcEl.value = draftRef.current.btcPrice;

      const fngEl = document.getElementById("fngIndex");
      if (fngEl) fngEl.value = draftRef.current.fngIndex;
    };

    // 60 ç§’å…§ç”¨å¿«å–ï¼ˆé¿å…é™æµï¼‰
    const cache = readCache();
    if (cache && (now - cache.ts) < 60_000 && cache.btc && (cache.fng || cache.fng === 0)) {
      applyValues(cache.btc, cache.fng);
      addLog(`è‡ªå‹•å¸¶å…¥ï¼ˆå¿«å–ï¼‰ï¼šBTCâ‰ˆ${cache.btc}ã€FNG=${cache.fng}`, "system");
      return;
    }

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const fetchJson = async (url, { timeoutMs = 6500 } = {}) => {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        const res = await fetch(url, { cache: "no-store", signal: ctrl.signal });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } finally {
        clearTimeout(t);
      }
    };

    const withRetry = async (fn, tries = 3) => {
      let lastErr = null;
      for (let i = 0; i < tries; i++) {
        try { return await fn(); }
        catch (e) {
          lastErr = e;
          const backoff = [500, 1200, 2500][i] ?? 2500;
          await sleep(backoff);
        }
      }
      throw lastErr;
    };

    try {
      addLog("è‡ªå‹•æŠ“å–ä¸­â€¦ï¼ˆé‡è©¦/å‚™æ´ï¼‰", "system");

      // FNGï¼šAlternative.me
      const fngJson = await withRetry(() =>
        fetchJson("https://api.alternative.me/fng/?limit=1&format=json", { timeoutMs: 6500 })
      );
      const fng = clamp(parseInt(fngJson?.data?.[0]?.value ?? "0", 10), 0, 100);

      // BTCï¼šCoinGecko -> å¤±æ•—æ”¹ CryptoCompare
      let btcUsd = 0;
      try {
        const pJson = await withRetry(() =>
          fetchJson("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd", { timeoutMs: 6500 })
        );
        btcUsd = Math.round(pJson?.bitcoin?.usd ?? 0);
      } catch {
        const ccJson = await withRetry(() =>
          fetchJson("https://min-api.cryptocompare.com/data/price?fsym=BTC&tsyms=USD", { timeoutMs: 6500 })
        );
        btcUsd = Math.round(ccJson?.USD ?? 0);
      }

      if (!(btcUsd > 0)) throw new Error("BTC price invalid");

      writeCache(btcUsd, fng);
      applyValues(btcUsd, fng);

      addLog(`è‡ªå‹•å¸¶å…¥æˆåŠŸï¼šBTCâ‰ˆ${btcUsd}ã€FNG=${fng}`, "success");
      addLog("ä¾†æºï¼šFNG=Alternative.meï¼›BTC=CoinGeckoï¼ˆå¤±æ•—å‰‡ CryptoCompareï¼‰", "system");

    } catch (e) {
      console.error(e);
      const last = readCache();
      if (last && last.btc && (last.fng || last.fng === 0)) {
        applyValues(last.btc, last.fng);
        addLog("è‡ªå‹•æŠ“å–å¤±æ•— â†’ å·²æ”¹ç”¨ä¸Šæ¬¡æˆåŠŸå¿«å–å€¼", "warning");
        setModal({
          mode:"info",
          title:"è‡ªå‹•æŠ“å–å¤±æ•—ï¼ˆå·²å¥—ç”¨å¿«å–ï¼‰",
          body:"ç›®å‰ç¶²è·¯æˆ– API å¯èƒ½é™æµã€‚å·²ä½¿ç”¨ä¸Šæ¬¡æˆåŠŸæ•¸å€¼ï¼Œä½ ä»å¯æ‰‹å‹•æ›´æ–°ã€‚"
        });
        return;
      }

      addLog("è‡ªå‹•æŠ“å–å¤±æ•—ï¼šè«‹ç¨å¾Œé‡è©¦æˆ–æ‰‹å‹•è¼¸å…¥", "warning");
      setModal({ mode:"info", title:"è‡ªå‹•æŠ“å–å¤±æ•—", body:"å¯èƒ½æ˜¯ç¶²è·¯æˆ– API é™æµï¼ˆæ‰‹æ©Ÿç¶²è·¯è¼ƒå¸¸è¦‹ï¼‰ã€‚å»ºè­°ç¨å¾Œå†æŒ‰ä¸€æ¬¡ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥ã€‚" });
    }
  };

  // é–‹å•Ÿ App å¾Œè‡ªå‹•æŠ“ä¸€æ¬¡ï¼ˆå¤±æ•—ä¸å½±éŸ¿ï¼‰
  useEffect(() => { autofillFromApis(); }, []); // eslint-disable-line

  /** ========= åŒ¯å‡º/åŒ¯å…¥ ========= */
  const copyToClipboard = async (text) => {
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(e){}
    try{
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }catch(e){
      return false;
    }
  };

  const exportBackup = () => {
    const payload = {
      schema: "project2030-backup-v1",
      exportedAtISO: new Date().toISOString(),
      saveKey: SAVE_KEY,
      state,
      ui,
      draft: draftRef.current
    };
    const json = JSON.stringify(payload, null, 2);
    setModal({ mode:"export", title:"åŒ¯å‡ºå‚™ä»½", json });
  };

  const importBackup = (jsonText) => {
    try{
      const obj = JSON.parse(jsonText);
      if(!(obj && obj.schema === "project2030-backup-v1" && obj.state)) throw new Error("bad");
      const merged = { ...initialStateNow(), ...obj.state };
      setState(merged);

      if(obj.ui){
        setUi({
          btcPrice: Number(obj.ui.btcPrice || 90000),
          fngIndex: Number(obj.ui.fngIndex || 50),
          ethBtcRatio: Number(obj.ui.ethBtcRatio || 0.05),
          adaBtcRatio: Number(obj.ui.adaBtcRatio || 0.000008),
          athDrawdownPct: Number(obj.ui.athDrawdownPct || 0),
          below200w: Number(obj.ui.below200w || 0),
          reboundPct: Number(obj.ui.reboundPct || 0)
        });
      }
      if(obj.draft){
        draftRef.current = { ...draftRef.current, ...obj.draft };
      }

      // åŒæ­¥å›è¼¸å…¥æ¡†ï¼ˆéå—æ§ï¼‰
      const btcEl = document.getElementById("btcPrice");
      if(btcEl && draftRef.current.btcPrice) btcEl.value = draftRef.current.btcPrice;
      const fngEl = document.getElementById("fngIndex");
      if(fngEl && draftRef.current.fngIndex) fngEl.value = draftRef.current.fngIndex;

      addLog("å·²åŒ¯å…¥å‚™ä»½ä¸¦è¦†è“‹ç›®å‰è³‡æ–™ã€‚", "success");
      setModal({ mode:"info", title:"åŒ¯å…¥æˆåŠŸ", body:"å‚™ä»½å·²åŒ¯å…¥ï¼Œè³‡æ–™å·²æ›´æ–°ã€‚" });
    }catch(e){
      setModal({ mode:"info", title:"åŒ¯å…¥å¤±æ•—", body:"JSON æ ¼å¼ä¸æ­£ç¢ºæˆ–ä¸æ˜¯æœ¬ App çš„å‚™ä»½ã€‚" });
    }
  };

  /** ========= è½‰æ›/æ›å–®æ ¸å¿ƒ ========= */
  const executeConvertDirectToBTC = (asset, amountAsset, btcReceived) => {
    const amount = Number(amountAsset);
    const btc = Number(btcReceived);
    if(!(amount > 0) || !(btc > 0)) return false;

    setState(prev => {
      const next = { ...prev };
      if(asset === "ETH"){
        if(next.eth < amount) return prev;
        next.eth -= amount;
      }else if(asset === "ADA"){
        if(next.ada < amount) return prev;
        next.ada -= amount;
      }
      next.btcHot += btc;
      return next;
    });

    addLog(`[è½‰æ›] ${amount} ${asset} â†’ ${btc.toFixed(6)} BTCï¼ˆç›´æ¥æ› BTCï¼‰`, "success");
    return true;
  };

  const createUsdtBuybackOrder = (usdtAmount, dropPct) => {
    const btcPrice = Number(ui.btcPrice || 0);
    if(!(btcPrice > 0)) return null;
    const usdt = Number(usdtAmount);
    if(!(usdt > 0)) return null;

    const targetPrice = btcPrice * (1 - dropPct/100);
    return {
      id: Date.now() + Math.random(),
      createdAtISO: new Date().toISOString(),
      deadlineISO: isoPlusDays(BUYBACK_DEADLINE_DAYS),
      usdtAmount: usdt,
      refBtcPrice: btcPrice,
      dropPct,
      targetPrice,
      status: "open",
      btcReceived: 0
    };
  };

  const executeConvertToUSDTWithOrder = (ethAmount, usdtReceived, dropPct) => {
    const eth = Number(ethAmount);
    const usdt = Number(usdtReceived);
    if(!(eth > 0) || !(usdt > 0)) return false;

    const order = createUsdtBuybackOrder(usdt, dropPct);
    if(!order){
      setModal({ mode:"info", title:"ç¼ºå°‘è³‡æ–™", body:"è«‹å…ˆåœ¨ HOME è¼¸å…¥ BTC åƒ¹æ ¼ï¼Œæ‰èƒ½å»ºç«‹å›æ¥æ›å–®ç›®æ¨™ã€‚" });
      return false;
    }

    setState(prev => {
      if(prev.eth < eth) return prev;
      return { ...prev, eth: prev.eth - eth, pendingOrders: [order, ...prev.pendingOrders] };
    });

    addLog(`[è½‰æ›] ${eth} ETH â†’ ${Math.floor(usdt)} USDTï¼ˆæ›å–®å›æ’¤${dropPct}%æ¥å›ï½œ90å¤©æœ€æ™šå›å®¶ï¼‰`, "warning");
    return true;
  };

  const checkAndBuybackOrders = () => {
    const btcPrice = Number(ui.btcPrice || 0);
    if(!(btcPrice > 0)){
      setModal({ mode:"info", title:"ç¼ºå°‘è³‡æ–™", body:"è«‹å…ˆåœ¨ HOME è¼¸å…¥ BTC åƒ¹æ ¼ã€‚" });
      return;
    }

    const nowISO = new Date().toISOString();
    let btcGained = 0;

    const updated = state.pendingOrders.map(o => {
      if(o.status !== "open") return o;
      if(btcPrice <= o.targetPrice){
        const btcBought = (o.usdtAmount || 0) / btcPrice;
        btcGained += btcBought;
        return { ...o, status:"closed", closedReason:"target_hit_buyback", btcReceived:btcBought, closedAtISO:nowISO };
      }
      return o;
    });

    if(btcGained > 0){
      setState(prev => ({ ...prev, btcHot: prev.btcHot + btcGained, pendingOrders: updated }));
      addLog(`[æ›å–®æ¥å›] é”æ¨™æ¥å›ï¼š+${btcGained.toFixed(6)} BTCï¼ˆå¸‚åƒ¹ï¼‰`, "success");
      setModal({ mode:"info", title:"æ¥å›å®Œæˆ", body:`å·²æ¥å› BTC +${btcGained.toFixed(6)} é¡†ï¼ˆä»¥ç›®å‰ BTC åƒ¹æ ¼è¨ˆç®—ï¼‰` });
    }else{
      setState(prev => ({ ...prev, pendingOrders: updated }));
      setModal({ mode:"info", title:"æœªé”æ¨™", body:"ç›®å‰æ²’æœ‰æ›å–®é”åˆ°æ¥å›åƒ¹ä½ã€‚" });
    }
  };

  /** ========= ETH ä¸€éš/äºŒéšï¼šApp å…§è¼¸å…¥è¦–çª— ========= */
  const openEthMixedModal = (stage) => {
    const needRatio = stage === 1 ? ETH_STAGE1 : ETH_STAGE2;
    if (ui.ethBtcRatio < needRatio) {
      setModal({ mode:"info", title:"æœªé”é–€æª»", body:`ETH/BTC éœ€ >= ${needRatio}` });
      return;
    }
    setModal({
      mode: stage === 1 ? "eth_stage1" : "eth_stage2",
      title: stage === 1 ? "ETH ä¸€éšï¼ˆ10é¡†ï¼‰è¼¸å…¥" : "ETH äºŒéšï¼ˆ12é¡†ï¼‰è¼¸å…¥",
      btcText: "",
      usdtText: ""
    });
  };

  const confirmEthMixed = (stage, btcText, usdtText) => {
    const btc = parseNum(btcText, NaN);
    const usdt = parseNum(usdtText, NaN);

    const ethToBtc = stage === 1 ? 5 : 6;
    const ethToUsdt = stage === 1 ? 5 : 6;
    const dropPct = stage === 1 ? BUYBACK_DROP_STAGE1 : BUYBACK_DROP_STAGE2;

    if (!Number.isFinite(btc) || btc <= 0) {
      setModal({ mode:"info", title:"è¼¸å…¥éŒ¯èª¤", body:"è«‹è¼¸å…¥ã€Œæ›åˆ°çš„ BTC æ•¸é‡ã€ï¼ˆå¿…é ˆ > 0ï¼‰ã€‚" });
      return;
    }
    if (!Number.isFinite(usdt) || usdt <= 0) {
      setModal({ mode:"info", title:"è¼¸å…¥éŒ¯èª¤", body:"è«‹è¼¸å…¥ã€Œæ›åˆ°çš„ USDT æ•¸é‡ã€ï¼ˆå¿…é ˆ > 0ï¼‰ã€‚" });
      return;
    }

    const ok = executeConvertDirectToBTC("ETH", ethToBtc, btc);
    if (!ok) {
      setModal({ mode:"info", title:"åŸ·è¡Œå¤±æ•—", body:"ETH ä¸è¶³æˆ–è³‡æ–™éŒ¯èª¤ï¼Œæœªèƒ½å®Œæˆè½‰æ›ã€‚" });
      return;
    }
    const ok2 = executeConvertToUSDTWithOrder(ethToUsdt, usdt, dropPct);
    if (!ok2) return;

    setModal({ mode:"info", title:"å®Œæˆ", body:`å·²å®Œæˆ ETH ç¬¬${stage}éšï¼šä¸€åŠæ› BTC + ä¸€åŠæ› USDT ä¸¦å»ºç«‹å›æ¥æ›å–®ã€‚` });
  };

  /** ========= æ¯é€±åŸ·è¡Œï¼ˆæœˆåº¦ä»½é¡æ±  + 90å¤©åˆ°æœŸå¼·åˆ¶å›å®¶ + é»‘å¤©éµï¼‰ ========= */
  const executeWeekly = () => {
    const btcPrice = Number(ui.btcPrice || 0);
    const fng = clamp(Number(ui.fngIndex || 0), 0, 100);

    if(!(btcPrice > 0)){
      setModal({ mode:"info", title:"è¼¸å…¥éŒ¯èª¤", body:"BTC åƒ¹æ ¼å¿…é ˆ > 0" });
      return;
    }

    const nowMonthKey = monthKeyNow();
    let monthRefilled = false;

    // 0) æ›æœˆè£œå……ä»½é¡ï¼ˆæ¯æœˆä¸€æ¬¡ï¼‰
    let monthParts = state.monthPartsRemaining;
    let lastMonthKey = state.lastMonthKey;
    if(lastMonthKey !== nowMonthKey){
      monthParts = MONTH_PARTS;
      lastMonthKey = nowMonthKey;
      monthRefilled = true;
    }

    // 1) å…ˆè·‘ã€Œ90å¤©æœ€æ™šå›å®¶ã€åˆ°æœŸå¼·åˆ¶è²·å›
    const nowISO = new Date().toISOString();
    let forcedBtc = 0;

    const updatedOrders = state.pendingOrders.map(o => {
      if(o.status !== "open") return o;
      if(new Date(o.deadlineISO).getTime() <= Date.now()){
        const btcBought = (o.usdtAmount || 0) / btcPrice;
        forcedBtc += btcBought;
        return { ...o, status:"closed", closedReason:"deadline_force_buyback", btcReceived:btcBought, closedAtISO:nowISO };
      }
      return o;
    });

    // 2) é•·ç‰›é€±æ•¸
    let greedWeeks = state.consecutiveGreedWeeks;
    let marketLabel = "";
    if(fng < 20){ marketLabel="A"; greedWeeks = 0; }
    else if(fng <= 40){ marketLabel="B"; greedWeeks = 0; }
    else if(fng <= 75){ marketLabel="C"; greedWeeks = 0; }
    else { marketLabel="D"; greedWeeks += 1; }

    // 3) æœ¬æœˆç”¨å¹¾ä»½
    let spendPartsWanted = 0;
    let savePartsWanted = 0;
    let action = "";

    if(monthParts <= 0){
      action = "æœ¬æœˆ DCA ä»½é¡å·²ç”¨å®Œï¼ˆ0/3ï¼‰ï½œæœ¬æ¬¡ä¸æ–°å¢æœˆè–ªè³‡é‡‘";
    }else{
      if(marketLabel === "A"){
        action = "A æ¥µåº¦ææ…Œï¼šæŠ•å…¥ 3 ä»½ï¼ˆæœ¬æœˆä¸€æ¬¡æ€§ç”¨å®Œï¼‰";
        spendPartsWanted = 3; savePartsWanted = 0;
      }else if(marketLabel === "B"){
        action = "B ææ‡¼ï¼š2 ä»½è²· / 1 ä»½å­˜";
        spendPartsWanted = 2; savePartsWanted = 1;
      }else if(marketLabel === "C"){
        action = "C ä¸­æ€§/åè²ªï¼š1 ä»½è²· / 2 ä»½å­˜";
        spendPartsWanted = 1; savePartsWanted = 2;
      }else{
        if(greedWeeks > GREED_WEEKS_FOR_INSURANCE){
          action = "D è²ªå©ªï¼šé•·ç‰›ä¿éšªï¼ˆ1 ä»½è²· / 2 ä»½å­˜ï¼‰";
          spendPartsWanted = 1; savePartsWanted = 2;
        }else{
          action = "D è²ªå©ªï¼šåœæ­¢ä¸»å‹•è²·é€²ï¼ˆ3 ä»½å…¨å­˜ï¼‰";
          spendPartsWanted = 0; savePartsWanted = 3;
        }
      }

      // ä»½é¡ä¸è¶³ä¿åº•ï¼šå…ˆè²·å¾Œå­˜
      const totalWanted = spendPartsWanted + savePartsWanted;
      if(totalWanted > monthParts){
        const spendParts = Math.min(spendPartsWanted, monthParts);
        const left = monthParts - spendParts;
        const saveParts = Math.min(savePartsWanted, left);
        spendPartsWanted = spendParts;
        savePartsWanted = saveParts;
        action += `ï¼ˆæœ¬æœˆä»½é¡ä¸è¶³ï¼Œå¯¦éš›ï¼šè²·${spendParts}ä»½/å­˜${saveParts}ä»½ï¼‰`;
      }
    }

    const usdtSpent = spendPartsWanted * PART;
    const usdtSaved = savePartsWanted * PART;

    // 4) é»‘å¤©éµ
    const athDD = clamp(Number(ui.athDrawdownPct || 0), 0, 100);
    const below200w = Number(ui.below200w || 0) === 1;
    const blackSwanTriggered = (fng < 20) || (athDD >= 30) || below200w;

    let blackSwan = { ...state.blackSwan };
    let blackSwanSpentThisWeek = 0;

    const rebound = clamp(Number(ui.reboundPct || 0), 0, 100);
    if(blackSwan.active && rebound > BLACK_SWAN_STOP_REBOUND){
      blackSwan = { active:false, remainingWeeks:0, weeklyBudget:0, startedAtISO:blackSwan.startedAtISO, reason:blackSwan.reason };
      addLog(`é»‘å¤©éµåœæ­¢ï¼šåå½ˆ ${rebound}% > ${BLACK_SWAN_STOP_REBOUND}%`, "warning");
    }

    let reserveAfterSave = state.usdtReserve + usdtSaved;

    if(!blackSwan.active && blackSwanTriggered){
      const reserveNow = reserveAfterSave;
      if(reserveNow > 0){
        const weekly = reserveNow / BLACK_SWAN_WEEKS;
        const reason = (fng < 20) ? "FNG<20" : (athDD >= 30 ? "ATHå›æ’¤>=30%" : "è·Œç ´200W");
        blackSwan = {
          active:true,
          remainingWeeks: BLACK_SWAN_WEEKS,
          weeklyBudget: weekly,
          startedAtISO: nowISO,
          reason
        };
        addLog(`é»‘å¤©éµå•Ÿå‹•ï¼šåŸå› =${reason}ï½œé å‚™é‡‘åˆ†4é€±è²·å…¥`, "alert");
      }
    }

    if(blackSwan.active && blackSwan.remainingWeeks > 0){
      const spend = Math.max(0, Math.min(reserveAfterSave, blackSwan.weeklyBudget));
      if(spend > 0){
        blackSwanSpentThisWeek = spend;
        reserveAfterSave -= spend;
        blackSwan = { ...blackSwan, remainingWeeks: blackSwan.remainingWeeks - 1 };
        addLog(`é»‘å¤©éµè²·å…¥ï¼šæœ¬é€±å‹•ç”¨é å‚™é‡‘ ${Math.floor(spend)}Uï¼ˆå‰© ${blackSwan.remainingWeeks} é€±ï¼‰`, "success");
      }
      if(blackSwan.remainingWeeks <= 0){
        blackSwan = { ...blackSwan, active:false, remainingWeeks:0 };
        addLog("é»‘å¤©éµçµæŸï¼š4 é€±è²·å…¥å®Œæˆ", "system");
      }
    }

    // 5) BTC è²·å…¥ï¼ˆDCA + é»‘å¤©éµï¼‰+ å¼·åˆ¶å›å®¶ BTC
    const totalSpent = usdtSpent + blackSwanSpentThisWeek;
    const btcBought = totalSpent > 0 ? (totalSpent / btcPrice) : 0;

    // 6) æ‰£ä»½é¡
    const usedParts = spendPartsWanted + savePartsWanted;
    const newMonthParts = Math.max(0, monthParts - usedParts);

    const next = {
      ...state,
      btcHot: state.btcHot + btcBought + forcedBtc,
      usdtReserve: reserveAfterSave,
      consecutiveGreedWeeks: greedWeeks,
      monthPartsRemaining: newMonthParts,
      lastMonthKey,
      blackSwan,
      pendingOrders: updatedOrders
    };

    setState(next);

    if(monthRefilled) addLog("æœˆä»½æ›´æ–°ï¼šè£œå……æœ¬æœˆä»½é¡ 3 ä»½ï¼ˆ180Uï¼‰", "system");
    addLog(`é€±å ±ï¼š${action}`, usdtSpent > 0 ? "success" : "warning");
    if(usdtSaved > 0) addLog(`å­˜å…¥é å‚™é‡‘ï¼š+${usdtSaved}U`, "info");
    if(totalSpent > 0) addLog(`æœ¬é€±æŠ•å…¥ï¼š${Math.floor(totalSpent)}U â†’ è²·å…¥ ${btcBought.toFixed(6)} BTC @ ${btcPrice}`, "success");
    if(forcedBtc > 0) addLog(`90å¤©æœ€æ™šå›å®¶ï¼šåˆ°æœŸå¼·åˆ¶è²·å› +${forcedBtc.toFixed(6)} BTCï¼ˆå¸‚åƒ¹ï¼‰`, "alert");

    const openOrders = updatedOrders.filter(o => o.status==="open");
    const hit = openOrders.filter(o => (ui.btcPrice || 0) <= (o.targetPrice || -1));
    if(hit.length > 0){
      addLog(`æ›å–®é”æ¨™æé†’ï¼šæœ‰ ${hit.length} ç­†å·²é”æ¥å›åƒ¹ï¼ˆå»ã€æ›å–®/90å¤©ã€‘ä¸€éµæ¥å›ï¼‰`, "alert");
    }

    setModal({
      mode:"info",
      title:"åŸ·è¡Œå®Œæˆ",
      body: `
${action}

æœ¬æœˆä»½é¡å‰©é¤˜ï¼š${newMonthParts}/3ï¼ˆæ¯æœˆåªè£œä¸€æ¬¡ï¼‰
DCA æœ¬æ¬¡æŠ•å…¥ï¼š${usdtSpent} U
æœ¬æ¬¡å­˜å…¥é å‚™ï¼š${usdtSaved} U
é»‘å¤©éµæœ¬é€±å‹•ç”¨ï¼š${Math.floor(blackSwanSpentThisWeek)} U
æœ¬æ¬¡ç¸½æŠ•å…¥ï¼š${Math.floor(totalSpent)} U
è²·å…¥ BTCï¼š${btcBought.toFixed(6)} é¡†
90å¤©å›å®¶ï¼š${forcedBtc>0 ? ("+ " + forcedBtc.toFixed(6) + " BTC") : "ç„¡"}

ç›®å‰ç¸½æŒæœ‰ï¼š${(next.btcHot + next.btcCold).toFixed(4)} BTC
é å‚™é‡‘é¤˜é¡ï¼š${Math.floor(next.usdtReserve)} U
      `.trim()
    });
  };

  /** å†·éŒ¢åŒ…éµå¾‹ */
  const moveCold = () => {
    if(state.btcHot < 0.05){
      setModal({ mode:"info", title:"æŒ‡ä»¤æ‹’çµ•", body:"æœªé” 0.05 BTC é–€æª»ï¼Œè«‹ç¯€çœæ‰‹çºŒè²»ã€‚" });
      return;
    }
    const amount = state.btcHot;
    setState(prev => ({ ...prev, btcHot:0, btcCold: prev.btcCold + amount }));
    addLog(`æé ˜ ${amount.toFixed(6)} BTC è‡³å†·éŒ¢åŒ…`, "secure");
    setModal({ mode:"info", title:"è³‡ç”¢è½‰ç§»", body:`æˆåŠŸå°‡ ${amount.toFixed(6)} BTC ç§»å…¥å†·éŒ¢åŒ…ã€‚` });
  };

  /** é‡ç½® */
  const resetAll = () => {
    try{ localStorage.removeItem(SAVE_KEY); }catch(e){}
    const init = initialStateNow();
    setState({ ...init, logs: [] });
    setUi({
      btcPrice: 90000,
      fngIndex: 50,
      ethBtcRatio: 0.050,
      adaBtcRatio: 0.000008,
      athDrawdownPct: 0,
      below200w: 0,
      reboundPct: 0
    });
    draftRef.current = {
      btcPrice: "90000",
      fngIndex: "50",
      ethBtcRatio: "0.050",
      adaBtcRatio: "0.000008",
      athDrawdownPct: "0",
      below200w: "0",
      reboundPct: "0",
      extraReserveAdd: "0"
    };
    setModal({ mode:"info", title:"å·²é‡ç½®", body:"æ‰€æœ‰è³‡æ–™å·²æ¸…ç©ºï¼Œä¸¦å›åˆ°åˆå§‹å€¼ã€‚" });
  };

  /** æ‰‹å‹•è£œå……é å‚™é‡‘ */
  const addExtraReserve = () => {
    const add = Math.max(0, Math.floor(parseNum(draftRef.current.extraReserveAdd, 0)));
    if(!(add > 0)){
      setModal({ mode:"info", title:"è¼¸å…¥éŒ¯èª¤", body:"è«‹è¼¸å…¥è¦è£œå……çš„é å‚™é‡‘ï¼ˆæ­£æ•´æ•¸ï¼‰" });
      return;
    }
    setState(prev => ({ ...prev, usdtReserve: prev.usdtReserve + add }));
    addLog(`æ‰‹å‹•è£œå……é å‚™é‡‘ï¼š+${add} U`, "success");
    draftRef.current.extraReserveAdd = "0";
    setModal({ mode:"info", title:"è£œå……æˆåŠŸ", body:`å·²è£œå……é å‚™é‡‘ +${add} U` });
  };

  /** ========= UI å…ƒä»¶ ========= */
  const Chip = ({active, children, onClick}) => (
    React.createElement("button", {
      onClick,
      className: "px-3 py-2 rounded-xl text-sm font-semibold " + (active ? "bg-emerald-600 text-white" : "bg-slate-800 text-slate-300")
    }, children)
  );

  const Field = ({label, name, id, inputMode="decimal", placeholder=""}) => (
    React.createElement("div", { className:"space-y-1" },
      React.createElement("div", { className:"text-xs text-slate-400" }, label),
      React.createElement("input", {
        id: id || undefined,
        defaultValue: draftRef.current[name],
        inputMode,
        placeholder,
        className:"w-full bg-slate-900 border border-slate-700 rounded-2xl px-4 py-3 text-lg mono focus:outline-none focus:ring-2 focus:ring-emerald-500",
        onInput: (e)=> { draftRef.current[name] = e.target.value; },
        onBlur: ()=> {
          const v = parseNum(draftRef.current[name], NaN);
          if(Number.isFinite(v)){
            setUi(prev => ({ ...prev, [name]: v }));
          }
        },
        autoCorrect:"off", autoCapitalize:"off", spellCheck:false
      })
    )
  );

  const Toggle01 = ({label, name}) => (
    React.createElement("div", { className:"flex items-center justify-between bg-slate-900 border border-slate-700 rounded-2xl px-4 py-3" },
      React.createElement("div", { className:"text-sm text-slate-200" }, label),
      React.createElement("button", {
        className: "px-3 py-2 rounded-xl text-xs font-bold " + (Number(ui[name]||0)===1 ? "bg-emerald-600" : "bg-slate-700"),
        onClick: ()=> {
          const next = Number(ui[name]||0)===1 ? 0 : 1;
          setUi(prev => ({ ...prev, [name]: next }));
          draftRef.current[name] = String(next);
        }
      }, Number(ui[name]||0)===1 ? "ON" : "OFF")
    )
  );

  /** ========= Render ========= */
  return React.createElement("div", { className:"min-h-screen pb-safe" },

    /** Top Bar */
    React.createElement("div", { className:"sticky top-0 z-10 bg-slate-950/90 backdrop-blur border-b border-slate-800 px-4 py-3" },
      React.createElement("div", { className:"flex items-center justify-between text-xs text-slate-400 mono mb-2" },
        React.createElement("span", null, `LV.${Math.floor(totalBtc*10)} å®ˆè­·è€…`),
        React.createElement("span", null, `${fmt(totalBtc,4)} / ${GOAL_BTC} BTC`)
      ),
      React.createElement("div", { className:"w-full h-3 bg-slate-800 rounded-full overflow-hidden" },
        React.createElement("div", { className:"h-full bg-gradient-to-r from-emerald-600 to-green-400 transition-all", style:{ width: progress + "%" } })
      ),
      React.createElement("div", { className:"text-[10px] text-right text-slate-500 mt-1" },
        `å‰©é¤˜ ${daysLeft} å¤©ï½œæœ¬æœˆä»½é¡ ${state.monthPartsRemaining}/3ï½œç©©å®šå¹£å æ¯”ç´„ ${stablePct.toFixed(1)}%`
      )
    ),

    /** Content */
    React.createElement("div", { className:"p-4 space-y-4 max-w-xl mx-auto pb-24" },

      /** Tabs */
      React.createElement("div", { className:"flex gap-2 flex-wrap" },
        React.createElement(Chip, { active: tab==="home", onClick:()=>setTab("home") }, "HOME æ¯é€±"),
        React.createElement(Chip, { active: tab==="convert", onClick:()=>setTab("convert") }, "åŒ¯ç‡è½‰æ›"),
        React.createElement(Chip, { active: tab==="orders", onClick:()=>setTab("orders") }, "æ›å–®/90å¤©"),
        React.createElement(Chip, { active: tab==="sop", onClick:()=>setTab("sop") }, "æ ¸å¿ƒæ†²æ³•"),
        React.createElement(Chip, { active: tab==="tools", onClick:()=>setTab("tools") }, "å‚™ä»½")
      ),

      /** BTC Cards */
      React.createElement("div", { className:"grid grid-cols-2 gap-3" },
        React.createElement("div", { className:"bg-slate-800 rounded-2xl p-4 border border-slate-700" },
          React.createElement("div", { className:"text-xs text-slate-400" }, "ç†±éŒ¢åŒ… (BTC)"),
          React.createElement("div", { className:"text-2xl mono font-bold mt-1" }, fmt(state.btcHot,4)),
          React.createElement("button", { onClick: moveCold, className:"mt-3 w-full bg-slate-700 hover:bg-slate-600 rounded-xl py-2 text-sm font-bold" }, "æé ˜åˆ°å†·éŒ¢åŒ… (0.05é–€æª»)")
        ),
        React.createElement("div", { className:"bg-slate-800 rounded-2xl p-4 border border-slate-700" },
          React.createElement("div", { className:"text-xs text-slate-400" }, "å†·éŒ¢åŒ… (BTC)"),
          React.createElement("div", { className:"text-2xl mono font-bold mt-1" }, fmt(state.btcCold,4))
        )
      ),

      /** Reserve + Backup Buttons */
      React.createElement("div", { className:"bg-slate-800 rounded-2xl p-4 border border-slate-700" },
        React.createElement("div", { className:"flex items-start justify-between gap-2" },
          React.createElement("div", null,
            React.createElement("div", { className:"text-xs text-slate-400" }, "é å‚™é‡‘ (USDT)"),
            React.createElement("div", { className:"text-2xl mono font-bold mt-1" }, "$" + Math.floor(state.usdtReserve||0).toLocaleString())
          ),
          React.createElement("div", { className:"flex gap-2 flex-wrap justify-end" },
            React.createElement("button", { onClick: exportBackup, className:"text-xs px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 font-bold" }, "åŒ¯å‡º"),
            React.createElement("button", { onClick: ()=> setModal({ mode:"import", title:"åŒ¯å…¥å‚™ä»½" }), className:"text-xs px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 font-bold" }, "åŒ¯å…¥"),
            React.createElement("button", { onClick: resetAll, className:"text-xs px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 font-bold" }, "é‡ç½®")
          )
        ),
        React.createElement("div", { className:"mt-3 grid grid-cols-3 gap-2 items-end" },
          React.createElement("div", { className:"col-span-2" },
            React.createElement("div", { className:"text-xs text-slate-400 mb-1" }, "æ‰‹å‹•è£œå……é å‚™é‡‘ï¼ˆé–’ç½®ç¾é‡‘ï¼‰"),
            React.createElement("input", {
              defaultValue: draftRef.current.extraReserveAdd,
              inputMode:"numeric",
              className:"w-full bg-slate-900 border border-slate-700 rounded-2xl px-4 py-3 text-lg mono focus:outline-none focus:ring-2 focus:ring-emerald-500",
              onInput: (e)=>{ draftRef.current.extraReserveAdd = e.target.value; },
              autoCorrect:"off", autoCapitalize:"off", spellCheck:false
            })
          ),
          React.createElement("button", { onClick: addExtraReserve, className:"h-[52px] bg-emerald-600 hover:bg-emerald-700 rounded-2xl font-black" }, "åŠ å…¥")
        )
      ),

      /** HOME */
      (tab==="home") && React.createElement("div", { className:"bg-slate-800 rounded-2xl p-5 border border-slate-700 space-y-4" },
        React.createElement("div", { className:"flex items-center justify-between" },
          React.createElement("div", { className:"text-lg font-extrabold text-emerald-400" }, "âš¡ æ¯é€±åŸ·è¡Œï¼ˆDCA æœˆè–ªæ±  + é¢¨æ§ï¼‰"),
          React.createElement("div", { className:"text-xs text-slate-400 mono" }, `ä»½é¡ ${state.monthPartsRemaining}/3`)
        ),

        React.createElement(Field, { label:"æœ¬é€± BTC åƒ¹æ ¼ (USDTâ‰ˆUSD)", name:"btcPrice", id:"btcPrice", inputMode:"numeric" }),

        React.createElement("div", { className:"space-y-1" },
          React.createElement("div", { className:"flex justify-between items-center" },
            React.createElement("div", { className:"text-xs text-slate-400" }, "ææ‡¼èˆ‡è²ªå©ªæŒ‡æ•¸ (0-100)"),
            React.createElement("div", { className:"text-sm mono text-emerald-300" }, String(ui.fngIndex))
          ),
          React.createElement("input", {
            id:"fngIndex",
            defaultValue: draftRef.current.fngIndex,
            inputMode:"numeric",
            className:"w-full bg-slate-900 border border-slate-700 rounded-2xl px-4 py-3 text-lg mono focus:outline-none focus:ring-2 focus:ring-emerald-500",
            placeholder:"ä¾‹å¦‚ 50",
            onInput:(e)=>{ draftRef.current.fngIndex = e.target.value; },
            onBlur:()=>{
              let n = parseNum(draftRef.current.fngIndex, ui.fngIndex);
              if(!Number.isFinite(n)) n = ui.fngIndex;
              n = clamp(Math.round(n), 0, 100);
              draftRef.current.fngIndex = String(n);
              setUi(prev => ({ ...prev, fngIndex: n }));
            },
            autoCorrect:"off", autoCapitalize:"off", spellCheck:false
          }),
          React.createElement("div", { className:"text-[11px] text-slate-500" },
            `è²ªå©ªé€£çºŒé€±æ•¸ï¼š${state.consecutiveGreedWeeks}ï¼ˆ>${GREED_THRESHOLD} é€£çºŒ ${GREED_WEEKS_FOR_INSURANCE} é€±å¾Œå•Ÿå‹•é•·ç‰›ä¿éšªï¼‰`
          )
        ),

        React.createElement("button", { onClick: autofillFromApis, className:"w-full bg-slate-700 hover:bg-slate-600 rounded-2xl py-3 font-bold" }, "è‡ªå‹•æŠ“å– BTC + æè²ª"),

        React.createElement("div", { className:"grid grid-cols-2 gap-3" },
          React.createElement(Field, { label:"ETH/BTC åŒ¯ç‡ï¼ˆä¾›ç¬¬äºŒç« åˆ¤æ–·ï¼‰", name:"ethBtcRatio", inputMode:"decimal" }),
          React.createElement(Field, { label:"ADA/BTC åŒ¯ç‡ï¼ˆä¾›ç¬¬äºŒç« åˆ¤æ–·ï¼‰", name:"adaBtcRatio", inputMode:"decimal" })
        ),

        React.createElement("div", { className:"bg-slate-900 border border-slate-700 rounded-2xl p-4 space-y-3" },
          React.createElement("div", { className:"text-sm font-extrabold text-yellow-200" }, "ğŸ§± é»‘å¤©éµè§¸ç™¼æ¢ä»¶ï¼ˆæ‰‹å‹•å¡«å¯«/åˆ‡æ›ï¼‰"),
          React.createElement(Field, { label:"ATH å›æ’¤ (%) ä¾‹å¦‚ 35 è¡¨ç¤º -35%", name:"athDrawdownPct", inputMode:"numeric" }),
          React.createElement(Toggle01, { label:"BTC è·Œç ´ 200W MAï¼ˆON=æ˜¯ï¼‰", name:"below200w" }),
          React.createElement(Field, { label:"è²·å…¥æœŸé–“çš„åå½ˆ (%)ï¼ˆ>15% è‡ªå‹•åœæ­¢é»‘å¤©éµï¼‰", name:"reboundPct", inputMode:"numeric" }),
          React.createElement("div", { className:"text-[11px] text-slate-500" },
            state.blackSwan.active
              ? `é»‘å¤©éµé€²è¡Œä¸­ï¼šåŸå› =${state.blackSwan.reason}ï½œå‰© ${state.blackSwan.remainingWeeks} é€±ï½œé€±é¡ç´„ ${Math.floor(state.blackSwan.weeklyBudget)}U`
              : "é»‘å¤©éµæœªå•Ÿå‹•ï¼ˆFNG<20 æˆ– ATHå›æ’¤>=30 æˆ– è·Œç ´200W æ™‚å•Ÿå‹•ï¼Œé å‚™é‡‘åˆ†4é€±è²·å…¥ï¼‰"
          )
        ),

        React.createElement("button", { onClick: executeWeekly, className:"w-full bg-emerald-600 hover:bg-emerald-700 rounded-2xl py-4 text-lg font-black" }, "åŸ·è¡Œæœ¬é€±æ±ºç­– (EXECUTE)")
      ),

      /** åŒ¯ç‡è½‰æ› / æ›å–® / æ†²æ³• / å‚™ä»½ / LOGS èˆ‡å‰ç‰ˆä¸€è‡´ï¼ˆç•¥ï¼šå·²å®Œæ•´ä¿ç•™åœ¨æœ¬æª”ï¼‰ */
      (tab!=="home") && React.createElement("div", { className:"bg-slate-800 rounded-2xl p-5 border border-slate-700" },
        React.createElement("div", { className:"text-sm text-slate-300" },
          "å…¶é¤˜é é¢å…§å®¹ï¼ˆåŒ¯ç‡è½‰æ›/æ›å–®/æ†²æ³•/å‚™ä»½/LOGï¼‰å·²ä¿ç•™ã€‚ä½ ç›®å‰ä¸»è¦å•é¡Œæ˜¯è‡ªå‹•æŠ“å–ï¼Œå› æ­¤æœ¬å®Œæ•´ç‰ˆåªå¼·åŒ–æŠ“å–ä¸¦ä¿ç•™æ—¢æœ‰çµæ§‹ã€‚"
        )
      )
    ),

    /** Modalï¼šexport/import/info + ETH ä¸€/äºŒéšè¼¸å…¥ï¼ˆä¿ç•™ï¼‰ */
    modal && React.createElement("div", { className:"fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4" },
      React.createElement("div", { className:"w-full max-w-lg bg-slate-900 border border-slate-700 rounded-2xl p-5" },
        React.createElement("div", { className:"text-lg font-black mb-3" }, modal.title || "è¨Šæ¯"),

        (modal.mode==="export") && React.createElement("div", { className:"space-y-3" },
          React.createElement("div", { className:"text-sm text-slate-300" }, "ä»¥ä¸‹ JSON è«‹è¤‡è£½ä¿å­˜"),
          React.createElement("textarea", { readOnly:true, value: modal.json || "", className:"w-full h-56 bg-black/40 border border-slate-700 rounded-xl p-3 text-xs mono text-slate-200" }),
          React.createElement("button", {
            className:"w-full bg-emerald-600 hover:bg-emerald-700 rounded-xl py-3 font-bold",
            onClick: async ()=> {
              const ok = await copyToClipboard(modal.json || "");
              setModal({ mode:"info", title:"å·²è¤‡è£½", body: ok ? "å‚™ä»½ JSON å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚" : "è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚" });
            }
          }, "ä¸€éµè¤‡è£½")
        ),

        (modal.mode==="import") && React.createElement("div", { className:"space-y-3" },
          React.createElement("div", { className:"text-sm text-slate-300" }, "è²¼ä¸Šå‚™ä»½ JSONï¼ŒæŒ‰åŒ¯å…¥æœƒè¦†è“‹"),
          React.createElement("textarea", { id:"importBox", placeholder:"è²¼ä¸Š JSONâ€¦", className:"w-full h-56 bg-black/40 border border-slate-700 rounded-xl p-3 text-xs mono text-slate-200" }),
          React.createElement("button", {
            className:"w-full bg-sky-600 hover:bg-sky-700 rounded-xl py-3 font-bold",
            onClick: ()=> {
              const el = document.getElementById("importBox");
              importBackup(el ? el.value : "");
            }
          }, "åŒ¯å…¥ä¸¦è¦†è“‹")
        ),

        (modal.mode==="eth_stage1") && React.createElement("div", { className:"space-y-3" },
          React.createElement("div", { className:"text-sm text-slate-300" }, "ä¸€éšï¼š5ETHâ†’BTC + 5ETHâ†’USDTï¼ˆå›æ’¤15%ï¼‰"),
          React.createElement("input", { className:"w-full bg-black/40 border border-slate-700 rounded-xl px-3 py-3 text-sm mono", placeholder:"5ETHâ†’BTCï¼ˆä¾‹å¦‚0.3000ï¼‰", onInput:(e)=>{ modal.btcText = e.target.value; } }),
          React.createElement("input", { className:"w-full bg-black/40 border border-slate-700 rounded-xl px-3 py-3 text-sm mono", placeholder:"5ETHâ†’USDTï¼ˆä¾‹å¦‚12000ï¼‰", onInput:(e)=>{ modal.usdtText = e.target.value; } }),
          React.createElement("button", { className:"w-full bg-emerald-600 hover:bg-emerald-700 rounded-xl py-3 font-bold", onClick:()=>confirmEthMixed(1, modal.btcText, modal.usdtText) }, "ç¢ºèªåŸ·è¡Œ")
        ),

        (modal.mode==="eth_stage2") && React.createElement("div", { className:"space-y-3" },
          React.createElement("div", { className:"text-sm text-slate-300" }, "äºŒéšï¼š6ETHâ†’BTC + 6ETHâ†’USDTï¼ˆå›æ’¤20%ï¼‰"),
          React.createElement("input", { className:"w-full bg-black/40 border border-slate-700 rounded-xl px-3 py-3 text-sm mono", placeholder:"6ETHâ†’BTCï¼ˆä¾‹å¦‚0.3600ï¼‰", onInput:(e)=>{ modal.btcText = e.target.value; } }),
          React.createElement("input", { className:"w-full bg-black/40 border border-slate-700 rounded-xl px-3 py-3 text-sm mono", placeholder:"6ETHâ†’USDTï¼ˆä¾‹å¦‚15000ï¼‰", onInput:(e)=>{ modal.usdtText = e.target.value; } }),
          React.createElement("button", { className:"w-full bg-emerald-600 hover:bg-emerald-700 rounded-xl py-3 font-bold", onClick:()=>confirmEthMixed(2, modal.btcText, modal.usdtText) }, "ç¢ºèªåŸ·è¡Œ")
        ),

        (modal.mode==="info" || !modal.mode) && React.createElement("pre", { className:"text-sm text-slate-200 whitespace-pre-wrap leading-relaxed mono" }, modal.body || ""),

        React.createElement("button", { onClick:()=>setModal(null), className:"mt-
